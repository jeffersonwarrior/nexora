{
  "file_path": "/work/external-deps/claude-mem/src/services/worker/http/routes/SearchRoutes.ts",
  "file_hash": "ca02d70f2769d38a23566ef02caad0cae2dc57b4",
  "updated_at": "2025-12-26T17:34:24.033143",
  "symbols": {
    "class_SearchRoutes_12": {
      "name": "SearchRoutes",
      "type": "class",
      "start_line": 12,
      "end_line": 354,
      "content_hash": "75bffb51901933a0c640a7bb75e3070e47b6364f",
      "content": "export class SearchRoutes extends BaseRouteHandler {\n  constructor(\n    private searchManager: SearchManager\n  ) {\n    super();\n  }\n\n  setupRoutes(app: express.Application): void {\n    // Unified endpoints (new consolidated API)\n    app.get('/api/search', this.handleUnifiedSearch.bind(this));\n    app.get('/api/timeline', this.handleUnifiedTimeline.bind(this));\n    app.get('/api/decisions', this.handleDecisions.bind(this));\n    app.get('/api/changes', this.handleChanges.bind(this));\n    app.get('/api/how-it-works', this.handleHowItWorks.bind(this));\n\n    // Backward compatibility endpoints\n    app.get('/api/search/observations', this.handleSearchObservations.bind(this));\n    app.get('/api/search/sessions', this.handleSearchSessions.bind(this));\n    app.get('/api/search/prompts', this.handleSearchPrompts.bind(this));\n    app.get('/api/search/by-concept', this.handleSearchByConcept.bind(this));\n    app.get('/api/search/by-file', this.handleSearchByFile.bind(this));\n    app.get('/api/search/by-type', this.handleSearchByType.bind(this));\n\n    // Context endpoints\n    app.get('/api/context/recent', this.handleGetRecentContext.bind(this));\n    app.get('/api/context/timeline', this.handleGetContextTimeline.bind(this));\n    app.get('/api/context/preview', this.handleContextPreview.bind(this));\n    app.get('/api/context/inject', this.handleContextInject.bind(this));\n\n    // Timeline and help endpoints\n    app.get('/api/timeline/by-query', this.handleGetTimelineByQuery.bind(this));\n    app.get('/api/search/help', this.handleSearchHelp.bind(this));\n  }\n\n  /**\n   * Unified search (observations + sessions + prompts)\n   * GET /api/search?query=...&type=observations&limit=20\n   */\n  private handleUnifiedSearch = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.search(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Unified timeline (anchor or query-based)\n   * GET /api/timeline?anchor=123 OR GET /api/timeline?query=...\n   */\n  private handleUnifiedTimeline = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.timeline(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Semantic shortcut for finding decision observations\n   * GET /api/decisions?limit=20\n   */\n  private handleDecisions = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.decisions(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Semantic shortcut for finding change-related observations\n   * GET /api/changes?limit=20\n   */\n  private handleChanges = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.changes(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Semantic shortcut for finding \"how it works\" explanations\n   * GET /api/how-it-works?limit=20\n   */\n  private handleHowItWorks = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.howItWorks(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search observations (use /api/search?type=observations instead)\n   * GET /api/search/observations?query=...&limit=20&project=...\n   */\n  private handleSearchObservations = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.searchObservations(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search session summaries\n   * GET /api/search/sessions?query=...&limit=20\n   */\n  private handleSearchSessions = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.searchSessions(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search user prompts\n   * GET /api/search/prompts?query=...&limit=20\n   */\n  private handleSearchPrompts = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.searchUserPrompts(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search observations by concept\n   * GET /api/search/by-concept?concept=discovery&limit=5\n   */\n  private handleSearchByConcept = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.findByConcept(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search by file path\n   * GET /api/search/by-file?filePath=...&limit=10\n   */\n  private handleSearchByFile = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.findByFile(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Search observations by type\n   * GET /api/search/by-type?type=bugfix&limit=10\n   */\n  private handleSearchByType = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.findByType(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Get recent context (summaries and observations for a project)\n   * GET /api/context/recent?project=...&limit=3\n   */\n  private handleGetRecentContext = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.getRecentContext(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Get context timeline around an anchor point\n   * GET /api/context/timeline?anchor=123&depth_before=10&depth_after=10&project=...\n   */\n  private handleGetContextTimeline = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.getContextTimeline(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Generate context preview for settings modal\n   * GET /api/context/preview?project=...\n   */\n  private handleContextPreview = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const projectName = req.query.project as string;\n\n    if (!projectName) {\n      this.badRequest(res, 'Project parameter is required');\n      return;\n    }\n\n    // Import context generator (runs in worker, has access to database)\n    const { generateContext } = await import('../../../context-generator.js');\n\n    // Use project name as CWD (generateContext uses path.basename to get project)\n    const cwd = `/preview/${projectName}`;\n\n    // Generate context with colors for terminal display\n    const contextText = await generateContext(\n      {\n        session_id: 'preview-' + Date.now(),\n        cwd: cwd\n      },\n      true  // useColors=true for ANSI terminal output\n    );\n\n    // Return as plain text\n    res.setHeader('Content-Type', 'text/plain; charset=utf-8');\n    res.send(contextText);\n  });\n\n  /**\n   * Context injection endpoint for hooks\n   * GET /api/context/inject?project=...&colors=true\n   *\n   * Returns pre-formatted context string ready for display.\n   * Use colors=true for ANSI-colored terminal output.\n   */\n  private handleContextInject = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const projectName = req.query.project as string;\n    const useColors = req.query.colors === 'true';\n\n    if (!projectName) {\n      this.badRequest(res, 'Project parameter is required');\n      return;\n    }\n\n    // Import context generator (runs in worker, has access to database)\n    const { generateContext } = await import('../../../context-generator.js');\n\n    // Use project name as CWD (generateContext uses path.basename to get project)\n    const cwd = `/context/${projectName}`;\n\n    // Generate context\n    const contextText = await generateContext(\n      {\n        session_id: 'context-inject-' + Date.now(),\n        cwd: cwd\n      },\n      useColors\n    );\n\n    // Return as plain text\n    res.setHeader('Content-Type', 'text/plain; charset=utf-8');\n    res.send(contextText);\n  });\n\n  /**\n   * Get timeline by query (search first, then get timeline around best match)\n   * GET /api/timeline/by-query?query=...&mode=auto&depth_before=10&depth_after=10\n   */\n  private handleGetTimelineByQuery = this.wrapHandler(async (req: Request, res: Response): Promise<void> => {\n    const result = await this.searchManager.getTimelineByQuery(req.query);\n    res.json(result);\n  });\n\n  /**\n   * Get search help documentation\n   * GET /api/search/help\n   */\n  private handleSearchHelp = this.wrapHandler((req: Request, res: Response): void => {\n    res.json({\n      title: 'Claude-Mem Search API',\n      description: 'HTTP API for searching persistent memory',\n      endpoints: [\n        {\n          path: '/api/search/observations',\n          method: 'GET',\n          description: 'Search observations using full-text search',\n          parameters: {\n            query: 'Search query (required)',\n            limit: 'Number of results (default: 20)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/search/sessions',\n          method: 'GET',\n          description: 'Search session summaries using full-text search',\n          parameters: {\n            query: 'Search query (required)',\n            limit: 'Number of results (default: 20)'\n          }\n        },\n        {\n          path: '/api/search/prompts',\n          method: 'GET',\n          description: 'Search user prompts using full-text search',\n          parameters: {\n            query: 'Search query (required)',\n            limit: 'Number of results (default: 20)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/search/by-concept',\n          method: 'GET',\n          description: 'Find observations by concept tag',\n          parameters: {\n            concept: 'Concept tag (required): discovery, decision, bugfix, feature, refactor',\n            limit: 'Number of results (default: 10)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/search/by-file',\n          method: 'GET',\n          description: 'Find observations and sessions by file path',\n          parameters: {\n            filePath: 'File path or partial path (required)',\n            limit: 'Number of results per type (default: 10)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/search/by-type',\n          method: 'GET',\n          description: 'Find observations by type',\n          parameters: {\n            type: 'Observation type (required): discovery, decision, bugfix, feature, refactor',\n            limit: 'Number of results (default: 10)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/context/recent',\n          method: 'GET',\n          description: 'Get recent session context including summaries and observations',\n          parameters: {\n            project: 'Project name (default: current directory)',\n            limit: 'Number of recent sessions (default: 3)'\n          }\n        },\n        {\n          path: '/api/context/timeline',\n          method: 'GET',\n          description: 'Get unified timeline around a specific point in time',\n          parameters: {\n            anchor: 'Anchor point: observation ID, session ID (e.g., \"S123\"), or ISO timestamp (required)',\n            depth_before: 'Number of records before anchor (default: 10)',\n            depth_after: 'Number of records after anchor (default: 10)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/timeline/by-query',\n          method: 'GET',\n          description: 'Search for best match, then get timeline around it',\n          parameters: {\n            query: 'Search query (required)',\n            mode: 'Search mode: \"auto\", \"observations\", or \"sessions\" (default: \"auto\")',\n            depth_before: 'Number of records before match (default: 10)',\n            depth_after: 'Number of records after match (default: 10)',\n            project: 'Filter by project name (optional)'\n          }\n        },\n        {\n          path: '/api/search/help',\n          method: 'GET',\n          description: 'Get this help documentation'\n        }\n      ],\n      examples: [\n        'curl \"http://localhost:37777/api/search/observations?query=authentication&limit=5\"',\n        'curl \"http://localhost:37777/api/search/by-type?type=bugfix&limit=10\"',\n        'curl \"http://localhost:37777/api/context/recent?project=claude-mem&limit=3\"',\n        'curl \"http://localhost:37777/api/context/timeline?anchor=123&depth_before=5&depth_after=5\"'\n      ]\n    });\n  });\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_constructor_13": {
      "name": "constructor",
      "type": "method",
      "start_line": 13,
      "end_line": 17,
      "content_hash": "d53c7279cf020b7e5bbaceee3c6de1c8c00e4f30",
      "content": "  constructor(\n    private searchManager: SearchManager\n  ) {\n    super();\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_setupRoutes_19": {
      "name": "setupRoutes",
      "type": "method",
      "start_line": 19,
      "end_line": 44,
      "content_hash": "ad9c594a73d5d9ef1570833955974944cd3a9e7c",
      "content": "  setupRoutes(app: express.Application): void {\n    // Unified endpoints (new consolidated API)\n    app.get('/api/search', this.handleUnifiedSearch.bind(this));\n    app.get('/api/timeline', this.handleUnifiedTimeline.bind(this));\n    app.get('/api/decisions', this.handleDecisions.bind(this));\n    app.get('/api/changes', this.handleChanges.bind(this));\n    app.get('/api/how-it-works', this.handleHowItWorks.bind(this));\n\n    // Backward compatibility endpoints\n    app.get('/api/search/observations', this.handleSearchObservations.bind(this));\n    app.get('/api/search/sessions', this.handleSearchSessions.bind(this));\n    app.get('/api/search/prompts', this.handleSearchPrompts.bind(this));\n    app.get('/api/search/by-concept', this.handleSearchByConcept.bind(this));\n    app.get('/api/search/by-file', this.handleSearchByFile.bind(this));\n    app.get('/api/search/by-type', this.handleSearchByType.bind(this));\n\n    // Context endpoints\n    app.get('/api/context/recent', this.handleGetRecentContext.bind(this));\n    app.get('/api/context/timeline', this.handleGetContextTimeline.bind(this));\n    app.get('/api/context/preview', this.handleContextPreview.bind(this));\n    app.get('/api/context/inject', this.handleContextInject.bind(this));\n\n    // Timeline and help endpoints\n    app.get('/api/timeline/by-query', this.handleGetTimelineByQuery.bind(this));\n    app.get('/api/search/help', this.handleSearchHelp.bind(this));\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}