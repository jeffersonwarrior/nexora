{
  "file_path": "/work/external-deps/claude-mem/src/services/worker/http/routes/ViewerRoutes.ts",
  "file_hash": "0abf04514fb14db48811498aee1c565a4e99895b",
  "updated_at": "2025-12-26T17:34:23.645037",
  "symbols": {
    "class_ViewerRoutes_17": {
      "name": "ViewerRoutes",
      "type": "class",
      "start_line": 17,
      "end_line": 95,
      "content_hash": "7227c1a75962af34b2b958313bc5fe87f715efed",
      "content": "export class ViewerRoutes extends BaseRouteHandler {\n  constructor(\n    private sseBroadcaster: SSEBroadcaster,\n    private dbManager: DatabaseManager,\n    private sessionManager: SessionManager\n  ) {\n    super();\n  }\n\n  setupRoutes(app: express.Application): void {\n    // Serve static UI assets (JS, CSS, fonts, etc.)\n    const packageRoot = getPackageRoot();\n    app.use(express.static(path.join(packageRoot, 'ui')));\n\n    app.get('/health', this.handleHealth.bind(this));\n    app.get('/', this.handleViewerUI.bind(this));\n    app.get('/stream', this.handleSSEStream.bind(this));\n  }\n\n  /**\n   * Health check endpoint\n   */\n  private handleHealth = this.wrapHandler((req: Request, res: Response): void => {\n    res.json({ status: 'ok', timestamp: Date.now() });\n  });\n\n  /**\n   * Serve viewer UI\n   */\n  private handleViewerUI = this.wrapHandler((req: Request, res: Response): void => {\n    const packageRoot = getPackageRoot();\n\n    // Try cache structure first (ui/viewer.html), then marketplace structure (plugin/ui/viewer.html)\n    const viewerPaths = [\n      path.join(packageRoot, 'ui', 'viewer.html'),\n      path.join(packageRoot, 'plugin', 'ui', 'viewer.html')\n    ];\n\n    const viewerPath = viewerPaths.find(p => existsSync(p));\n\n    if (!viewerPath) {\n      throw new Error('Viewer UI not found at any expected location');\n    }\n\n    const html = readFileSync(viewerPath, 'utf-8');\n    res.setHeader('Content-Type', 'text/html');\n    res.send(html);\n  });\n\n  /**\n   * SSE stream endpoint\n   */\n  private handleSSEStream = this.wrapHandler((req: Request, res: Response): void => {\n    // Setup SSE headers\n    res.setHeader('Content-Type', 'text/event-stream');\n    res.setHeader('Cache-Control', 'no-cache');\n    res.setHeader('Connection', 'keep-alive');\n\n    // Add client to broadcaster\n    this.sseBroadcaster.addClient(res);\n\n    // Send initial_load event with projects list\n    const allProjects = this.dbManager.getSessionStore().getAllProjects();\n    this.sseBroadcaster.broadcast({\n      type: 'initial_load',\n      projects: allProjects,\n      timestamp: Date.now()\n    });\n\n    // Send initial processing status (based on queue depth + active generators)\n    const isProcessing = this.sessionManager.isAnySessionProcessing();\n    const queueDepth = this.sessionManager.getTotalActiveWork(); // Includes queued + actively processing\n    this.sseBroadcaster.broadcast({\n      type: 'processing_status',\n      isProcessing,\n      queueDepth\n    });\n  });\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_constructor_18": {
      "name": "constructor",
      "type": "method",
      "start_line": 18,
      "end_line": 24,
      "content_hash": "3521c4cae6f6083fa94c96d665d22702005444b4",
      "content": "  constructor(\n    private sseBroadcaster: SSEBroadcaster,\n    private dbManager: DatabaseManager,\n    private sessionManager: SessionManager\n  ) {\n    super();\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_setupRoutes_26": {
      "name": "setupRoutes",
      "type": "method",
      "start_line": 26,
      "end_line": 34,
      "content_hash": "52d42b52598258b67d25dd27cf9eb0c62ef8ec90",
      "content": "  setupRoutes(app: express.Application): void {\n    // Serve static UI assets (JS, CSS, fonts, etc.)\n    const packageRoot = getPackageRoot();\n    app.use(express.static(path.join(packageRoot, 'ui')));\n\n    app.get('/health', this.handleHealth.bind(this));\n    app.get('/', this.handleViewerUI.bind(this));\n    app.get('/stream', this.handleSSEStream.bind(this));\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}