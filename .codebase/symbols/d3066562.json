{
  "file_path": "/work/context-engine/tests/test_server_helpers.py",
  "file_hash": "cc83cc5e20d76f2dbc17524ed491242ce435f545",
  "updated_at": "2025-12-26T17:34:25.043781",
  "symbols": {
    "function_test_tokens_from_queries_basic_8": {
      "name": "test_tokens_from_queries_basic",
      "type": "function",
      "start_line": 8,
      "end_line": 11,
      "content_hash": "acd4fd286fafab717859ac463339b8333d936ada",
      "content": "def test_tokens_from_queries_basic():\n    toks = srv._tokens_from_queries([\"FooBar baz42\", \"baz-42 foo\"])\n    # Lowercased, split on camel/snake/digits, dedup preserving order\n    assert toks[0] == \"foo\" and \"bar\" in toks and \"baz\" in toks and \"42\" in toks",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_highlight_snippet_simple_14": {
      "name": "test_highlight_snippet_simple",
      "type": "function",
      "start_line": 14,
      "end_line": 17,
      "content_hash": "9ea0d86f288e8a344cfd6c03c167bfaa9ed467cf",
      "content": "def test_highlight_snippet_simple():\n    s = \"hello foo bar\"\n    out = srv._highlight_snippet(s, [\"foo\", \"bar\"])\n    assert \"<<foo>>\" in out and \"<<bar>>\" in out",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fake_async_run_factory_20": {
      "name": "fake_async_run_factory",
      "type": "function",
      "start_line": 20,
      "end_line": 24,
      "content_hash": "7b7219d111ea53d44fe6a92bdbbbea2f6eb7cc22",
      "content": "def fake_async_run_factory(text):\n    async def _fake(cmd, **kwargs):  # accept env/timeout/cwd\n        return {\"ok\": True, \"code\": 0, \"stdout\": text, \"stderr\": \"\"}\n\n    return _fake",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__fake_21": {
      "name": "_fake",
      "type": "function",
      "start_line": 21,
      "end_line": 22,
      "content_hash": "eeae17b9184b3ab73885d9ee390ff39f224d06dc",
      "content": "    async def _fake(cmd, **kwargs):  # accept env/timeout/cwd\n        return {\"ok\": True, \"code\": 0, \"stdout\": text, \"stderr\": \"\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__call_repo_search_27": {
      "name": "_call_repo_search",
      "type": "function",
      "start_line": 27,
      "end_line": 28,
      "content_hash": "3757dbdc970034f2b618118cb48c24e3d31eba79",
      "content": "async def _call_repo_search(**kwargs):\n    return await srv.repo_search(**kwargs)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_repo_search_arg_normalization_31": {
      "name": "test_repo_search_arg_normalization",
      "type": "function",
      "start_line": 31,
      "end_line": 84,
      "content_hash": "c021a62a97bf1164747cd023e1d3b38366989a7c",
      "content": "def test_repo_search_arg_normalization(monkeypatch, tmp_path):\n    # Prepare a temp file to allow snippet read\n    p = tmp_path / \"a.py\"\n    p.write_text(\"def f():\\n    return 1\\n\")\n\n    # Fake hybrid_search JSONL output (1 item)\n    item = {\n        \"score\": 0.9,\n        \"path\": str(p),\n        \"symbol\": \"f\",\n        \"start_line\": 1,\n        \"end_line\": 2,\n        \"components\": {\"test\": 1.0},\n        \"why\": \"test\",\n    }\n    jsonl = json.dumps(item) + \"\\n\"\n\n    # Monkeypatch async runner\n    monkeypatch.setattr(srv, \"_run_async\", fake_async_run_factory(jsonl))\n    # Avoid model loading\n    monkeypatch.setattr(srv, \"_get_embedding_model\", lambda *a, **k: None)\n\n    # Ensure in-process branch stays off\n    monkeypatch.delenv(\"HYBRID_IN_PROCESS\", raising=False)\n\n    res = srv.asyncio.get_event_loop().run_until_complete(\n        _call_repo_search(\n            queries=[\"FooBar\"],\n            limit=\"12\",  # str on purpose to test coercion\n            per_path=None,\n            language=None,\n            under=None,\n            kind=None,\n            symbol=None,\n            ext=None,\n            not_=None,  # Fixed: was not_filter\n            case=None,\n            path_regex=None,\n            path_glob=None,\n            not_glob=None,\n            include_snippet=True,\n            compact=True,\n        )\n    )\n\n    assert res.get(\"ok\") is True\n    assert res.get(\"used_rerank\") in (False, None)\n    assert len(res.get(\"results\", [])) == 1\n    args = res.get(\"args\", {})\n    assert isinstance(args.get(\"limit\"), int) and args.get(\"limit\") == 12\n    assert isinstance(args.get(\"compact\"), bool) and args.get(\"compact\") is True\n    # snippet highlighting applied\n    if res[\"results\"][0].get(\"snippet\"):\n        assert \"<<\" in res[\"results\"][0][\"snippet\"]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}