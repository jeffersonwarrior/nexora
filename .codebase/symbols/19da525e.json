{
  "file_path": "/work/.local/tools/modelscan/providers/anthropic_test.go",
  "file_hash": "9d2fb285a44af11b01950097edc19b41de7a477d",
  "updated_at": "2025-12-26T17:34:22.579623",
  "symbols": {
    "function_TestAnthropicProvider_enrichModelDetails_11": {
      "name": "TestAnthropicProvider_enrichModelDetails",
      "type": "function",
      "start_line": 11,
      "end_line": 172,
      "content_hash": "fccbbbe1ad6a9a9d79b2cfe0c10a01a3af047c5a",
      "content": "func TestAnthropicProvider_enrichModelDetails(t *testing.T) {\n\tprovider := NewAnthropicProvider(\"test-key\")\n\tanthropicProvider := provider.(*AnthropicProvider)\n\n\ttests := []struct {\n\t\tname              string\n\t\tinputModel        Model\n\t\texpectedInCost    float64\n\t\texpectedOutCost   float64\n\t\texpectedContext   int\n\t\texpectedMaxTokens int\n\t\texpectedCategory  string\n\t}{\n\t\t{\n\t\t\tname: \"opus-4 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-opus-4-20250514\",\n\t\t\t\tName: \"Claude Opus 4\",\n\t\t\t},\n\t\t\texpectedInCost:    5.00,\n\t\t\texpectedOutCost:   25.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 64000,\n\t\t\texpectedCategory:  \"premium\",\n\t\t},\n\t\t{\n\t\t\tname: \"sonnet-4 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-sonnet-4-20250514\",\n\t\t\t\tName: \"Claude Sonnet 4\",\n\t\t\t},\n\t\t\texpectedInCost:    3.00,\n\t\t\texpectedOutCost:   15.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 64000,\n\t\t\texpectedCategory:  \"balanced\",\n\t\t},\n\t\t{\n\t\t\tname: \"haiku-4 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-haiku-4-20250514\",\n\t\t\t\tName: \"Claude Haiku 4\",\n\t\t\t},\n\t\t\texpectedInCost:    1.00,\n\t\t\texpectedOutCost:   5.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 64000,\n\t\t\texpectedCategory:  \"cost-effective\",\n\t\t},\n\t\t{\n\t\t\tname: \"opus-3.5 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-opus-3.5-20240229\",\n\t\t\t\tName: \"Claude Opus 3.5\",\n\t\t\t},\n\t\t\texpectedInCost:    15.00,\n\t\t\texpectedOutCost:   75.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 4096,\n\t\t\texpectedCategory:  \"legacy\",\n\t\t},\n\t\t{\n\t\t\tname: \"sonnet-3.5 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-sonnet-3.5-20240620\",\n\t\t\t\tName: \"Claude Sonnet 3.5\",\n\t\t\t},\n\t\t\texpectedInCost:    3.00,\n\t\t\texpectedOutCost:   15.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 8192,\n\t\t\texpectedCategory:  \"legacy\",\n\t\t},\n\t\t{\n\t\t\tname: \"haiku-3.5 model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-haiku-3.5-20240307\",\n\t\t\t\tName: \"Claude Haiku 3.5\",\n\t\t\t},\n\t\t\texpectedInCost:    0.80,\n\t\t\texpectedOutCost:   4.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 4096,\n\t\t\texpectedCategory:  \"legacy\",\n\t\t},\n\t\t{\n\t\t\tname: \"unknown claude model\",\n\t\t\tinputModel: Model{\n\t\t\t\tID:   \"claude-unknown-999\",\n\t\t\t\tName: \"Unknown Claude\",\n\t\t\t},\n\t\t\texpectedInCost:    3.00,\n\t\t\texpectedOutCost:   15.00,\n\t\t\texpectedContext:   200000,\n\t\t\texpectedMaxTokens: 4096,\n\t\t\texpectedCategory:  \"chat\",\n\t\t},\n\t}\n\n\tfor _, tt := range tests {\n\t\tt.Run(tt.name, func(t *testing.T) {\n\t\t\tresult := anthropicProvider.enrichModelDetails(tt.inputModel)\n\n\t\t\t// Check common capabilities\n\t\t\tif !result.SupportsImages {\n\t\t\t\tt.Error(\"Expected SupportsImages to be true\")\n\t\t\t}\n\t\t\tif !result.SupportsTools {\n\t\t\t\tt.Error(\"Expected SupportsTools to be true\")\n\t\t\t}\n\t\t\tif !result.CanStream {\n\t\t\t\tt.Error(\"Expected CanStream to be true\")\n\t\t\t}\n\t\t\tif !result.CanReason {\n\t\t\t\tt.Error(\"Expected CanReason to be true\")\n\t\t\t}\n\n\t\t\t// Check costs\n\t\t\tif result.CostPer1MIn != tt.expectedInCost {\n\t\t\t\tt.Errorf(\"Expected CostPer1MIn %f, got %f\", tt.expectedInCost, result.CostPer1MIn)\n\t\t\t}\n\t\t\tif result.CostPer1MOut != tt.expectedOutCost {\n\t\t\t\tt.Errorf(\"Expected CostPer1MOut %f, got %f\", tt.expectedOutCost, result.CostPer1MOut)\n\t\t\t}\n\n\t\t\t// Check context window\n\t\t\tif result.ContextWindow != tt.expectedContext {\n\t\t\t\tt.Errorf(\"Expected ContextWindow %d, got %d\", tt.expectedContext, result.ContextWindow)\n\t\t\t}\n\n\t\t\t// Check max tokens\n\t\t\tif result.MaxTokens != tt.expectedMaxTokens {\n\t\t\t\tt.Errorf(\"Expected MaxTokens %d, got %d\", tt.expectedMaxTokens, result.MaxTokens)\n\t\t\t}\n\n\t\t\t// Check categories\n\t\t\tfound := false\n\t\t\tfor _, cat := range result.Categories {\n\t\t\t\tif cat == tt.expectedCategory {\n\t\t\t\t\tfound = true\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t\tif !found {\n\t\t\t\tt.Errorf(\"Expected category %s not found in %v\", tt.expectedCategory, result.Categories)\n\t\t\t}\n\n\t\t\t// Check capabilities metadata\n\t\t\tif result.Capabilities == nil {\n\t\t\t\tt.Error(\"Expected Capabilities map to be set\")\n\t\t\t} else {\n\t\t\t\tif result.Capabilities[\"vision\"] != \"high\" {\n\t\t\t\t\tt.Error(\"Expected vision capability to be 'high'\")\n\t\t\t\t}\n\t\t\t\tif result.Capabilities[\"function_calling\"] != \"full\" {\n\t\t\t\t\tt.Error(\"Expected function_calling capability to be 'full'\")\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_ListModels_173": {
      "name": "TestAnthropicProvider_ListModels",
      "type": "function",
      "start_line": 173,
      "end_line": 232,
      "content_hash": "d44c0066d75dc25acc7e42b9d894ece76a335821",
      "content": "func TestAnthropicProvider_ListModels(t *testing.T) {\n\t// Create a mock HTTP server\n\tserver := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t// Verify request headers\n\t\tif r.Header.Get(\"x-api-key\") != \"test-key\" {\n\t\t\tw.WriteHeader(http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tif r.Header.Get(\"anthropic-version\") != \"2023-06-01\" {\n\t\t\tw.WriteHeader(http.StatusBadRequest)\n\t\t\treturn\n\t\t}\n\n\t\t// Return mock models response\n\t\tw.Header().Set(\"Content-Type\", \"application/json\")\n\t\tw.WriteHeader(http.StatusOK)\n\t\tw.Write([]byte(`{\n\t\t\t\"data\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"claude-3-opus-20240229\",\n\t\t\t\t\t\"created\": 1709251200,\n\t\t\t\t\t\"type\": \"model\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"claude-3-sonnet-20240229\",\n\t\t\t\t\t\"created\": 1709251200,\n\t\t\t\t\t\"type\": \"model\"\n\t\t\t\t}\n\t\t\t]\n\t\t}`))\n\t}))\n\tdefer server.Close()\n\n\t// Create provider with mock server URL\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: server.URL,\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\tctx := context.Background()\n\tmodels, err := provider.ListModels(ctx, false)\n\tif err != nil {\n\t\tt.Fatalf(\"ListModels failed: %v\", err)\n\t}\n\n\tif len(models) != 2 {\n\t\tt.Errorf(\"Expected 2 models, got %d\", len(models))\n\t}\n\n\t// Verify model details are enriched\n\tfor _, model := range models {\n\t\tif model.ID == \"claude-3-opus-20240229\" {\n\t\t\tif model.CostPer1MIn == 0 {\n\t\t\t\tt.Error(\"Expected enriched cost for opus model\")\n\t\t\t}\n\t\t}\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_ListModels_Error_233": {
      "name": "TestAnthropicProvider_ListModels_Error",
      "type": "function",
      "start_line": 233,
      "end_line": 253,
      "content_hash": "898f40b61d670de7b6a201971c600e5cb4787ea3",
      "content": "func TestAnthropicProvider_ListModels_Error(t *testing.T) {\n\t// Test with invalid API key\n\tserver := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tw.WriteHeader(http.StatusUnauthorized)\n\t\tw.Write([]byte(`{\"error\": {\"message\": \"invalid_api_key\"}}`))\n\t}))\n\tdefer server.Close()\n\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"invalid-key\",\n\t\tbaseURL: server.URL,\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\tctx := context.Background()\n\t_, err := provider.ListModels(ctx, false)\n\tif err == nil {\n\t\tt.Error(\"Expected error with invalid API key\")\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_ListModels_ContextCancelled_254": {
      "name": "TestAnthropicProvider_ListModels_ContextCancelled",
      "type": "function",
      "start_line": 254,
      "end_line": 271,
      "content_hash": "f1f4f21ebf6ecb8a4ebf1b85a05402d0df1a1d35",
      "content": "func TestAnthropicProvider_ListModels_ContextCancelled(t *testing.T) {\n\t// Create a provider with a long timeout\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: \"https://api.anthropic.com/v1\",\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\t// Create a context that's already cancelled\n\tctx, cancel := context.WithCancel(context.Background())\n\tcancel()\n\n\t_, err := provider.ListModels(ctx, false)\n\tif err == nil {\n\t\tt.Error(\"Expected error with cancelled context\")\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_TestModel_272": {
      "name": "TestAnthropicProvider_TestModel",
      "type": "function",
      "start_line": 272,
      "end_line": 312,
      "content_hash": "162035e30a164da00e14407083caf9410dcd3fc3",
      "content": "func TestAnthropicProvider_TestModel(t *testing.T) {\n\t// Create a mock HTTP server\n\tserver := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t// Verify request\n\t\tif r.Header.Get(\"x-api-key\") != \"test-key\" {\n\t\t\tw.WriteHeader(http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\n\t\t// Return successful response\n\t\tw.Header().Set(\"Content-Type\", \"application/json\")\n\t\tw.WriteHeader(http.StatusOK)\n\t\tw.Write([]byte(`{\n\t\t\t\"id\": \"msg_test\",\n\t\t\t\"type\": \"message\",\n\t\t\t\"role\": \"assistant\",\n\t\t\t\"content\": [{\"type\": \"text\", \"text\": \"test successful\"}],\n\t\t\t\"model\": \"claude-3-opus-20240229\"\n\t\t}`))\n\t}))\n\tdefer server.Close()\n\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: server.URL,\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\tctx := context.Background()\n\terr := provider.TestModel(ctx, \"claude-3-opus-20240229\", false)\n\tif err != nil {\n\t\tt.Errorf(\"TestModel failed: %v\", err)\n\t}\n\n\t// Test with verbose output\n\terr = provider.TestModel(ctx, \"claude-3-opus-20240229\", true)\n\tif err != nil {\n\t\tt.Errorf(\"TestModel with verbose failed: %v\", err)\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_TestModel_Error_313": {
      "name": "TestAnthropicProvider_TestModel_Error",
      "type": "function",
      "start_line": 313,
      "end_line": 333,
      "content_hash": "743d08cf9c835c2555f5f813c776bf7dcb26e0d3",
      "content": "func TestAnthropicProvider_TestModel_Error(t *testing.T) {\n\t// Test with error response\n\tserver := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tw.WriteHeader(http.StatusBadRequest)\n\t\tw.Write([]byte(`{\"error\": {\"message\": \"invalid_model\"}}`))\n\t}))\n\tdefer server.Close()\n\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: server.URL,\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\tctx := context.Background()\n\terr := provider.TestModel(ctx, \"invalid-model\", false)\n\tif err == nil {\n\t\tt.Error(\"Expected error with invalid model\")\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_TestModel_ContextCancelled_334": {
      "name": "TestAnthropicProvider_TestModel_ContextCancelled",
      "type": "function",
      "start_line": 334,
      "end_line": 350,
      "content_hash": "5f7f3512aec9870fd1bd0c8065c6c089ffacc91c",
      "content": "func TestAnthropicProvider_TestModel_ContextCancelled(t *testing.T) {\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: \"https://api.anthropic.com/v1\",\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\t// Create a context that's already cancelled\n\tctx, cancel := context.WithCancel(context.Background())\n\tcancel()\n\n\terr := provider.TestModel(ctx, \"claude-3-opus-20240229\", false)\n\tif err == nil {\n\t\tt.Error(\"Expected error with cancelled context\")\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAnthropicProvider_ValidateEndpoints_Verbose_351": {
      "name": "TestAnthropicProvider_ValidateEndpoints_Verbose",
      "type": "function",
      "start_line": 351,
      "end_line": 375,
      "content_hash": "b54695ba9c1ddf68420250d556172c45beedc57a",
      "content": "func TestAnthropicProvider_ValidateEndpoints_Verbose(t *testing.T) {\n\tserver := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tw.WriteHeader(http.StatusOK)\n\t\tw.Write([]byte(`{\n\t\t\t\"id\": \"msg_test\",\n\t\t\t\"type\": \"message\",\n\t\t\t\"role\": \"assistant\",\n\t\t\t\"content\": [{\"type\": \"text\", \"text\": \"test\"}]\n\t\t}`))\n\t}))\n\tdefer server.Close()\n\n\tprovider := &AnthropicProvider{\n\t\tapiKey:  \"test-key\",\n\t\tbaseURL: server.URL,\n\t\tclient:  &http.Client{Timeout: 10 * time.Second},\n\t}\n\n\tctx := context.Background()\n\t// Test verbose mode\n\terr := provider.ValidateEndpoints(ctx, true)\n\tif err != nil {\n\t\tt.Errorf(\"ValidateEndpoints verbose failed: %v\", err)\n\t}\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}