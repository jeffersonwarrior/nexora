{
  "file_path": "/work/context-engine/tests/test_hybrid_ranking.py",
  "file_hash": "054fad6fb2bd6b7e054b472af662e0c14c354575",
  "updated_at": "2025-12-26T17:34:24.531782",
  "symbols": {
    "function_ranking_module_21": {
      "name": "ranking_module",
      "type": "function",
      "start_line": 21,
      "end_line": 25,
      "content_hash": "a57e14f27ce07d76a846785c26f49ff9ece0d50b",
      "content": "def ranking_module():\n    \"\"\"Import hybrid ranking module.\"\"\"\n    import importlib\n    ranking = importlib.import_module(\"scripts.hybrid.ranking\")\n    return ranking",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestRRF_31": {
      "name": "TestRRF",
      "type": "class",
      "start_line": 31,
      "end_line": 57,
      "content_hash": "b5bee10f958848da48ba0985543f12ac91842395",
      "content": "class TestRRF:\n    \"\"\"Tests for RRF scoring function.\"\"\"\n\n    def test_rrf_rank_1(self, ranking_module):\n        \"\"\"Rank 1 has highest RRF score.\"\"\"\n        score = ranking_module.rrf(1)\n        assert score > 0\n        assert score == 1.0 / (ranking_module.RRF_K + 1)\n\n    def test_rrf_decreasing_with_rank(self, ranking_module):\n        \"\"\"RRF score decreases with higher rank.\"\"\"\n        score1 = ranking_module.rrf(1)\n        score2 = ranking_module.rrf(2)\n        score5 = ranking_module.rrf(5)\n        score10 = ranking_module.rrf(10)\n        \n        assert score1 > score2 > score5 > score10\n\n    def test_rrf_custom_k(self, ranking_module):\n        \"\"\"RRF with custom k parameter.\"\"\"\n        score = ranking_module.rrf(1, k=100)\n        assert score == 1.0 / (100 + 1)\n\n    def test_rrf_all_positive(self, ranking_module):\n        \"\"\"All RRF scores are positive.\"\"\"\n        for rank in [1, 10, 100, 1000]:\n            assert ranking_module.rrf(rank) > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_rrf_rank_1_34": {
      "name": "test_rrf_rank_1",
      "type": "method",
      "start_line": 34,
      "end_line": 38,
      "content_hash": "624dce86a3e546361d956dcae55e7ab7385cb130",
      "content": "    def test_rrf_rank_1(self, ranking_module):\n        \"\"\"Rank 1 has highest RRF score.\"\"\"\n        score = ranking_module.rrf(1)\n        assert score > 0\n        assert score == 1.0 / (ranking_module.RRF_K + 1)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_rrf_decreasing_with_rank_40": {
      "name": "test_rrf_decreasing_with_rank",
      "type": "method",
      "start_line": 40,
      "end_line": 47,
      "content_hash": "5beb7d29dc8d2c3e2b711acfb5041369ac518a6f",
      "content": "    def test_rrf_decreasing_with_rank(self, ranking_module):\n        \"\"\"RRF score decreases with higher rank.\"\"\"\n        score1 = ranking_module.rrf(1)\n        score2 = ranking_module.rrf(2)\n        score5 = ranking_module.rrf(5)\n        score10 = ranking_module.rrf(10)\n        \n        assert score1 > score2 > score5 > score10",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_rrf_custom_k_49": {
      "name": "test_rrf_custom_k",
      "type": "method",
      "start_line": 49,
      "end_line": 52,
      "content_hash": "cf22941ae72b71c289b09c20ad2951eb3262f65c",
      "content": "    def test_rrf_custom_k(self, ranking_module):\n        \"\"\"RRF with custom k parameter.\"\"\"\n        score = ranking_module.rrf(1, k=100)\n        assert score == 1.0 / (100 + 1)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_rrf_all_positive_54": {
      "name": "test_rrf_all_positive",
      "type": "method",
      "start_line": 54,
      "end_line": 57,
      "content_hash": "4e33df2f6bdf682a031aa7ba075c23029878df4e",
      "content": "    def test_rrf_all_positive(self, ranking_module):\n        \"\"\"All RRF scores are positive.\"\"\"\n        for rank in [1, 10, 100, 1000]:\n            assert ranking_module.rrf(rank) > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestSparseLexScore_63": {
      "name": "TestSparseLexScore",
      "type": "class",
      "start_line": 63,
      "end_line": 87,
      "content_hash": "a7eba1471f0742335c9823c0e24960e8e21ced62",
      "content": "class TestSparseLexScore:\n    \"\"\"Tests for sparse_lex_score function.\"\"\"\n\n    def test_zero_score(self, ranking_module):\n        \"\"\"Zero raw score produces non-negative output.\"\"\"\n        score = ranking_module.sparse_lex_score(0.0)\n        assert score >= 0\n\n    def test_positive_scores(self, ranking_module):\n        \"\"\"Positive raw scores produce positive outputs.\"\"\"\n        score = ranking_module.sparse_lex_score(5.0)\n        assert score > 0\n\n    def test_score_scaling(self, ranking_module):\n        \"\"\"Higher raw scores produce higher outputs.\"\"\"\n        score_low = ranking_module.sparse_lex_score(1.0)\n        score_high = ranking_module.sparse_lex_score(10.0)\n        assert score_high >= score_low\n\n    def test_weight_affects_score(self, ranking_module):\n        \"\"\"Weight parameter affects output.\"\"\"\n        score_low_weight = ranking_module.sparse_lex_score(5.0, weight=0.1)\n        score_high_weight = ranking_module.sparse_lex_score(5.0, weight=0.5)\n        # Higher weight should produce higher score\n        assert score_high_weight > score_low_weight",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_zero_score_66": {
      "name": "test_zero_score",
      "type": "method",
      "start_line": 66,
      "end_line": 69,
      "content_hash": "c44ef35ce121b4b766344b3ff2911f9ca4d41f1e",
      "content": "    def test_zero_score(self, ranking_module):\n        \"\"\"Zero raw score produces non-negative output.\"\"\"\n        score = ranking_module.sparse_lex_score(0.0)\n        assert score >= 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_positive_scores_71": {
      "name": "test_positive_scores",
      "type": "method",
      "start_line": 71,
      "end_line": 74,
      "content_hash": "19f69e58cf86bd49b62843f0bde9a4897101f1b8",
      "content": "    def test_positive_scores(self, ranking_module):\n        \"\"\"Positive raw scores produce positive outputs.\"\"\"\n        score = ranking_module.sparse_lex_score(5.0)\n        assert score > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_score_scaling_76": {
      "name": "test_score_scaling",
      "type": "method",
      "start_line": 76,
      "end_line": 80,
      "content_hash": "7b18e6d16052a71bf3b47d6f32edac230e79850f",
      "content": "    def test_score_scaling(self, ranking_module):\n        \"\"\"Higher raw scores produce higher outputs.\"\"\"\n        score_low = ranking_module.sparse_lex_score(1.0)\n        score_high = ranking_module.sparse_lex_score(10.0)\n        assert score_high >= score_low",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_weight_affects_score_82": {
      "name": "test_weight_affects_score",
      "type": "method",
      "start_line": 82,
      "end_line": 87,
      "content_hash": "3f70f3473c9a3b289c51d953a563dfc11680a1a9",
      "content": "    def test_weight_affects_score(self, ranking_module):\n        \"\"\"Weight parameter affects output.\"\"\"\n        score_low_weight = ranking_module.sparse_lex_score(5.0, weight=0.1)\n        score_high_weight = ranking_module.sparse_lex_score(5.0, weight=0.5)\n        # Higher weight should produce higher score\n        assert score_high_weight > score_low_weight",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestTokenization_93": {
      "name": "TestTokenization",
      "type": "class",
      "start_line": 93,
      "end_line": 133,
      "content_hash": "4bce10a0c45fe631f7b95fb5594873f5bd121123",
      "content": "class TestTokenization:\n    \"\"\"Tests for tokenization helpers.\"\"\"\n\n    def test_tokenize_queries_simple(self, ranking_module):\n        \"\"\"Tokenize simple phrases.\"\"\"\n        result = ranking_module.tokenize_queries([\"find function foo\"])\n        # Returns list of tokens\n        assert isinstance(result, (list, set))\n        result_set = set(result) if isinstance(result, list) else result\n        assert \"find\" in result_set\n        assert \"function\" in result_set\n        assert \"foo\" in result_set\n\n    def test_tokenize_splits_camelcase(self, ranking_module):\n        \"\"\"Tokenize splits camelCase identifiers.\"\"\"\n        result = ranking_module.tokenize_queries([\"getUserName\"])\n        result_set = set(result) if isinstance(result, list) else result\n        lower_result = {t.lower() for t in result_set}\n        assert \"get\" in lower_result or \"getusername\" in lower_result\n\n    def test_tokenize_splits_snake_case(self, ranking_module):\n        \"\"\"Tokenize splits snake_case identifiers.\"\"\"\n        result = ranking_module.tokenize_queries([\"get_user_name\"])\n        result_set = set(result) if isinstance(result, list) else result\n        lower_result = {t.lower() for t in result_set}\n        # Should split on underscores\n        assert \"get\" in lower_result or \"user\" in lower_result or \"name\" in lower_result\n\n    def test_tokenize_removes_stopwords(self, ranking_module):\n        \"\"\"Tokenize removes common stopwords.\"\"\"\n        result = ranking_module.tokenize_queries([\"the function of the class\"])\n        result_set = set(result) if isinstance(result, list) else result\n        # 'the' and 'of' are stopwords\n        assert \"the\" not in result_set\n        assert \"of\" not in result_set\n\n    def test_tokenize_empty_input(self, ranking_module):\n        \"\"\"Tokenize handles empty input.\"\"\"\n        result = ranking_module.tokenize_queries([])\n        assert isinstance(result, (list, set))\n        assert len(result) == 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_tokenize_queries_simple_96": {
      "name": "test_tokenize_queries_simple",
      "type": "method",
      "start_line": 96,
      "end_line": 104,
      "content_hash": "67e847c1c2c02900738573169908dfc81cfac218",
      "content": "    def test_tokenize_queries_simple(self, ranking_module):\n        \"\"\"Tokenize simple phrases.\"\"\"\n        result = ranking_module.tokenize_queries([\"find function foo\"])\n        # Returns list of tokens\n        assert isinstance(result, (list, set))\n        result_set = set(result) if isinstance(result, list) else result\n        assert \"find\" in result_set\n        assert \"function\" in result_set\n        assert \"foo\" in result_set",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_tokenize_splits_camelcase_106": {
      "name": "test_tokenize_splits_camelcase",
      "type": "method",
      "start_line": 106,
      "end_line": 111,
      "content_hash": "6a729df6976d99a2e3de820f999adf41befa93e1",
      "content": "    def test_tokenize_splits_camelcase(self, ranking_module):\n        \"\"\"Tokenize splits camelCase identifiers.\"\"\"\n        result = ranking_module.tokenize_queries([\"getUserName\"])\n        result_set = set(result) if isinstance(result, list) else result\n        lower_result = {t.lower() for t in result_set}\n        assert \"get\" in lower_result or \"getusername\" in lower_result",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_tokenize_splits_snake_case_113": {
      "name": "test_tokenize_splits_snake_case",
      "type": "method",
      "start_line": 113,
      "end_line": 119,
      "content_hash": "aafcf535cf6789dd7c37fdec70b9a9132168d9ee",
      "content": "    def test_tokenize_splits_snake_case(self, ranking_module):\n        \"\"\"Tokenize splits snake_case identifiers.\"\"\"\n        result = ranking_module.tokenize_queries([\"get_user_name\"])\n        result_set = set(result) if isinstance(result, list) else result\n        lower_result = {t.lower() for t in result_set}\n        # Should split on underscores\n        assert \"get\" in lower_result or \"user\" in lower_result or \"name\" in lower_result",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_tokenize_removes_stopwords_121": {
      "name": "test_tokenize_removes_stopwords",
      "type": "method",
      "start_line": 121,
      "end_line": 127,
      "content_hash": "f09b5a5209b8c24bd96a67d8f801a960dbedf319",
      "content": "    def test_tokenize_removes_stopwords(self, ranking_module):\n        \"\"\"Tokenize removes common stopwords.\"\"\"\n        result = ranking_module.tokenize_queries([\"the function of the class\"])\n        result_set = set(result) if isinstance(result, list) else result\n        # 'the' and 'of' are stopwords\n        assert \"the\" not in result_set\n        assert \"of\" not in result_set",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_tokenize_empty_input_129": {
      "name": "test_tokenize_empty_input",
      "type": "method",
      "start_line": 129,
      "end_line": 133,
      "content_hash": "7e4beb26add0e93e0f8cd86d4a16e89c3bebd3c3",
      "content": "    def test_tokenize_empty_input(self, ranking_module):\n        \"\"\"Tokenize handles empty input.\"\"\"\n        result = ranking_module.tokenize_queries([])\n        assert isinstance(result, (list, set))\n        assert len(result) == 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestLexicalScore_139": {
      "name": "TestLexicalScore",
      "type": "class",
      "start_line": 139,
      "end_line": 169,
      "content_hash": "49fa5bd2b9d72771fab6e925b7e9115eed939cfd",
      "content": "class TestLexicalScore:\n    \"\"\"Tests for lexical_score function.\"\"\"\n\n    def test_no_match_zero(self, ranking_module):\n        \"\"\"No matching tokens produces zero score.\"\"\"\n        score = ranking_module.lexical_score(\n            [\"foobar\"],\n            {\"text\": \"completely different content\", \"path\": \"unrelated.py\"}\n        )\n        # Score should be 0 or very low when no match\n        assert score >= 0\n\n    def test_exact_match_in_metadata(self, ranking_module):\n        \"\"\"Exact match in metadata produces positive score.\"\"\"\n        score = ranking_module.lexical_score(\n            [\"authentication\"],\n            {\"text\": \"def authenticate_user():\", \"path\": \"authentication.py\", \"symbol\": \"authenticate_user\"}\n        )\n        assert score > 0\n\n    def test_path_match_contributes(self, ranking_module):\n        \"\"\"Path matching contributes to score.\"\"\"\n        score_match = ranking_module.lexical_score(\n            [\"router\"],\n            {\"text\": \"some code\", \"path\": \"router/handler.py\"}\n        )\n        score_no_match = ranking_module.lexical_score(\n            [\"router\"],\n            {\"text\": \"some code\", \"path\": \"database/model.py\"}\n        )\n        assert score_match > score_no_match",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_no_match_zero_142": {
      "name": "test_no_match_zero",
      "type": "method",
      "start_line": 142,
      "end_line": 149,
      "content_hash": "ac36eddb3a8e5d0f0895b0486322880fb12623d3",
      "content": "    def test_no_match_zero(self, ranking_module):\n        \"\"\"No matching tokens produces zero score.\"\"\"\n        score = ranking_module.lexical_score(\n            [\"foobar\"],\n            {\"text\": \"completely different content\", \"path\": \"unrelated.py\"}\n        )\n        # Score should be 0 or very low when no match\n        assert score >= 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_exact_match_in_metadata_151": {
      "name": "test_exact_match_in_metadata",
      "type": "method",
      "start_line": 151,
      "end_line": 157,
      "content_hash": "16916397ed4838ddf9bff202fb238ee6f9040934",
      "content": "    def test_exact_match_in_metadata(self, ranking_module):\n        \"\"\"Exact match in metadata produces positive score.\"\"\"\n        score = ranking_module.lexical_score(\n            [\"authentication\"],\n            {\"text\": \"def authenticate_user():\", \"path\": \"authentication.py\", \"symbol\": \"authenticate_user\"}\n        )\n        assert score > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_path_match_contributes_159": {
      "name": "test_path_match_contributes",
      "type": "method",
      "start_line": 159,
      "end_line": 169,
      "content_hash": "546b2353fb6a32c419aec073a1fe20b63aa4688f",
      "content": "    def test_path_match_contributes(self, ranking_module):\n        \"\"\"Path matching contributes to score.\"\"\"\n        score_match = ranking_module.lexical_score(\n            [\"router\"],\n            {\"text\": \"some code\", \"path\": \"router/handler.py\"}\n        )\n        score_no_match = ranking_module.lexical_score(\n            [\"router\"],\n            {\"text\": \"some code\", \"path\": \"database/model.py\"}\n        )\n        assert score_match > score_no_match",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestSafeTypeCoercion_175": {
      "name": "TestSafeTypeCoercion",
      "type": "class",
      "start_line": 175,
      "end_line": 196,
      "content_hash": "66dd5104561b2703dfdc20030249543c324fbe72",
      "content": "class TestSafeTypeCoercion:\n    \"\"\"Tests for _safe_int and _safe_float utilities.\"\"\"\n\n    def test_safe_int_valid(self, ranking_module):\n        \"\"\"_safe_int converts valid values.\"\"\"\n        assert ranking_module._safe_int(\"42\", 0) == 42\n        assert ranking_module._safe_int(42, 0) == 42\n\n    def test_safe_int_invalid_uses_default(self, ranking_module):\n        \"\"\"_safe_int uses default for invalid values.\"\"\"\n        assert ranking_module._safe_int(\"not_a_number\", 99) == 99\n        assert ranking_module._safe_int(None, 99) == 99\n\n    def test_safe_float_valid(self, ranking_module):\n        \"\"\"_safe_float converts valid values.\"\"\"\n        assert ranking_module._safe_float(\"3.14\", 0.0) == 3.14\n        assert ranking_module._safe_float(3.14, 0.0) == 3.14\n\n    def test_safe_float_invalid_uses_default(self, ranking_module):\n        \"\"\"_safe_float uses default for invalid values.\"\"\"\n        assert ranking_module._safe_float(\"not_a_number\", 1.5) == 1.5\n        assert ranking_module._safe_float(None, 1.5) == 1.5",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_safe_int_valid_178": {
      "name": "test_safe_int_valid",
      "type": "method",
      "start_line": 178,
      "end_line": 181,
      "content_hash": "52f6b6e1332f898c24fc614f1d920ba42a752702",
      "content": "    def test_safe_int_valid(self, ranking_module):\n        \"\"\"_safe_int converts valid values.\"\"\"\n        assert ranking_module._safe_int(\"42\", 0) == 42\n        assert ranking_module._safe_int(42, 0) == 42",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_safe_int_invalid_uses_default_183": {
      "name": "test_safe_int_invalid_uses_default",
      "type": "method",
      "start_line": 183,
      "end_line": 186,
      "content_hash": "b82e6b6719adfb0bb9e2f199f4dc542326c345aa",
      "content": "    def test_safe_int_invalid_uses_default(self, ranking_module):\n        \"\"\"_safe_int uses default for invalid values.\"\"\"\n        assert ranking_module._safe_int(\"not_a_number\", 99) == 99\n        assert ranking_module._safe_int(None, 99) == 99",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_safe_float_valid_188": {
      "name": "test_safe_float_valid",
      "type": "method",
      "start_line": 188,
      "end_line": 191,
      "content_hash": "e62eba343cfad358f01c3eed88acafc632fff068",
      "content": "    def test_safe_float_valid(self, ranking_module):\n        \"\"\"_safe_float converts valid values.\"\"\"\n        assert ranking_module._safe_float(\"3.14\", 0.0) == 3.14\n        assert ranking_module._safe_float(3.14, 0.0) == 3.14",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_safe_float_invalid_uses_default_193": {
      "name": "test_safe_float_invalid_uses_default",
      "type": "method",
      "start_line": 193,
      "end_line": 196,
      "content_hash": "c0f6793b0c4eb66cfcc2507d655435ea374a69d5",
      "content": "    def test_safe_float_invalid_uses_default(self, ranking_module):\n        \"\"\"_safe_float uses default for invalid values.\"\"\"\n        assert ranking_module._safe_float(\"not_a_number\", 1.5) == 1.5\n        assert ranking_module._safe_float(None, 1.5) == 1.5",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestConstants_202": {
      "name": "TestConstants",
      "type": "class",
      "start_line": 202,
      "end_line": 213,
      "content_hash": "b3a5b47a43665433e95a66c75b2dcb9c9daaecb4",
      "content": "class TestConstants:\n    \"\"\"Tests for module constants.\"\"\"\n\n    def test_rrf_k_defined(self, ranking_module):\n        \"\"\"RRF_K constant is defined and positive.\"\"\"\n        assert hasattr(ranking_module, \"RRF_K\")\n        assert ranking_module.RRF_K > 0\n\n    def test_lex_vector_weight_defined(self, ranking_module):\n        \"\"\"LEX_VECTOR_WEIGHT constant is defined.\"\"\"\n        assert hasattr(ranking_module, \"LEX_VECTOR_WEIGHT\")\n        assert 0 <= ranking_module.LEX_VECTOR_WEIGHT <= 1",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_rrf_k_defined_205": {
      "name": "test_rrf_k_defined",
      "type": "method",
      "start_line": 205,
      "end_line": 208,
      "content_hash": "dbd4aa0bcce11dca8fa4f56a0a10ad905eb31b1a",
      "content": "    def test_rrf_k_defined(self, ranking_module):\n        \"\"\"RRF_K constant is defined and positive.\"\"\"\n        assert hasattr(ranking_module, \"RRF_K\")\n        assert ranking_module.RRF_K > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_lex_vector_weight_defined_210": {
      "name": "test_lex_vector_weight_defined",
      "type": "method",
      "start_line": 210,
      "end_line": 213,
      "content_hash": "8b214309b0f4b0d8c80b4a4d355af96cf6214d02",
      "content": "    def test_lex_vector_weight_defined(self, ranking_module):\n        \"\"\"LEX_VECTOR_WEIGHT constant is defined.\"\"\"\n        assert hasattr(ranking_module, \"LEX_VECTOR_WEIGHT\")\n        assert 0 <= ranking_module.LEX_VECTOR_WEIGHT <= 1",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}