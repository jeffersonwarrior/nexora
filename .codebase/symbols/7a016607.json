{
  "file_path": "/work/internal/session/session_test.go",
  "file_hash": "e4265b81f5c77c8d67d30be14a926bf6f04a535c",
  "updated_at": "2025-12-26T17:34:22.577763",
  "symbols": {
    "struct_MockQuerier_17": {
      "name": "MockQuerier",
      "type": "struct",
      "start_line": 17,
      "end_line": 21,
      "content_hash": "9042af01f8307e8659892a1719c10f21815edfe2",
      "content": "type MockQuerier struct {\n\tsessions map[string]db.Session\n\tcalls    []string\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewMockQuerier_22": {
      "name": "NewMockQuerier",
      "type": "function",
      "start_line": 22,
      "end_line": 28,
      "content_hash": "b8f85da21ff225049aba8478135b56f559479ff0",
      "content": "func NewMockQuerier() *MockQuerier {\n\treturn &MockQuerier{\n\t\tsessions: make(map[string]db.Session),\n\t\tcalls:    make([]string, 0),\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CreateSession_29": {
      "name": "CreateSession",
      "type": "method",
      "start_line": 29,
      "end_line": 45,
      "content_hash": "d7bba8b59af686644fec20fdcf0edec40fd342e7",
      "content": "func (m *MockQuerier) CreateSession(ctx context.Context, params db.CreateSessionParams) (db.Session, error) {\n\tm.calls = append(m.calls, \"CreateSession\")\n\tsession := db.Session{\n\t\tID:               params.ID,\n\t\tParentSessionID:  params.ParentSessionID,\n\t\tTitle:            params.Title,\n\t\tMessageCount:     0,\n\t\tPromptTokens:     0,\n\t\tCompletionTokens: 0,\n\t\tCost:             0,\n\t\tCreatedAt:        time.Now().Unix(),\n\t\tUpdatedAt:        time.Now().Unix(),\n\t}\n\tm.sessions[params.ID] = session\n\treturn session, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetSession_46": {
      "name": "GetSession",
      "type": "method",
      "start_line": 46,
      "end_line": 54,
      "content_hash": "b3a238c5e80f10a6d9c1ee2d0f277b23cb6c30dc",
      "content": "func (m *MockQuerier) GetSession(ctx context.Context, id string) (db.Session, error) {\n\tm.calls = append(m.calls, \"GetSession\")\n\tsession, exists := m.sessions[id]\n\tif !exists {\n\t\treturn db.Session{}, sql.ErrNoRows\n\t}\n\treturn session, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListSessions_55": {
      "name": "ListSessions",
      "type": "method",
      "start_line": 55,
      "end_line": 63,
      "content_hash": "7a57a7fbbc0404bd11c20551b0e63ca5c5be9244",
      "content": "func (m *MockQuerier) ListSessions(ctx context.Context) ([]db.Session, error) {\n\tm.calls = append(m.calls, \"ListSessions\")\n\tsessions := make([]db.Session, 0, len(m.sessions))\n\tfor _, s := range m.sessions {\n\t\tsessions = append(sessions, s)\n\t}\n\treturn sessions, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteSession_64": {
      "name": "DeleteSession",
      "type": "method",
      "start_line": 64,
      "end_line": 72,
      "content_hash": "82e8ce871570d299b04b7b95139fed0c8e5cc977",
      "content": "func (m *MockQuerier) DeleteSession(ctx context.Context, id string) error {\n\tm.calls = append(m.calls, \"DeleteSession\")\n\tif _, exists := m.sessions[id]; !exists {\n\t\treturn sql.ErrNoRows\n\t}\n\tdelete(m.sessions, id)\n\treturn nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_UpdateSession_73": {
      "name": "UpdateSession",
      "type": "method",
      "start_line": 73,
      "end_line": 92,
      "content_hash": "5a2e2fe59f0dddd40090a601fa3e084882abba58",
      "content": "func (m *MockQuerier) UpdateSession(ctx context.Context, params db.UpdateSessionParams) (db.Session, error) {\n\tm.calls = append(m.calls, \"UpdateSession\")\n\tsession, exists := m.sessions[params.ID]\n\tif !exists {\n\t\treturn db.Session{}, sql.ErrNoRows\n\t}\n\tif params.Title != \"\" {\n\t\tsession.Title = params.Title\n\t}\n\tsession.PromptTokens = params.PromptTokens\n\tsession.CompletionTokens = params.CompletionTokens\n\tsession.Cost = params.Cost\n\tif params.SummaryMessageID.Valid {\n\t\tsession.SummaryMessageID = params.SummaryMessageID\n\t}\n\tsession.UpdatedAt = time.Now().Unix()\n\tm.sessions[params.ID] = session\n\treturn session, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_UpdateMessage_93": {
      "name": "UpdateMessage",
      "type": "method",
      "start_line": 93,
      "end_line": 95,
      "content_hash": "137c2b22540b528a1b07b3ccc348fae7dc813342",
      "content": "func (m *MockQuerier) UpdateMessage(ctx context.Context, params db.UpdateMessageParams) error {\n\treturn nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CreateFile_96": {
      "name": "CreateFile",
      "type": "method",
      "start_line": 96,
      "end_line": 98,
      "content_hash": "b44a9f34ee06d750a7433d1de9798133e706d7db",
      "content": "func (m *MockQuerier) CreateFile(ctx context.Context, params db.CreateFileParams) (db.File, error) {\n\treturn db.File{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetFile_99": {
      "name": "GetFile",
      "type": "method",
      "start_line": 99,
      "end_line": 99,
      "content_hash": "a17005786b92777562ba2a6419cdf10c822cf943",
      "content": "func (m *MockQuerier) GetFile(ctx context.Context, id string) (db.File, error) { return db.File{}, nil }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteFile_100": {
      "name": "DeleteFile",
      "type": "method",
      "start_line": 100,
      "end_line": 100,
      "content_hash": "76f9ad7e6266b6680042d39cbef193593ac5dd5f",
      "content": "func (m *MockQuerier) DeleteFile(ctx context.Context, id string) error         { return nil }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetMessage_101": {
      "name": "GetMessage",
      "type": "method",
      "start_line": 101,
      "end_line": 103,
      "content_hash": "6cb5330524c5c4443c1800a8eb4383569cde3684",
      "content": "func (m *MockQuerier) GetMessage(ctx context.Context, id string) (db.Message, error) {\n\treturn db.Message{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteSessionFiles_104": {
      "name": "DeleteSessionFiles",
      "type": "method",
      "start_line": 104,
      "end_line": 104,
      "content_hash": "f330a9c760325c5f0b39893d632121277d16ad4d",
      "content": "func (m *MockQuerier) DeleteSessionFiles(ctx context.Context, sessionID string) error { return nil }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetFileByPathAndSession_105": {
      "name": "GetFileByPathAndSession",
      "type": "method",
      "start_line": 105,
      "end_line": 107,
      "content_hash": "ece5e36aa6a67a8b26a696acb22d55205148199b",
      "content": "func (m *MockQuerier) GetFileByPathAndSession(ctx context.Context, params db.GetFileByPathAndSessionParams) (db.File, error) {\n\treturn db.File{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListFilesByPath_108": {
      "name": "ListFilesByPath",
      "type": "method",
      "start_line": 108,
      "end_line": 110,
      "content_hash": "bb1993b425649a00c9de54fa589842481a435980",
      "content": "func (m *MockQuerier) ListFilesByPath(ctx context.Context, path string) ([]db.File, error) {\n\treturn []db.File{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListFilesBySession_111": {
      "name": "ListFilesBySession",
      "type": "method",
      "start_line": 111,
      "end_line": 113,
      "content_hash": "66c190751b266c76d6a4a2ca7d2e97802a394dda",
      "content": "func (m *MockQuerier) ListFilesBySession(ctx context.Context, sessionID string) ([]db.File, error) {\n\treturn []db.File{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListLatestSessionFiles_114": {
      "name": "ListLatestSessionFiles",
      "type": "method",
      "start_line": 114,
      "end_line": 116,
      "content_hash": "ff3b62330549a46afe516ce4b88cac49f65c71d8",
      "content": "func (m *MockQuerier) ListLatestSessionFiles(ctx context.Context, sessionID string) ([]db.File, error) {\n\treturn []db.File{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListNewFiles_117": {
      "name": "ListNewFiles",
      "type": "method",
      "start_line": 117,
      "end_line": 117,
      "content_hash": "00ef78c934822a8f51a5ec7eb79fce395058f76c",
      "content": "func (m *MockQuerier) ListNewFiles(ctx context.Context) ([]db.File, error) { return []db.File{}, nil }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CreateMessage_118": {
      "name": "CreateMessage",
      "type": "method",
      "start_line": 118,
      "end_line": 120,
      "content_hash": "4464bde0fa9eeca7ec380c3d69a47fb361803bd1",
      "content": "func (m *MockQuerier) CreateMessage(ctx context.Context, params db.CreateMessageParams) (db.Message, error) {\n\treturn db.Message{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetSessionByID_121": {
      "name": "GetSessionByID",
      "type": "method",
      "start_line": 121,
      "end_line": 123,
      "content_hash": "898cfc0dbfe710d43d4f47b6953c93109f6bcdd2",
      "content": "func (m *MockQuerier) GetSessionByID(ctx context.Context, id string) (db.Session, error) {\n\treturn m.GetSession(ctx, id)\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListMessagesBySession_124": {
      "name": "ListMessagesBySession",
      "type": "method",
      "start_line": 124,
      "end_line": 126,
      "content_hash": "f73d7b73f85a3077a496fc80e97973a9467ebca6",
      "content": "func (m *MockQuerier) ListMessagesBySession(ctx context.Context, sessionID string) ([]db.Message, error) {\n\treturn []db.Message{}, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteMessage_127": {
      "name": "DeleteMessage",
      "type": "method",
      "start_line": 127,
      "end_line": 127,
      "content_hash": "b26fe4862b1b0ec0e82e48443e8a4bc2ead1f6a8",
      "content": "func (m *MockQuerier) DeleteMessage(ctx context.Context, id string) error                { return nil }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteSessionMessages_128": {
      "name": "DeleteSessionMessages",
      "type": "method",
      "start_line": 128,
      "end_line": 130,
      "content_hash": "ef6d62c597e2586bd5e97f6f83657cce0fab209c",
      "content": "func (m *MockQuerier) DeleteSessionMessages(ctx context.Context, sessionID string) error { return nil }\n\n// TestDB provides an in-memory SQLite database for testing",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_TestDB_131": {
      "name": "TestDB",
      "type": "struct",
      "start_line": 131,
      "end_line": 138,
      "content_hash": "2bf6e403e982367d7ae04a6f5cda92260dea2f2c",
      "content": "type TestDB struct {\n\t*sql.DB\n\tq  db.Querier\n\tt  *testing.T\n\tdb *db.Queries\n}\n\n// NewTestDB creates a new in-memory SQLite database with migrations",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewTestDB_139": {
      "name": "NewTestDB",
      "type": "function",
      "start_line": 139,
      "end_line": 169,
      "content_hash": "b58c34338db5aeaf692c018f4c71dfa2bf01dd56",
      "content": "func NewTestDB(t *testing.T) *TestDB {\n\t// Use in-memory SQLite for speed\n\tdsn := \":memory:?_journal_mode=WAL&_synchronous=NORMAL&_cache_size=1000\"\n\n\tsqlDB, err := sql.Open(\"sqlite3\", dsn)\n\tif err != nil {\n\t\tt.Fatalf(\"Failed to open test database: %v\", err)\n\t}\n\n\t// Test connection\n\tif err := sqlDB.Ping(); err != nil {\n\t\tt.Fatalf(\"Failed to ping test database: %v\", err)\n\t}\n\n\t// Run migrations\n\tif err := runMigrations(sqlDB); err != nil {\n\t\tt.Fatalf(\"Failed to run migrations: %v\", err)\n\t}\n\n\t// Create queries\n\tqueries := db.New(sqlDB)\n\n\treturn &TestDB{\n\t\tDB: sqlDB,\n\t\tq:  queries,\n\t\tt:  t,\n\t\tdb: queries,\n\t}\n}\n\n// Querier returns the database querier interface",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Querier_170": {
      "name": "Querier",
      "type": "method",
      "start_line": 170,
      "end_line": 174,
      "content_hash": "f6d718c12e23736d39e5af3f85edf330a0191787",
      "content": "func (tdb *TestDB) Querier() db.Querier {\n\treturn tdb.q\n}\n\n// Cleanup closes the database connection",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Cleanup_175": {
      "name": "Cleanup",
      "type": "method",
      "start_line": 175,
      "end_line": 181,
      "content_hash": "e2408ed2da03d2056963da4a72a84d618585b35b",
      "content": "func (tdb *TestDB) Cleanup() {\n\tif err := tdb.DB.Close(); err != nil {\n\t\ttdb.t.Logf(\"Warning: failed to close test database: %v\", err)\n\t}\n}\n\n// CreateTestSession creates a test session in the database",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CreateTestSession_182": {
      "name": "CreateTestSession",
      "type": "method",
      "start_line": 182,
      "end_line": 195,
      "content_hash": "320ccdee2ce82240e58d988fcb0bcfb309005bb5",
      "content": "func (tdb *TestDB) CreateTestSession(ctx context.Context, title string) db.Session {\n\tid := fmt.Sprintf(\"test-session-%s\", title)\n\tsession, err := tdb.q.CreateSession(ctx, db.CreateSessionParams{\n\t\tID:              id,\n\t\tTitle:           title,\n\t\tParentSessionID: sql.NullString{},\n\t})\n\tif err != nil {\n\t\ttdb.t.Fatalf(\"Failed to create test session: %v\", err)\n\t}\n\treturn session\n}\n\n// Helper to run migrations",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_runMigrations_196": {
      "name": "runMigrations",
      "type": "function",
      "start_line": 196,
      "end_line": 313,
      "content_hash": "87798ba65339ade762fb28a4eda4f4629c0c799d",
      "content": "func runMigrations(db *sql.DB) error {\n\t// For tests, use a complete schema instead of incremental migrations\n\t// to avoid duplicate column issues in fresh databases\n\tschema := `\n-- Sessions\nCREATE TABLE IF NOT EXISTS sessions (\n    id TEXT PRIMARY KEY,\n    parent_session_id TEXT,\n    title TEXT NOT NULL,\n    message_count INTEGER NOT NULL DEFAULT 0 CHECK (message_count >= 0),\n    prompt_tokens  INTEGER NOT NULL DEFAULT 0 CHECK (prompt_tokens >= 0),\n    completion_tokens  INTEGER NOT NULL DEFAULT 0 CHECK (completion_tokens>= 0),\n    cost REAL NOT NULL DEFAULT 0.0 CHECK (cost >= 0.0),\n    summary_message_id TEXT,\n    updated_at INTEGER NOT NULL,  -- Unix timestamp in milliseconds\n    created_at INTEGER NOT NULL   -- Unix timestamp in milliseconds\n);\n\nCREATE TRIGGER IF NOT EXISTS update_sessions_updated_at\nAFTER UPDATE ON sessions\nBEGIN\nUPDATE sessions SET updated_at = strftime('%s', 'now')\nWHERE id = new.id;\nEND;\n\n-- Files\nCREATE TABLE IF NOT EXISTS files (\n    id TEXT PRIMARY KEY,\n    session_id TEXT NOT NULL,\n    path TEXT NOT NULL,\n    content TEXT NOT NULL,\n    version INTEGER NOT NULL DEFAULT 0,\n    created_at INTEGER NOT NULL,  -- Unix timestamp in milliseconds\n    updated_at INTEGER NOT NULL,  -- Unix timestamp in milliseconds\n    FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE,\n    UNIQUE(path, session_id, version)\n);\n\nCREATE INDEX IF NOT EXISTS idx_files_session_id ON files (session_id);\nCREATE INDEX IF NOT EXISTS idx_files_path ON files (path);\n\nCREATE TRIGGER IF NOT EXISTS update_files_updated_at\nAFTER UPDATE ON files\nBEGIN\nUPDATE files SET updated_at = strftime('%s', 'now')\nWHERE id = new.id;\nEND;\n\n-- Messages\nCREATE TABLE IF NOT EXISTS messages (\n    id TEXT PRIMARY KEY,\n    session_id TEXT NOT NULL,\n    role TEXT NOT NULL,\n    parts TEXT NOT NULL default '[]',\n    model TEXT,\n    provider TEXT,\n    is_summary_message INTEGER DEFAULT 0 NOT NULL,\n    created_at INTEGER NOT NULL,  -- Unix timestamp in milliseconds\n    updated_at INTEGER NOT NULL,  -- Unix timestamp in milliseconds\n    finished_at INTEGER,  -- Unix timestamp in milliseconds\n    FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE\n);\n\nCREATE INDEX IF NOT EXISTS idx_messages_session_id ON messages (session_id);\nCREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages (created_at);\nCREATE INDEX IF NOT EXISTS idx_files_created_at ON files (created_at);\n\nCREATE TRIGGER IF NOT EXISTS update_messages_updated_at\nAFTER UPDATE ON messages\nBEGIN\nUPDATE messages SET updated_at = strftime('%s', 'now')\nWHERE id = new.id;\nEND;\n\nCREATE TRIGGER IF NOT EXISTS update_session_message_count_on_insert\nAFTER INSERT ON messages\nBEGIN\nUPDATE sessions SET\n    message_count = message_count + 1\nWHERE id = new.session_id;\nEND;\n\nCREATE TRIGGER IF NOT EXISTS update_session_message_count_on_delete\nAFTER DELETE ON messages\nBEGIN\nUPDATE sessions SET\n    message_count = message_count - 1\nWHERE id = old.session_id;\nEND;\n\n-- Context Archive\nCREATE TABLE IF NOT EXISTS context_archive (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    project TEXT NOT NULL,\n    session_id TEXT NOT NULL,\n    message_id TEXT NOT NULL,\n    reference_uri TEXT UNIQUE NOT NULL CHECK (reference_uri LIKE 'nexora://%'),\n    summary TEXT NOT NULL,\n    token_count INTEGER NOT NULL CHECK (token_count >= 0),\n    metadata TEXT,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    CHECK (length(summary) > 10)\n);\n\nCREATE INDEX IF NOT EXISTS idx_project_session ON context_archive(project, session_id);\nCREATE INDEX IF NOT EXISTS idx_project_time ON context_archive(project, created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_reference_uri ON context_archive(reference_uri);\nCREATE INDEX IF NOT EXISTS idx_created_at ON context_archive(created_at DESC);\n`\n\n\tif _, err := db.Exec(schema); err != nil {\n\t\treturn fmt.Errorf(\"failed to create test schema: %w\", err)\n\t}\n\n\treturn nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestCreateSession_314": {
      "name": "TestCreateSession",
      "type": "function",
      "start_line": 314,
      "end_line": 345,
      "content_hash": "708f7ca9c53b8e3fc073c00888d9f99b89ce13bd",
      "content": "func TestCreateSession(t *testing.T) {\n\ttests := []struct {\n\t\tname     string\n\t\ttitle    string\n\t\texpected string\n\t}{\n\t\t{\"with title\", \"My Test Session\", \"My Test Session\"},\n\t\t{\"empty title\", \"\", \"New Session\"},\n\t\t{\"whitespace title\", \"   \", \"New Session\"},\n\t}\n\n\tfor _, tt := range tests {\n\t\tt.Run(tt.name, func(t *testing.T) {\n\t\t\tmock := NewMockQuerier()\n\t\t\tsvc := session.NewService(mock)\n\n\t\t\tctx := context.Background()\n\t\t\tsession, err := svc.Create(ctx, tt.title)\n\n\t\t\trequire.NoError(t, err)\n\t\t\tassert.NotEmpty(t, session.ID)\n\t\t\tassert.Equal(t, tt.expected, session.Title)\n\t\t\tassert.Equal(t, int64(0), session.MessageCount)\n\t\t\tassert.Greater(t, session.CreatedAt, int64(0))\n\t\t\tassert.Greater(t, session.UpdatedAt, int64(0))\n\n\t\t\t// Verify mock was called\n\t\t\tassert.Contains(t, mock.calls, \"CreateSession\")\n\t\t})\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestCreateTaskSession_346": {
      "name": "TestCreateTaskSession",
      "type": "function",
      "start_line": 346,
      "end_line": 358,
      "content_hash": "d5a095ee96e6761c04085959bd21fb0b7efc5d19",
      "content": "func TestCreateTaskSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\tsession, err := svc.CreateTaskSession(ctx, \"tool-123\", \"parent-456\", \"Build Project\")\n\n\trequire.NoError(t, err)\n\tassert.Equal(t, \"tool-123\", session.ID)\n\tassert.Equal(t, \"parent-456\", session.ParentSessionID)\n\tassert.Equal(t, \"Build Project\", session.Title)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestCreateTitleSession_359": {
      "name": "TestCreateTitleSession",
      "type": "function",
      "start_line": 359,
      "end_line": 371,
      "content_hash": "66f9b10a533c3da2ea63217ea238a09d510861b6",
      "content": "func TestCreateTitleSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\tsession, err := svc.CreateTitleSession(ctx, \"session-789\")\n\n\trequire.NoError(t, err)\n\tassert.Equal(t, \"title-session-789\", session.ID)\n\tassert.Equal(t, \"session-789\", session.ParentSessionID)\n\tassert.Equal(t, \"Generate a title\", session.Title)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestGetSession_372": {
      "name": "TestGetSession",
      "type": "function",
      "start_line": 372,
      "end_line": 391,
      "content_hash": "f03c995ec87d350c52a394713992db27b6a52e0d",
      "content": "func TestGetSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\n\t// Create a session first\n\tcreated, err := mock.CreateSession(ctx, db.CreateSessionParams{\n\t\tID:    \"test-123\",\n\t\tTitle: \"Test Session\",\n\t})\n\trequire.NoError(t, err)\n\n\t// Get the session\n\tsession, err := svc.Get(ctx, \"test-123\")\n\trequire.NoError(t, err)\n\tassert.Equal(t, created.ID, session.ID)\n\tassert.Equal(t, created.Title, session.Title)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestGetNonExistentSession_392": {
      "name": "TestGetNonExistentSession",
      "type": "function",
      "start_line": 392,
      "end_line": 401,
      "content_hash": "6bc049919f1d1ad61f669c50cd2eda46b7ac4a9b",
      "content": "func TestGetNonExistentSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\t_, err := svc.Get(ctx, \"non-existent\")\n\n\tassert.Error(t, err)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestListSessions_402": {
      "name": "TestListSessions",
      "type": "function",
      "start_line": 402,
      "end_line": 416,
      "content_hash": "4cb1f29884e5422f010d3104a2d87787b2864822",
      "content": "func TestListSessions(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\n\t// Create multiple sessions\n\tmock.CreateSession(ctx, db.CreateSessionParams{ID: \"1\", Title: \"Session 1\"})\n\tmock.CreateSession(ctx, db.CreateSessionParams{ID: \"2\", Title: \"Session 2\"})\n\n\tsessions, err := svc.List(ctx)\n\trequire.NoError(t, err)\n\tassert.Len(t, sessions, 2)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestSaveSession_417": {
      "name": "TestSaveSession",
      "type": "function",
      "start_line": 417,
      "end_line": 440,
      "content_hash": "f2f9389b8523ab9389eca8f5aff6befa35c4c97e",
      "content": "func TestSaveSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\n\t// Create initial session\n\t_, err := mock.CreateSession(ctx, db.CreateSessionParams{ID: \"update-test\", Title: \"Original\"})\n\trequire.NoError(t, err)\n\n\t// Update session - only allowed fields are updated\n\tsession := session.Session{\n\t\tID:               \"update-test\",\n\t\tTitle:            \"Updated Title\",\n\t\tSummaryMessageID: \"update-test\",\n\t}\n\n\tsaved, err := svc.Save(ctx, session)\n\trequire.NoError(t, err)\n\tassert.Equal(t, \"Updated Title\", saved.Title)\n\t// MessageCount is not updated by Save method\n\tassert.Equal(t, int64(0), saved.MessageCount)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestDeleteSession_441": {
      "name": "TestDeleteSession",
      "type": "function",
      "start_line": 441,
      "end_line": 458,
      "content_hash": "a51fde4ec71ccf7a7f2318de9ee0eaaae16f2ade",
      "content": "func TestDeleteSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\n\t// Create session first\n\tmock.CreateSession(ctx, db.CreateSessionParams{ID: \"delete-test\", Title: \"To Delete\"})\n\n\t// Delete it\n\terr := svc.Delete(ctx, \"delete-test\")\n\trequire.NoError(t, err)\n\n\t// Verify it's gone\n\t_, err = mock.GetSession(ctx, \"delete-test\")\n\tassert.Error(t, err)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestDeleteNonExistentSession_459": {
      "name": "TestDeleteNonExistentSession",
      "type": "function",
      "start_line": 459,
      "end_line": 468,
      "content_hash": "77216744e8c37bdba697fe7b2b138612539ebc8c",
      "content": "func TestDeleteNonExistentSession(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\terr := svc.Delete(ctx, \"non-existent\")\n\n\tassert.Error(t, err)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestAgentToolSessionID_469": {
      "name": "TestAgentToolSessionID",
      "type": "function",
      "start_line": 469,
      "end_line": 491,
      "content_hash": "7b6a3c1ae8a985bbfd1070364422152e46a8130c",
      "content": "func TestAgentToolSessionID(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\t// Test CreateAgentToolSessionID\n\tsessionID := svc.CreateAgentToolSessionID(\"msg-123\", \"tool-456\")\n\tassert.Equal(t, \"msg-123$$tool-456\", sessionID)\n\n\t// Test ParseAgentToolSessionID\n\tmsgID, toolID, ok := svc.ParseAgentToolSessionID(sessionID)\n\tassert.True(t, ok)\n\tassert.Equal(t, \"msg-123\", msgID)\n\tassert.Equal(t, \"tool-456\", toolID)\n\n\t// Test with invalid format\n\t_, _, ok = svc.ParseAgentToolSessionID(\"invalid\")\n\tassert.False(t, ok)\n\n\t// Test IsAgentToolSession\n\tassert.True(t, svc.IsAgentToolSession(sessionID))\n\tassert.False(t, svc.IsAgentToolSession(\"regular-session\"))\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestSessionPublishEvents_492": {
      "name": "TestSessionPublishEvents",
      "type": "function",
      "start_line": 492,
      "end_line": 507,
      "content_hash": "dec01575efe5e68ecb5172fb1061471591c3b09c",
      "content": "func TestSessionPublishEvents(t *testing.T) {\n\tmock := NewMockQuerier()\n\tsvc := session.NewService(mock)\n\n\tctx := context.Background()\n\n\t// Test basic session creation\n\tsession, err := svc.Create(ctx, \"Test Session\")\n\trequire.NoError(t, err)\n\tassert.NotEmpty(t, session.ID)\n\tassert.Equal(t, \"Test Session\", session.Title)\n\n\t// Note: Full pubsub testing would require access to the broker\n\t// which is not exposed through the public API\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_TestWithRealDB_508": {
      "name": "TestWithRealDB",
      "type": "function",
      "start_line": 508,
      "end_line": 552,
      "content_hash": "ae666569f130bb36b948f3ec64c2afe770a8f437",
      "content": "func TestWithRealDB(t *testing.T) {\n\t// This test uses a real in-memory SQLite database\n\ttdb := NewTestDB(t)\n\tdefer tdb.Cleanup()\n\tsvc := session.NewService(tdb.Querier())\n\n\tctx := context.Background()\n\n\t// Test full lifecycle\n\tsess, err := svc.Create(ctx, \"DB Test Session\")\n\trequire.NoError(t, err)\n\tassert.NotEmpty(t, sess.ID)\n\n\t// Get it back\n\tretrieved, err := svc.Get(ctx, sess.ID)\n\trequire.NoError(t, err)\n\tassert.Equal(t, sess.ID, retrieved.ID)\n\tassert.Equal(t, sess.Title, retrieved.Title)\n\n\t// Update it\n\tupdated := session.Session{\n\t\tID:               sess.ID,\n\t\tTitle:            \"Updated Session\",\n\t\tMessageCount:     5,\n\t\tSummaryMessageID: sess.SummaryMessageID, // fromDBItem sets this\n\t}\n\n\tsaved, err := svc.Save(ctx, updated)\n\trequire.NoError(t, err)\n\tassert.Equal(t, \"Updated Session\", saved.Title)\n\n\t// List sessions\n\tsessions, err := svc.List(ctx)\n\trequire.NoError(t, err)\n\tassert.Len(t, sessions, 1)\n\tassert.Equal(t, saved.ID, sessions[0].ID)\n\n\t// Delete it\n\terr = svc.Delete(ctx, sess.ID)\n\trequire.NoError(t, err)\n\n\t// Verify gone\n\t_, err = svc.Get(ctx, sess.ID)\n\tassert.Error(t, err)\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}