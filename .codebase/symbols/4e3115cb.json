{
  "file_path": "/work/external-deps/Context-Engine/tests/test_env_behavior.py",
  "file_hash": "0f80c3657ea5c5e67786854fd07653654d824054",
  "updated_at": "2025-12-26T17:34:21.599155",
  "symbols": {
    "function_test_rerank_timeout_floor_and_env_defaults_10": {
      "name": "test_rerank_timeout_floor_and_env_defaults",
      "type": "function",
      "start_line": 10,
      "end_line": 54,
      "content_hash": "47ed32cdc772bca90d8a3cec460aa482f145e6df",
      "content": "def test_rerank_timeout_floor_and_env_defaults(monkeypatch):\n    # Force rerank via env default when arg not provided\n    monkeypatch.setenv(\"RERANKER_ENABLED\", \"1\")\n    monkeypatch.setenv(\"RERANK_IN_PROCESS\", \"0\")\n\n    # Floor 1500ms; client asks 200ms -> effective >= 1500ms -> 1.5s\n    monkeypatch.setenv(\"RERANK_TIMEOUT_FLOOR_MS\", \"1500\")\n\n    # Fake _run_async to capture calls\n    calls = []\n\n    async def fake_run(cmd, env=None, timeout=None):\n        calls.append({\"cmd\": cmd, \"timeout\": timeout})\n        # Distinguish hybrid vs rerank by script name\n        if any(\"rerank_local.py\" in str(x) for x in cmd):\n            # Return something that looks like rerank stdout\n            return {\n                \"ok\": True,\n                \"stdout\": \"0.9\\t/path.py\\t\\t1-3\\n\",\n                \"stderr\": \"\",\n                \"code\": 0,\n            }\n        else:\n            # Hybrid JSONL minimal\n            return {\n                \"ok\": True,\n                \"stdout\": '{\"score\": 0.1, \"path\": \"/p\", \"start_line\": 1, \"end_line\": 2}\\n',\n                \"stderr\": \"\",\n                \"code\": 0,\n            }\n\n    monkeypatch.setattr(srv, \"_run_async\", fake_run)\n\n    # Call repo_search with no rerank_enabled arg to pick env default\n    res = srv.asyncio.get_event_loop().run_until_complete(\n        srv.repo_search(query=\"foo\", limit=3, per_path=1)\n    )\n\n    assert any(\n        \"rerank_local.py\" in \" \".join(map(str, c[\"cmd\"])) for c in calls\n    ), \"rerank subprocess should be invoked\"\n    # find rerank call\n    rc = next(c for c in calls if any(\"rerank_local.py\" in str(x) for x in c[\"cmd\"]))\n    assert rc[\"timeout\"] >= 1.5 and rc[\"timeout\"] <= 2.0\n    assert res[\"used_rerank\"] is True",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fake_run_21": {
      "name": "fake_run",
      "type": "function",
      "start_line": 21,
      "end_line": 39,
      "content_hash": "834518ca3bc4a65041cf0ee1a1225a83f95b8b47",
      "content": "    async def fake_run(cmd, env=None, timeout=None):\n        calls.append({\"cmd\": cmd, \"timeout\": timeout})\n        # Distinguish hybrid vs rerank by script name\n        if any(\"rerank_local.py\" in str(x) for x in cmd):\n            # Return something that looks like rerank stdout\n            return {\n                \"ok\": True,\n                \"stdout\": \"0.9\\t/path.py\\t\\t1-3\\n\",\n                \"stderr\": \"\",\n                \"code\": 0,\n            }\n        else:\n            # Hybrid JSONL minimal\n            return {\n                \"ok\": True,\n                \"stdout\": '{\"score\": 0.1, \"path\": \"/p\", \"start_line\": 1, \"end_line\": 2}\\n',\n                \"stderr\": \"\",\n                \"code\": 0,\n            }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}