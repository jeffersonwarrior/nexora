{
  "file_path": "/work/context-engine/test_gpu_switch.py",
  "file_hash": "b798629874bc63fe1a4b3fa730e3292fc131c294",
  "updated_at": "2025-12-26T17:34:20.523399",
  "symbols": {
    "function_load_env_file_16": {
      "name": "load_env_file",
      "type": "function",
      "start_line": 16,
      "end_line": 27,
      "content_hash": "07f9c1be65a35b31a81f338eb291134f09de3be4",
      "content": "def load_env_file():\n    \"\"\"Load environment variables from .env file.\"\"\"\n    env_file = '.env'\n    if os.path.exists(env_file):\n        with open(env_file, 'r') as f:\n            for line in f:\n                line = line.strip()\n                if line and not line.startswith('#') and '=' in line:\n                    key, value = line.split('=', 1)\n                    # Only set if not already in environment\n                    if key not in os.environ:\n                        os.environ[key] = value",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_decoder_url_resolution_29": {
      "name": "test_decoder_url_resolution",
      "type": "function",
      "start_line": 29,
      "end_line": 68,
      "content_hash": "6f78bb8ba72296ab20e878194c18bd6893adb2b1",
      "content": "def test_decoder_url_resolution():\n    \"\"\"Test that the decoder URL is resolved correctly based on USE_GPU_DECODER flag.\"\"\"\n    \n    # Import the resolver function\n    sys.path.insert(0, 'scripts')\n    from refrag_llamacpp import LlamaCppRefragClient\n    \n    # Test current configuration\n    use_gpu = os.environ.get(\"USE_GPU_DECODER\", \"0\")\n    print(f\"USE_GPU_DECODER = {use_gpu}\")\n    \n    # Create client and check URL\n    client = LlamaCppRefragClient()\n    print(f\"Resolved decoder URL: {client.base_url}\")\n\n    # Test health endpoint\n    try:\n        import urllib.request\n\n        health_url = client.base_url.rstrip('/') + '/health'\n\n        # For Docker service names, try localhost equivalent when running on host\n        if 'llamacpp:8080' in health_url:\n            health_url = health_url.replace('llamacpp:8080', 'localhost:8080')\n            print(f\"Testing health endpoint: {health_url} (Docker service via localhost)\")\n        else:\n            print(f\"Testing health endpoint: {health_url}\")\n\n        req = urllib.request.Request(health_url, method='GET')\n        with urllib.request.urlopen(req, timeout=5) as resp:\n            if resp.status == 200:\n                print(\"PASS: Decoder server is healthy and reachable\")\n                return True\n            else:\n                print(f\"FAIL: Decoder server returned status {resp.status}\")\n                return False\n\n    except Exception as e:\n        print(f\"FAIL: Failed to reach decoder server: {e}\")\n        return False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_simple_completion_70": {
      "name": "test_simple_completion",
      "type": "function",
      "start_line": 70,
      "end_line": 104,
      "content_hash": "afc384301bd5618bf5133aa58dff5c0c90254d9c",
      "content": "def test_simple_completion():\n    \"\"\"Test a simple completion request.\"\"\"\n    \n    sys.path.insert(0, 'scripts')\n    from refrag_llamacpp import LlamaCppRefragClient, is_decoder_enabled\n    \n    if not is_decoder_enabled():\n        print(\"FAIL: Decoder is disabled. Set REFRAG_DECODER=1 to enable.\")\n        return False\n    \n    try:\n        client = LlamaCppRefragClient()\n\n        # For Docker service names, use localhost equivalent when running on host\n        test_url = client.base_url\n        if 'llamacpp:8080' in client.base_url:\n            test_url = client.base_url.replace('llamacpp:8080', 'localhost:8080')\n            # Override the client's base_url for testing\n            client.base_url = test_url\n            print(f\"Testing completion with decoder at: {test_url} (Docker service via localhost)\")\n        else:\n            print(f\"Testing completion with decoder at: {client.base_url}\")\n\n        response = client.generate_with_soft_embeddings(\n            prompt=\"What is 2+2?\",\n            max_tokens=50,\n            temperature=0.1\n        )\n        \n        print(f\"PASS: Completion successful: {response[:100]}...\")\n        return True\n\n    except Exception as e:\n        print(f\"FAIL: Completion failed: {e}\")\n        return False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}