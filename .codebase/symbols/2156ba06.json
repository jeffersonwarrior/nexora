{
  "file_path": "/work/external-deps/claude-mem/scripts/build-hooks.js",
  "file_hash": "e9a4f3cacb2e55309f835b91933afffceed08921",
  "updated_at": "2025-12-26T17:34:20.904520",
  "symbols": {
    "function_buildHooks_49": {
      "name": "buildHooks",
      "type": "function",
      "start_line": 49,
      "end_line": 287,
      "content_hash": "37122a6e41c34ced60952e2c3910986078596268",
      "content": "async function buildHooks() {\n  console.log('\ud83d\udd28 Building claude-mem hooks and worker service...\\n');\n\n  try {\n    // Read version from package.json\n    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf-8'));\n    const version = packageJson.version;\n    console.log(`\ud83d\udccc Version: ${version}`);\n\n    // Create output directories\n    console.log('\\n\ud83d\udce6 Preparing output directories...');\n    const hooksDir = 'plugin/scripts';\n    const uiDir = 'plugin/ui';\n\n    if (!fs.existsSync(hooksDir)) {\n      fs.mkdirSync(hooksDir, { recursive: true });\n    }\n    if (!fs.existsSync(uiDir)) {\n      fs.mkdirSync(uiDir, { recursive: true });\n    }\n    console.log('\u2713 Output directories ready');\n\n    // Generate plugin/package.json for cache directory dependency installation\n    // Note: bun:sqlite is a Bun built-in, no external dependencies needed for SQLite\n    console.log('\\n\ud83d\udce6 Generating plugin package.json...');\n    const pluginPackageJson = {\n      name: 'claude-mem-plugin',\n      version: version,\n      private: true,\n      description: 'Runtime dependencies for claude-mem bundled hooks',\n      type: 'module',\n      dependencies: {},\n      engines: {\n        node: '>=18.0.0',\n        bun: '>=1.0.0'\n      }\n    };\n    fs.writeFileSync('plugin/package.json', JSON.stringify(pluginPackageJson, null, 2) + '\\n');\n    console.log('\u2713 plugin/package.json generated');\n\n    // Build React viewer\n    console.log('\\n\ud83d\udccb Building React viewer...');\n    const { spawn } = await import('child_process');\n    const viewerBuild = spawn('node', ['scripts/build-viewer.js'], { stdio: 'inherit' });\n    await new Promise((resolve, reject) => {\n      viewerBuild.on('exit', (code) => {\n        if (code === 0) {\n          resolve();\n        } else {\n          reject(new Error(`Viewer build failed with exit code ${code}`));\n        }\n      });\n    });\n\n    // Build worker service\n    console.log(`\\n\ud83d\udd27 Building worker service...`);\n    await build({\n      entryPoints: [WORKER_SERVICE.source],\n      bundle: true,\n      platform: 'node',\n      target: 'node18',\n      format: 'cjs',\n      outfile: `${hooksDir}/${WORKER_SERVICE.name}.cjs`,\n      minify: true,\n      logLevel: 'error', // Suppress warnings (import.meta warning is benign)\n      external: ['bun:sqlite'],\n      define: {\n        '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n      },\n      banner: {\n        js: '#!/usr/bin/env bun'\n      }\n    });\n\n    // Make worker service executable\n    fs.chmodSync(`${hooksDir}/${WORKER_SERVICE.name}.cjs`, 0o755);\n    const workerStats = fs.statSync(`${hooksDir}/${WORKER_SERVICE.name}.cjs`);\n    console.log(`\u2713 worker-service built (${(workerStats.size / 1024).toFixed(2)} KB)`);\n\n    // Build worker wrapper (Windows zombie port fix)\n    console.log(`\\n\ud83d\udd27 Building worker wrapper...`);\n    await build({\n      entryPoints: [WORKER_WRAPPER.source],\n      bundle: true,\n      platform: 'node',\n      target: 'node18',\n      format: 'cjs',\n      outfile: `${hooksDir}/${WORKER_WRAPPER.name}.cjs`,\n      minify: true,\n      logLevel: 'error',\n      external: ['bun:sqlite'],\n      define: {\n        '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n      },\n      banner: {\n        js: '#!/usr/bin/env bun'\n      }\n    });\n\n    // Make worker wrapper executable\n    fs.chmodSync(`${hooksDir}/${WORKER_WRAPPER.name}.cjs`, 0o755);\n    const wrapperStats = fs.statSync(`${hooksDir}/${WORKER_WRAPPER.name}.cjs`);\n    console.log(`\u2713 worker-wrapper built (${(wrapperStats.size / 1024).toFixed(2)} KB)`);\n\n    // Build MCP server\n    console.log(`\\n\ud83d\udd27 Building MCP server...`);\n    await build({\n      entryPoints: [MCP_SERVER.source],\n      bundle: true,\n      platform: 'node',\n      target: 'node18',\n      format: 'cjs',\n      outfile: `${hooksDir}/${MCP_SERVER.name}.cjs`,\n      minify: true,\n      logLevel: 'error',\n      external: ['bun:sqlite'],\n      define: {\n        '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n      },\n      banner: {\n        js: '#!/usr/bin/env node'\n      }\n    });\n\n    // Make MCP server executable\n    fs.chmodSync(`${hooksDir}/${MCP_SERVER.name}.cjs`, 0o755);\n    const mcpServerStats = fs.statSync(`${hooksDir}/${MCP_SERVER.name}.cjs`);\n    console.log(`\u2713 mcp-server built (${(mcpServerStats.size / 1024).toFixed(2)} KB)`);\n\n    // Build context generator\n    console.log(`\\n\ud83d\udd27 Building context generator...`);\n    await build({\n      entryPoints: [CONTEXT_GENERATOR.source],\n      bundle: true,\n      platform: 'node',\n      target: 'node18',\n      format: 'cjs',\n      outfile: `${hooksDir}/${CONTEXT_GENERATOR.name}.cjs`,\n      minify: true,\n      logLevel: 'error',\n      external: ['bun:sqlite'],\n      define: {\n        '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n      }\n    });\n\n    const contextGenStats = fs.statSync(`${hooksDir}/${CONTEXT_GENERATOR.name}.cjs`);\n    console.log(`\u2713 context-generator built (${(contextGenStats.size / 1024).toFixed(2)} KB)`);\n\n    // Build worker CLI\n    console.log(`\\n\ud83d\udd27 Building worker CLI...`);\n    await build({\n      entryPoints: [WORKER_CLI.source],\n      bundle: true,\n      platform: 'node',\n      target: 'node18',\n      format: 'esm',\n      outfile: `${hooksDir}/${WORKER_CLI.name}.js`,\n      minify: true,\n      logLevel: 'error',\n      external: ['bun:sqlite'],\n      define: {\n        '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n      },\n      banner: {\n        js: '#!/usr/bin/env bun'\n      }\n    });\n\n    // Make worker CLI executable\n    fs.chmodSync(`${hooksDir}/${WORKER_CLI.name}.js`, 0o755);\n    const workerCliStats = fs.statSync(`${hooksDir}/${WORKER_CLI.name}.js`);\n    console.log(`\u2713 worker-cli built (${(workerCliStats.size / 1024).toFixed(2)} KB)`);\n\n    // Build each hook\n    for (const hook of HOOKS) {\n      console.log(`\\n\ud83d\udd27 Building ${hook.name}...`);\n\n      const outfile = `${hooksDir}/${hook.name}.js`;\n\n      await build({\n        entryPoints: [hook.source],\n        bundle: true,\n        platform: 'node',\n        target: 'node18',\n        format: 'esm',\n        outfile,\n        minify: true,\n        external: ['bun:sqlite'],\n        define: {\n          '__DEFAULT_PACKAGE_VERSION__': `\"${version}\"`\n        },\n        banner: {\n          js: '#!/usr/bin/env bun'\n        }\n      });\n\n      // Make executable\n      fs.chmodSync(outfile, 0o755);\n\n      // Check file size\n      const stats = fs.statSync(outfile);\n      const sizeInKB = (stats.size / 1024).toFixed(2);\n      console.log(`\u2713 ${hook.name} built (${sizeInKB} KB)`);\n    }\n\n    // Build mem-search skill zip for Claude Desktop\n    console.log('\\n\ud83d\udce6 Building mem-search skill zip for Claude Desktop...');\n    const { execSync } = await import('child_process');\n    const zipOutput = 'plugin/skills/mem-search.zip';\n\n    // Remove old zip if exists\n    if (fs.existsSync(zipOutput)) {\n      fs.unlinkSync(zipOutput);\n    }\n\n    // Create zip from mem-search skill directory\n    execSync(`cd plugin/skills && zip -r mem-search.zip mem-search/`, { stdio: 'pipe' });\n    const zipStats = fs.statSync(zipOutput);\n    console.log(`\u2713 mem-search.zip built (${(zipStats.size / 1024).toFixed(2)} KB)`);\n\n    console.log('\\n\u2705 All hooks, worker service, and MCP server built successfully!');\n    console.log(`   Output: ${hooksDir}/`);\n    console.log(`   - Hooks: *-hook.js`);\n    console.log(`   - Worker: worker-service.cjs`);\n    console.log(`   - MCP Server: mcp-server.cjs`);\n    console.log(`   - Skills: plugin/skills/`);\n    console.log(`   - Desktop Skill: plugin/skills/mem-search.zip`);\n    console.log('\\n\ud83d\udca1 Note: Dependencies will be auto-installed on first hook execution');\n\n  } catch (error) {\n    console.error('\\n\u274c Build failed:', error.message);\n    if (error.errors) {\n      console.error('\\nBuild errors:');\n      error.errors.forEach(err => console.error(`  - ${err.text}`));\n    }\n    process.exit(1);\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}