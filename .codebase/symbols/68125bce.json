{
  "file_path": "/work/context-engine/vscode-extension/context-engine-uploader/prompt_plus_commands.js",
  "file_hash": "34b8fa7e316b6754135cbd58d3698dcb39743de3",
  "updated_at": "2025-12-26T17:34:22.850899",
  "symbols": {
    "function_registerPromptPlusCommands_1": {
      "name": "registerPromptPlusCommands",
      "type": "function",
      "start_line": 1,
      "end_line": 165,
      "content_hash": "c312b32017196ee21aa80a6010652e20dc762ad4",
      "content": "function registerPromptPlusCommands(deps) {\n  const vscode = deps.vscode;\n  const fs = deps.fs;\n  const path = deps.path;\n  const log = deps.log;\n\n  const getEffectiveConfig = deps.getEffectiveConfig;\n  const resolveTargetPathFromConfig = deps.resolveTargetPathFromConfig;\n  const writeCtxConfig = deps.writeCtxConfig;\n  const getPromptPlusManager = deps.getPromptPlusManager;\n  const getSidebarApi = deps.getSidebarApi;\n\n  const promptEnhanceDisposable = vscode.commands.registerCommand('contextEngineUploader.promptEnhance', () => {\n    try {\n      const promptPlusManager = typeof getPromptPlusManager === 'function' ? getPromptPlusManager() : undefined;\n      if (promptPlusManager && typeof promptPlusManager.enhanceSelectionWithUnicorn === 'function') {\n        promptPlusManager.enhanceSelectionWithUnicorn().catch(error => {\n          log(`Prompt+ failed: ${error instanceof Error ? error.message : String(error)}`);\n          vscode.window.showErrorMessage('Prompt+ failed. See Context Engine Upload output.');\n        });\n      } else {\n        vscode.window.showErrorMessage('Context Engine Uploader: Prompt+ is unavailable (extension failed to initialize Prompt+ manager). See output for details.');\n      }\n    } catch (error) {\n      log(`Prompt+ failed: ${error instanceof Error ? error.message : String(error)}`);\n      vscode.window.showErrorMessage('Prompt+ failed. See Context Engine Upload output.');\n    }\n  });\n\n  const promptEnhanceCopyDisposable = vscode.commands.registerCommand('contextEngineUploader.promptEnhanceCopy', () => {\n    try {\n      const promptPlusManager = typeof getPromptPlusManager === 'function' ? getPromptPlusManager() : undefined;\n      if (promptPlusManager && typeof promptPlusManager.enhancePromptWithUnicornCopy === 'function') {\n        promptPlusManager.enhancePromptWithUnicornCopy().catch(error => {\n          log(`Prompt+ copy failed: ${error instanceof Error ? error.message : String(error)}`);\n          vscode.window.showErrorMessage('Prompt+ copy failed. See Context Engine Upload output.');\n        });\n      } else {\n        vscode.window.showErrorMessage('Context Engine Uploader: Prompt+ is unavailable (extension failed to initialize Prompt+ manager). See output for details.');\n      }\n    } catch (error) {\n      log(`Prompt+ copy failed: ${error instanceof Error ? error.message : String(error)}`);\n      vscode.window.showErrorMessage('Prompt+ copy failed. See Context Engine Upload output.');\n    }\n  });\n\n  const promptEnhanceOpenDisposable = vscode.commands.registerCommand('contextEngineUploader.promptEnhanceOpen', () => {\n    try {\n      const promptPlusManager = typeof getPromptPlusManager === 'function' ? getPromptPlusManager() : undefined;\n      if (promptPlusManager && typeof promptPlusManager.enhancePromptWithUnicornOpen === 'function') {\n        promptPlusManager.enhancePromptWithUnicornOpen().catch(error => {\n          log(`Prompt+ open failed: ${error instanceof Error ? error.message : String(error)}`);\n          vscode.window.showErrorMessage('Prompt+ open failed. See Context Engine Upload output.');\n        });\n      } else {\n        vscode.window.showErrorMessage('Context Engine Uploader: Prompt+ is unavailable (extension failed to initialize Prompt+ manager). See output for details.');\n      }\n    } catch (error) {\n      log(`Prompt+ open failed: ${error instanceof Error ? error.message : String(error)}`);\n      vscode.window.showErrorMessage('Prompt+ open failed. See Context Engine Upload output.');\n    }\n  });\n\n  const promptDefaultModeDisposable = vscode.commands.registerCommand('contextEngineUploader.setCtxDefaultMode', async () => {\n    const cfg = getEffectiveConfig();\n    const resolved = resolveTargetPathFromConfig(cfg);\n    const targetPath = resolved && resolved.path ? String(resolved.path).trim() : '';\n    if (!targetPath) {\n      vscode.window.showErrorMessage('Context Engine Uploader: targetPath is not configured (cannot locate ctx_config.json).');\n      return;\n    }\n\n    const ctxConfigPath = path.join(targetPath, 'ctx_config.json');\n    const items = [\n      {\n        label: 'default',\n        description: 'Fast single-pass rewrite (ctx.py default)',\n        value: 'default',\n      },\n      {\n        label: 'unicorn',\n        description: 'Best quality multi-pass rewrite (ctx.py --unicorn)',\n        value: 'unicorn',\n      },\n    ];\n\n    let existing = {};\n    if (fs.existsSync(ctxConfigPath)) {\n      try {\n        const raw = fs.readFileSync(ctxConfigPath, 'utf8');\n        const parsed = JSON.parse(raw);\n        if (parsed && typeof parsed === 'object') {\n          existing = parsed;\n        }\n      } catch (error) {\n        log(`Failed to parse ctx_config.json at ${ctxConfigPath}: ${error instanceof Error ? error.message : String(error)}`);\n        vscode.window.showErrorMessage('Context Engine Uploader: failed to parse ctx_config.json. See output for details.');\n        return;\n      }\n    } else {\n      const pickedInit = await vscode.window.showInformationMessage(\n        'ctx_config.json not found. Create it now?',\n        'Create',\n        'Cancel'\n      );\n      if (pickedInit !== 'Create') {\n        return;\n      }\n      await writeCtxConfig();\n      if (!fs.existsSync(ctxConfigPath)) {\n        vscode.window.showErrorMessage('Context Engine Uploader: ctx_config.json is still missing after scaffolding.');\n        return;\n      }\n      try {\n        const raw = fs.readFileSync(ctxConfigPath, 'utf8');\n        const parsed = JSON.parse(raw);\n        if (parsed && typeof parsed === 'object') {\n          existing = parsed;\n        }\n      } catch (error) {\n        log(`Failed to parse ctx_config.json after scaffolding at ${ctxConfigPath}: ${error instanceof Error ? error.message : String(error)}`);\n        vscode.window.showErrorMessage('Context Engine Uploader: failed to parse ctx_config.json after scaffolding. See output for details.');\n        return;\n      }\n    }\n\n    const currentMode = (typeof existing.default_mode === 'string' ? existing.default_mode.trim() : '') || 'default';\n    const picked = await vscode.window.showQuickPick(items, {\n      placeHolder: `Prompt+ default mode (currently: ${currentMode})`,\n      matchOnDescription: true,\n      ignoreFocusOut: true,\n    });\n    if (!picked) {\n      return;\n    }\n\n    if (picked.value === currentMode) {\n      vscode.window.showInformationMessage(`Prompt+ default mode already set to '${currentMode}'.`);\n      return;\n    }\n\n    try {\n      existing.default_mode = picked.value;\n      fs.writeFileSync(ctxConfigPath, JSON.stringify(existing, null, 2) + '\\n', 'utf8');\n      vscode.window.showInformationMessage(`Prompt+ default mode set to '${picked.value}'.`);\n      try {\n        const sidebarApi = typeof getSidebarApi === 'function' ? getSidebarApi() : undefined;\n        if (sidebarApi && typeof sidebarApi.refresh === 'function') {\n          sidebarApi.refresh();\n        }\n      } catch (_) {\n      }\n    } catch (error) {\n      log(`Failed to write ctx_config.json default_mode at ${ctxConfigPath}: ${error instanceof Error ? error.message : String(error)}`);\n      vscode.window.showErrorMessage('Context Engine Uploader: failed to update ctx_config.json. See output for details.');\n    }\n  });\n\n  return [\n    promptEnhanceDisposable,\n    promptEnhanceCopyDisposable,\n    promptEnhanceOpenDisposable,\n    promptDefaultModeDisposable,\n  ];\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}