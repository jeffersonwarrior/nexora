{
  "file_path": "/work/internal/agent/agent_tool.go",
  "file_hash": "7db1c2ef8755881f7a005e3bdc4cad548bacb062",
  "updated_at": "2025-12-26T17:34:22.247610",
  "symbols": {
    "struct_AgentParams_20": {
      "name": "AgentParams",
      "type": "struct",
      "start_line": 20,
      "end_line": 27,
      "content_hash": "652d846b46a50add1031ac112816adcfb1f306a3",
      "content": "type AgentParams struct {\n\tPrompt string `json:\"prompt\" description:\"The task for the agent to perform\"`\n}\n\nconst (\n\tAgentToolName = \"agent\"\n)\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_agentTool_28": {
      "name": "agentTool",
      "type": "method",
      "start_line": 28,
      "end_line": 111,
      "content_hash": "df0d0ff89cf60c8dd61993dee0b3d5ea26a4b2e7",
      "content": "func (c *coordinator) agentTool(ctx context.Context) (fantasy.AgentTool, error) {\n\tagentCfg, ok := c.cfg.Agents[config.AgentTask]\n\tif !ok {\n\t\treturn nil, errors.New(\"task agent not configured\")\n\t}\n\tprompt, err := taskPrompt(prompt.WithWorkingDir(c.cfg.WorkingDir()))\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tagent, err := c.buildAgent(ctx, prompt, agentCfg)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn fantasy.NewParallelAgentTool(\n\t\tAgentToolName,\n\t\tstring(agentToolDescription),\n\t\tfunc(ctx context.Context, params AgentParams, call fantasy.ToolCall) (fantasy.ToolResponse, error) {\n\t\t\tif params.Prompt == \"\" {\n\t\t\t\treturn fantasy.NewTextErrorResponse(\"prompt is required\"), nil\n\t\t\t}\n\n\t\t\tsessionID := tools.GetSessionFromContext(ctx)\n\t\t\tif sessionID == \"\" {\n\t\t\t\treturn fantasy.ToolResponse{}, errors.New(\"session id missing from context\")\n\t\t\t}\n\n\t\t\tagentMessageID := tools.GetMessageFromContext(ctx)\n\t\t\tif agentMessageID == \"\" {\n\t\t\t\treturn fantasy.ToolResponse{}, errors.New(\"agent message id missing from context\")\n\t\t\t}\n\n\t\t\tagentToolSessionID := c.sessions.CreateAgentToolSessionID(agentMessageID, call.ID)\n\t\t\tsession, err := c.sessions.CreateTaskSession(ctx, agentToolSessionID, sessionID, \"New Agent Session\")\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"error creating session: %s\", err)\n\t\t\t}\n\t\t\tmodel := agent.Model()\n\t\t\tmaxTokens := model.CatwalkCfg.DefaultMaxTokens\n\t\t\tif model.ModelCfg.MaxTokens != 0 {\n\t\t\t\tmaxTokens = model.ModelCfg.MaxTokens\n\t\t\t}\n\t\t\t// Ensure max tokens is at least 1\n\t\t\tif maxTokens < 1 {\n\t\t\t\tmaxTokens = 4096\n\t\t\t\tslog.Warn(\"agent_tool: MaxTokens < 1, using fallback\", \"original\", maxTokens, \"fallback\", 4096)\n\t\t\t}\n\n\t\t\tproviderCfg, ok := c.cfg.Providers.Get(model.ModelCfg.Provider)\n\t\t\tif !ok {\n\t\t\t\treturn fantasy.ToolResponse{}, errors.New(\"model provider not configured\")\n\t\t\t}\n\t\t\tresult, err := agent.Run(ctx, SessionAgentCall{\n\t\t\t\tSessionID:        session.ID,\n\t\t\t\tPrompt:           params.Prompt,\n\t\t\t\tMaxOutputTokens:  maxTokens,\n\t\t\t\tProviderOptions:  getProviderOptions(model, providerCfg),\n\t\t\t\tTemperature:      model.ModelCfg.Temperature,\n\t\t\t\tTopP:             model.ModelCfg.TopP,\n\t\t\t\tTopK:             model.ModelCfg.TopK,\n\t\t\t\tFrequencyPenalty: model.ModelCfg.FrequencyPenalty,\n\t\t\t\tPresencePenalty:  model.ModelCfg.PresencePenalty,\n\t\t\t})\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.NewTextErrorResponse(\"error generating response\"), nil\n\t\t\t}\n\t\t\tupdatedSession, err := c.sessions.Get(ctx, session.ID)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"error getting session: %s\", err)\n\t\t\t}\n\t\t\tparentSession, err := c.sessions.Get(ctx, sessionID)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"error getting parent session: %s\", err)\n\t\t\t}\n\n\t\t\tparentSession.Cost += updatedSession.Cost\n\n\t\t\t_, err = c.sessions.Save(ctx, parentSession)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"error saving parent session: %s\", err)\n\t\t\t}\n\t\t\treturn fantasy.NewTextResponse(result.Response.Content.Text()), nil\n\t\t}), nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}