{
  "file_path": "/work/external-deps/claude-mem/src/services/worker/DatabaseManager.ts",
  "file_hash": "ef84ebc24d97ad127f79b7ce346a7462600941c7",
  "updated_at": "2025-12-26T17:34:19.933105",
  "symbols": {
    "class_DatabaseManager_17": {
      "name": "DatabaseManager",
      "type": "class",
      "start_line": 17,
      "end_line": 119,
      "content_hash": "82b257ec340a77589d0e545d86880ecf1e0a47eb",
      "content": "export class DatabaseManager {\n  private sessionStore: SessionStore | null = null;\n  private sessionSearch: SessionSearch | null = null;\n  private chromaSync: ChromaSync | null = null;\n\n  /**\n   * Initialize database connection (once, stays open)\n   */\n  async initialize(): Promise<void> {\n    // Open database connection (ONCE)\n    this.sessionStore = new SessionStore();\n    this.sessionSearch = new SessionSearch();\n\n    // Initialize ChromaSync\n    this.chromaSync = new ChromaSync('claude-mem');\n\n    // Start background backfill (fire-and-forget)\n    this.chromaSync.ensureBackfilled().catch(error => {\n      logger.error('DB', 'Chroma backfill failed (non-fatal)', {}, error);\n    });\n\n    logger.info('DB', 'Database initialized');\n  }\n\n  /**\n   * Close database connection and cleanup all resources\n   */\n  async close(): Promise<void> {\n    // Close ChromaSync first (terminates uvx/python processes)\n    if (this.chromaSync) {\n      await this.chromaSync.close();\n      this.chromaSync = null;\n    }\n\n    if (this.sessionStore) {\n      this.sessionStore.close();\n      this.sessionStore = null;\n    }\n    if (this.sessionSearch) {\n      this.sessionSearch.close();\n      this.sessionSearch = null;\n    }\n    logger.info('DB', 'Database closed');\n  }\n\n  /**\n   * Get SessionStore instance (throws if not initialized)\n   */\n  getSessionStore(): SessionStore {\n    if (!this.sessionStore) {\n      throw new Error('Database not initialized');\n    }\n    return this.sessionStore;\n  }\n\n  /**\n   * Get SessionSearch instance (throws if not initialized)\n   */\n  getSessionSearch(): SessionSearch {\n    if (!this.sessionSearch) {\n      throw new Error('Database not initialized');\n    }\n    return this.sessionSearch;\n  }\n\n  /**\n   * Get ChromaSync instance (throws if not initialized)\n   */\n  getChromaSync(): ChromaSync {\n    if (!this.chromaSync) {\n      throw new Error('ChromaSync not initialized');\n    }\n    return this.chromaSync;\n  }\n\n  // REMOVED: cleanupOrphanedSessions - violates \"EVERYTHING SHOULD SAVE ALWAYS\"\n  // Worker restarts don't make sessions orphaned. Sessions are managed by hooks\n  // and exist independently of worker state.\n\n  /**\n   * Get session by ID (throws if not found)\n   */\n  getSessionById(sessionDbId: number): {\n    id: number;\n    claude_session_id: string;\n    sdk_session_id: string | null;\n    project: string;\n    user_prompt: string;\n  } {\n    const session = this.getSessionStore().getSessionById(sessionDbId);\n    if (!session) {\n      throw new Error(`Session ${sessionDbId} not found`);\n    }\n    return session;\n  }\n\n  /**\n   * Mark session as completed\n   */\n  markSessionComplete(sessionDbId: number): void {\n    this.getSessionStore().markSessionCompleted(sessionDbId);\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_initialize_25": {
      "name": "initialize",
      "type": "method",
      "start_line": 25,
      "end_line": 39,
      "content_hash": "dd18261dab962f0b83cf72339dc46ca3acae2e71",
      "content": "  async initialize(): Promise<void> {\n    // Open database connection (ONCE)\n    this.sessionStore = new SessionStore();\n    this.sessionSearch = new SessionSearch();\n\n    // Initialize ChromaSync\n    this.chromaSync = new ChromaSync('claude-mem');\n\n    // Start background backfill (fire-and-forget)\n    this.chromaSync.ensureBackfilled().catch(error => {\n      logger.error('DB', 'Chroma backfill failed (non-fatal)', {}, error);\n    });\n\n    logger.info('DB', 'Database initialized');\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_close_44": {
      "name": "close",
      "type": "method",
      "start_line": 44,
      "end_line": 60,
      "content_hash": "e6dafda871fcffd02e04d83bd1d59dada1d460dc",
      "content": "  async close(): Promise<void> {\n    // Close ChromaSync first (terminates uvx/python processes)\n    if (this.chromaSync) {\n      await this.chromaSync.close();\n      this.chromaSync = null;\n    }\n\n    if (this.sessionStore) {\n      this.sessionStore.close();\n      this.sessionStore = null;\n    }\n    if (this.sessionSearch) {\n      this.sessionSearch.close();\n      this.sessionSearch = null;\n    }\n    logger.info('DB', 'Database closed');\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_getSessionStore_65": {
      "name": "getSessionStore",
      "type": "method",
      "start_line": 65,
      "end_line": 70,
      "content_hash": "38374b992fdcf775c96fe047daeee2a0116721dc",
      "content": "  getSessionStore(): SessionStore {\n    if (!this.sessionStore) {\n      throw new Error('Database not initialized');\n    }\n    return this.sessionStore;\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_getSessionSearch_75": {
      "name": "getSessionSearch",
      "type": "method",
      "start_line": 75,
      "end_line": 80,
      "content_hash": "26bd66ab9ac8ec192f255c83dcf5546fed71f6ed",
      "content": "  getSessionSearch(): SessionSearch {\n    if (!this.sessionSearch) {\n      throw new Error('Database not initialized');\n    }\n    return this.sessionSearch;\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_getChromaSync_85": {
      "name": "getChromaSync",
      "type": "method",
      "start_line": 85,
      "end_line": 90,
      "content_hash": "384da3e25cf05e4a007465b529c2d529481728e0",
      "content": "  getChromaSync(): ChromaSync {\n    if (!this.chromaSync) {\n      throw new Error('ChromaSync not initialized');\n    }\n    return this.chromaSync;\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_getSessionById_99": {
      "name": "getSessionById",
      "type": "method",
      "start_line": 99,
      "end_line": 111,
      "content_hash": "abb1832309f6c4bbdcd1e86b7cbd98bbbae514ea",
      "content": "  getSessionById(sessionDbId: number): {\n    id: number;\n    claude_session_id: string;\n    sdk_session_id: string | null;\n    project: string;\n    user_prompt: string;\n  } {\n    const session = this.getSessionStore().getSessionById(sessionDbId);\n    if (!session) {\n      throw new Error(`Session ${sessionDbId} not found`);\n    }\n    return session;\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_markSessionComplete_116": {
      "name": "markSessionComplete",
      "type": "method",
      "start_line": 116,
      "end_line": 118,
      "content_hash": "71126d2e6a3b92464faac73397a6b02138dec18d",
      "content": "  markSessionComplete(sessionDbId: number): void {\n    this.getSessionStore().markSessionCompleted(sessionDbId);\n  }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}