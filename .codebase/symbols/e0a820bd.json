{
  "file_path": "/work/context-engine/tests/test_mcp_router.py",
  "file_hash": "365f3595042916a2b66faf782d716e6cf6fbd59a",
  "updated_at": "2025-12-26T17:34:20.351567",
  "symbols": {
    "function_router_module_22": {
      "name": "router_module",
      "type": "function",
      "start_line": 22,
      "end_line": 28,
      "content_hash": "6335e99729d30ab7756c1b45d9366ed9d85b0d93",
      "content": "def router_module(monkeypatch):\n    \"\"\"Import mcp_router with isolated environment.\"\"\"\n    monkeypatch.delenv(\"MCP_HTTP_URL\", raising=False)\n    monkeypatch.delenv(\"MCP_INDEXER_HTTP_URL\", raising=False)\n\n    router = importlib.import_module(\"scripts.mcp_router\")\n    return importlib.reload(router)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestIntentConstants_34": {
      "name": "TestIntentConstants",
      "type": "class",
      "start_line": 34,
      "end_line": 50,
      "content_hash": "f8208472b0c2f22e69c9234f94d6aec4e5862492",
      "content": "class TestIntentConstants:\n    \"\"\"Tests for intent constant definitions.\"\"\"\n\n    def test_intent_constants_defined(self, router_module):\n        \"\"\"All expected intent constants are defined.\"\"\"\n        assert router_module.INTENT_ANSWER == \"answer\"\n        assert router_module.INTENT_SEARCH == \"search\"\n        assert router_module.INTENT_INDEX == \"index\"\n        assert router_module.INTENT_PRUNE == \"prune\"\n        assert router_module.INTENT_STATUS == \"status\"\n        assert router_module.INTENT_LIST == \"list\"\n\n    def test_search_specialized_intents(self, router_module):\n        \"\"\"Specialized search intents are defined.\"\"\"\n        assert router_module.INTENT_SEARCH_TESTS == \"search_tests\"\n        assert router_module.INTENT_SEARCH_CONFIG == \"search_config\"\n        assert router_module.INTENT_SEARCH_CALLERS == \"search_callers\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_intent_constants_defined_37": {
      "name": "test_intent_constants_defined",
      "type": "method",
      "start_line": 37,
      "end_line": 44,
      "content_hash": "ab389eaefa1b5302e169d12e8cf465251cbe4769",
      "content": "    def test_intent_constants_defined(self, router_module):\n        \"\"\"All expected intent constants are defined.\"\"\"\n        assert router_module.INTENT_ANSWER == \"answer\"\n        assert router_module.INTENT_SEARCH == \"search\"\n        assert router_module.INTENT_INDEX == \"index\"\n        assert router_module.INTENT_PRUNE == \"prune\"\n        assert router_module.INTENT_STATUS == \"status\"\n        assert router_module.INTENT_LIST == \"list\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_search_specialized_intents_46": {
      "name": "test_search_specialized_intents",
      "type": "method",
      "start_line": 46,
      "end_line": 50,
      "content_hash": "be3e3ed727f1d9d010214f1d219d3955efbf700b",
      "content": "    def test_search_specialized_intents(self, router_module):\n        \"\"\"Specialized search intents are defined.\"\"\"\n        assert router_module.INTENT_SEARCH_TESTS == \"search_tests\"\n        assert router_module.INTENT_SEARCH_CONFIG == \"search_config\"\n        assert router_module.INTENT_SEARCH_CALLERS == \"search_callers\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestClassifyIntentRules_56": {
      "name": "TestClassifyIntentRules",
      "type": "class",
      "start_line": 56,
      "end_line": 98,
      "content_hash": "7b3bfacc3df7a52eb5765843329ff6ebc88fa0fa",
      "content": "class TestClassifyIntentRules:\n    \"\"\"Tests for _classify_intent_rules function.\"\"\"\n\n    def test_status_intent_patterns(self, router_module):\n        \"\"\"Status-related queries are classified correctly.\"\"\"\n        status_queries = [\n            \"qdrant status\",\n            \"indexing status\",\n            \"collection status\",\n        ]\n        for q in status_queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_STATUS, f\"Failed for: {q}\"\n\n    def test_list_intent_patterns(self, router_module):\n        \"\"\"List-related queries are classified correctly.\"\"\"\n        list_queries = [\n            \"list collections\",\n            \"show all collections\",\n        ]\n        for q in list_queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_LIST, f\"Failed for: {q}\"\n\n    def test_search_tests_intent(self, router_module):\n        \"\"\"Test search queries are classified correctly.\"\"\"\n        queries = [\n            \"find tests for foo\",\n            \"search for test files\",\n        ]\n        for q in queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_SEARCH_TESTS, f\"Failed for: {q}\"\n\n    def test_search_config_intent(self, router_module):\n        \"\"\"Config search queries are classified correctly.\"\"\"\n        queries = [\n            \"find config for database\",\n            \"where is the yaml config\",\n        ]\n        for q in queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_SEARCH_CONFIG, f\"Failed for: {q}\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_status_intent_patterns_59": {
      "name": "test_status_intent_patterns",
      "type": "method",
      "start_line": 59,
      "end_line": 68,
      "content_hash": "bfab30b02703c1492e23494eaebe3da73d44210d",
      "content": "    def test_status_intent_patterns(self, router_module):\n        \"\"\"Status-related queries are classified correctly.\"\"\"\n        status_queries = [\n            \"qdrant status\",\n            \"indexing status\",\n            \"collection status\",\n        ]\n        for q in status_queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_STATUS, f\"Failed for: {q}\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_list_intent_patterns_70": {
      "name": "test_list_intent_patterns",
      "type": "method",
      "start_line": 70,
      "end_line": 78,
      "content_hash": "462328cc20991d796f574c93b24c968afdccdcd4",
      "content": "    def test_list_intent_patterns(self, router_module):\n        \"\"\"List-related queries are classified correctly.\"\"\"\n        list_queries = [\n            \"list collections\",\n            \"show all collections\",\n        ]\n        for q in list_queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_LIST, f\"Failed for: {q}\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_search_tests_intent_80": {
      "name": "test_search_tests_intent",
      "type": "method",
      "start_line": 80,
      "end_line": 88,
      "content_hash": "4cc33d4cf12bc0288a334f3438c2d6df8dbc0910",
      "content": "    def test_search_tests_intent(self, router_module):\n        \"\"\"Test search queries are classified correctly.\"\"\"\n        queries = [\n            \"find tests for foo\",\n            \"search for test files\",\n        ]\n        for q in queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_SEARCH_TESTS, f\"Failed for: {q}\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_search_config_intent_90": {
      "name": "test_search_config_intent",
      "type": "method",
      "start_line": 90,
      "end_line": 98,
      "content_hash": "daa6d12190b7d7b3b43fa0542cda8d60a8155445",
      "content": "    def test_search_config_intent(self, router_module):\n        \"\"\"Config search queries are classified correctly.\"\"\"\n        queries = [\n            \"find config for database\",\n            \"where is the yaml config\",\n        ]\n        for q in queries:\n            intent = router_module._classify_intent_rules(q)\n            assert intent == router_module.INTENT_SEARCH_CONFIG, f\"Failed for: {q}\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestClassifyIntent_104": {
      "name": "TestClassifyIntent",
      "type": "class",
      "start_line": 104,
      "end_line": 122,
      "content_hash": "2eb70f9496a41448b91f45360d072a6257a79227",
      "content": "class TestClassifyIntent:\n    \"\"\"Tests for the main classify_intent function.\"\"\"\n\n    def test_classify_intent_returns_intent(self, router_module):\n        \"\"\"classify_intent returns a valid intent string.\"\"\"\n        intent = router_module.classify_intent(\"reindex the codebase\")\n        # Should return some intent (index or answer depending on ML)\n        assert intent is not None\n        assert isinstance(intent, str)\n\n    def test_classify_intent_status(self, router_module):\n        \"\"\"Status queries classified correctly.\"\"\"\n        intent = router_module.classify_intent(\"qdrant status\")\n        assert intent == router_module.INTENT_STATUS\n\n    def test_classify_intent_list(self, router_module):\n        \"\"\"List queries classified correctly.\"\"\"\n        intent = router_module.classify_intent(\"list collections\")\n        assert intent == router_module.INTENT_LIST",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_classify_intent_returns_intent_107": {
      "name": "test_classify_intent_returns_intent",
      "type": "method",
      "start_line": 107,
      "end_line": 112,
      "content_hash": "f34e7fcf66fc48319ced45be0c34db681a2ee773",
      "content": "    def test_classify_intent_returns_intent(self, router_module):\n        \"\"\"classify_intent returns a valid intent string.\"\"\"\n        intent = router_module.classify_intent(\"reindex the codebase\")\n        # Should return some intent (index or answer depending on ML)\n        assert intent is not None\n        assert isinstance(intent, str)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_classify_intent_status_114": {
      "name": "test_classify_intent_status",
      "type": "method",
      "start_line": 114,
      "end_line": 117,
      "content_hash": "142187f4f2e08995818edb9d17150c7027f4b62a",
      "content": "    def test_classify_intent_status(self, router_module):\n        \"\"\"Status queries classified correctly.\"\"\"\n        intent = router_module.classify_intent(\"qdrant status\")\n        assert intent == router_module.INTENT_STATUS",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_classify_intent_list_119": {
      "name": "test_classify_intent_list",
      "type": "method",
      "start_line": 119,
      "end_line": 122,
      "content_hash": "9e8d07074004c84f0d6f2fb670c616333afc2318",
      "content": "    def test_classify_intent_list(self, router_module):\n        \"\"\"List queries classified correctly.\"\"\"\n        intent = router_module.classify_intent(\"list collections\")\n        assert intent == router_module.INTENT_LIST",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestBuildPlan_128": {
      "name": "TestBuildPlan",
      "type": "class",
      "start_line": 128,
      "end_line": 179,
      "content_hash": "18d28549577266e0d5be271622a274d0a63aaff2",
      "content": "class TestBuildPlan:\n    \"\"\"Tests for build_plan function.\"\"\"\n\n    def test_build_plan_returns_list(self, router_module):\n        \"\"\"build_plan returns a list of (tool, args) tuples.\"\"\"\n        # Use a query that triggers rule-based classification (avoids embedding model)\n        plan = router_module.build_plan(\"list collections\")\n\n        assert isinstance(plan, list)\n        assert len(plan) >= 1\n        # Each item is a tuple of (tool_name, args_dict)\n        tool_name, args = plan[0]\n        assert isinstance(tool_name, str)\n        assert isinstance(args, dict)\n\n    def test_build_plan_status_tool(self, router_module):\n        \"\"\"Status queries map to qdrant_status tool.\"\"\"\n        plan = router_module.build_plan(\"qdrant status\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"qdrant_status\"\n\n    def test_build_plan_list_tool(self, router_module):\n        \"\"\"List queries map to qdrant_list tool.\"\"\"\n        plan = router_module.build_plan(\"list collections\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"qdrant_list\"\n\n    def test_build_plan_search_tests_tool(self, router_module):\n        \"\"\"Test search queries map to search_tests_for tool.\"\"\"\n        plan = router_module.build_plan(\"find tests for authentication\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"search_tests_for\"\n        assert \"query\" in args\n\n    def test_build_plan_search_config_tool(self, router_module):\n        \"\"\"Config search queries map to search_config_for tool.\"\"\"\n        plan = router_module.build_plan(\"find config for database\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"search_config_for\"\n\n    def test_build_plan_includes_query(self, router_module):\n        \"\"\"build_plan includes the query in args for search tools.\"\"\"\n        # Use a query that triggers rule-based classification (avoids embedding model)\n        plan = router_module.build_plan(\"find tests for authentication\")\n\n        tool_name, args = plan[0]\n        # search_tests_for includes query in args\n        assert \"query\" in args or tool_name in {\"qdrant_status\", \"qdrant_list\", \"qdrant_prune\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_returns_list_131": {
      "name": "test_build_plan_returns_list",
      "type": "method",
      "start_line": 131,
      "end_line": 141,
      "content_hash": "a8444d334ef9b40439fa67b0a1396f47a80153a6",
      "content": "    def test_build_plan_returns_list(self, router_module):\n        \"\"\"build_plan returns a list of (tool, args) tuples.\"\"\"\n        # Use a query that triggers rule-based classification (avoids embedding model)\n        plan = router_module.build_plan(\"list collections\")\n\n        assert isinstance(plan, list)\n        assert len(plan) >= 1\n        # Each item is a tuple of (tool_name, args_dict)\n        tool_name, args = plan[0]\n        assert isinstance(tool_name, str)\n        assert isinstance(args, dict)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_status_tool_143": {
      "name": "test_build_plan_status_tool",
      "type": "method",
      "start_line": 143,
      "end_line": 148,
      "content_hash": "dc5096fb03575511bc4032dba15310810f5ce160",
      "content": "    def test_build_plan_status_tool(self, router_module):\n        \"\"\"Status queries map to qdrant_status tool.\"\"\"\n        plan = router_module.build_plan(\"qdrant status\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"qdrant_status\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_list_tool_150": {
      "name": "test_build_plan_list_tool",
      "type": "method",
      "start_line": 150,
      "end_line": 155,
      "content_hash": "939394dd903e7ee0305dbaa36beba02fc488cf16",
      "content": "    def test_build_plan_list_tool(self, router_module):\n        \"\"\"List queries map to qdrant_list tool.\"\"\"\n        plan = router_module.build_plan(\"list collections\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"qdrant_list\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_search_tests_tool_157": {
      "name": "test_build_plan_search_tests_tool",
      "type": "method",
      "start_line": 157,
      "end_line": 163,
      "content_hash": "1523ccf740dfb7c9cb2fe666c8ee34dc60588dc1",
      "content": "    def test_build_plan_search_tests_tool(self, router_module):\n        \"\"\"Test search queries map to search_tests_for tool.\"\"\"\n        plan = router_module.build_plan(\"find tests for authentication\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"search_tests_for\"\n        assert \"query\" in args",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_search_config_tool_165": {
      "name": "test_build_plan_search_config_tool",
      "type": "method",
      "start_line": 165,
      "end_line": 170,
      "content_hash": "e47299ddf7b68c24e700c0b2553a569f98b69c79",
      "content": "    def test_build_plan_search_config_tool(self, router_module):\n        \"\"\"Config search queries map to search_config_for tool.\"\"\"\n        plan = router_module.build_plan(\"find config for database\")\n\n        tool_name, args = plan[0]\n        assert tool_name == \"search_config_for\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_build_plan_includes_query_172": {
      "name": "test_build_plan_includes_query",
      "type": "method",
      "start_line": 172,
      "end_line": 179,
      "content_hash": "db7a849be1bc9fecf2eb769b84d03e5c34f40ba8",
      "content": "    def test_build_plan_includes_query(self, router_module):\n        \"\"\"build_plan includes the query in args for search tools.\"\"\"\n        # Use a query that triggers rule-based classification (avoids embedding model)\n        plan = router_module.build_plan(\"find tests for authentication\")\n\n        tool_name, args = plan[0]\n        # search_tests_for includes query in args\n        assert \"query\" in args or tool_name in {\"qdrant_status\", \"qdrant_list\", \"qdrant_prune\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestHttpHelpers_185": {
      "name": "TestHttpHelpers",
      "type": "class",
      "start_line": 185,
      "end_line": 209,
      "content_hash": "b3b0791fdc5fd7356f915dd499141fc227cf8faa",
      "content": "class TestHttpHelpers:\n    \"\"\"Tests for HTTP client helper functions.\"\"\"\n\n    def test_filter_args_removes_none(self, router_module):\n        \"\"\"_filter_args removes None values from dict.\"\"\"\n        args = {\"a\": 1, \"b\": None, \"c\": \"hello\", \"d\": None}\n        filtered = router_module._filter_args(args)\n\n        assert filtered == {\"a\": 1, \"c\": \"hello\"}\n\n    def test_filter_args_preserves_false(self, router_module):\n        \"\"\"_filter_args preserves False and 0 values.\"\"\"\n        args = {\"a\": False, \"b\": 0, \"c\": None}\n        filtered = router_module._filter_args(args)\n\n        assert \"a\" in filtered\n        assert \"b\" in filtered\n        assert \"c\" not in filtered\n\n    def test_parse_stream_or_json_parses_json(self, router_module):\n        \"\"\"_parse_stream_or_json parses valid JSON.\"\"\"\n        body = b'{\"result\": \"success\"}'\n        parsed = router_module._parse_stream_or_json(body)\n\n        assert parsed == {\"result\": \"success\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_filter_args_removes_none_188": {
      "name": "test_filter_args_removes_none",
      "type": "method",
      "start_line": 188,
      "end_line": 193,
      "content_hash": "56b8e26c2fffd8a566d4a5acd7d5e0743f6ccc67",
      "content": "    def test_filter_args_removes_none(self, router_module):\n        \"\"\"_filter_args removes None values from dict.\"\"\"\n        args = {\"a\": 1, \"b\": None, \"c\": \"hello\", \"d\": None}\n        filtered = router_module._filter_args(args)\n\n        assert filtered == {\"a\": 1, \"c\": \"hello\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_filter_args_preserves_false_195": {
      "name": "test_filter_args_preserves_false",
      "type": "method",
      "start_line": 195,
      "end_line": 202,
      "content_hash": "92b9f0b2f0c863da1e17f5fc0cb0432c7c4a0ce1",
      "content": "    def test_filter_args_preserves_false(self, router_module):\n        \"\"\"_filter_args preserves False and 0 values.\"\"\"\n        args = {\"a\": False, \"b\": 0, \"c\": None}\n        filtered = router_module._filter_args(args)\n\n        assert \"a\" in filtered\n        assert \"b\" in filtered\n        assert \"c\" not in filtered",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_parse_stream_or_json_parses_json_204": {
      "name": "test_parse_stream_or_json_parses_json",
      "type": "method",
      "start_line": 204,
      "end_line": 209,
      "content_hash": "aa1324d485b93876d5d873791a5b540f42b27ec6",
      "content": "    def test_parse_stream_or_json_parses_json(self, router_module):\n        \"\"\"_parse_stream_or_json parses valid JSON.\"\"\"\n        body = b'{\"result\": \"success\"}'\n        parsed = router_module._parse_stream_or_json(body)\n\n        assert parsed == {\"result\": \"success\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_TestFailureResponseDetection_215": {
      "name": "TestFailureResponseDetection",
      "type": "class",
      "start_line": 215,
      "end_line": 233,
      "content_hash": "c411245b721c705c9cb917e1961da61c1ad671da",
      "content": "class TestFailureResponseDetection:\n    \"\"\"Tests for _is_failure_response function.\"\"\"\n\n    def test_success_response_not_failure(self, router_module):\n        \"\"\"Successful responses are not failures.\"\"\"\n        resp = {\"result\": \"data\", \"ok\": True}\n        assert router_module._is_failure_response(resp) is False\n\n    def test_empty_response_not_failure(self, router_module):\n        \"\"\"Empty dicts are not failures.\"\"\"\n        assert router_module._is_failure_response({}) is False\n\n    def test_detects_isError_true(self, router_module):\n        \"\"\"Detects responses with isError=True.\"\"\"\n        # Note: depends on actual implementation\n        resp = {\"isError\": True, \"content\": []}\n        result = router_module._is_failure_response(resp)\n        # May be True or False depending on implementation\n        assert isinstance(result, bool)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_success_response_not_failure_218": {
      "name": "test_success_response_not_failure",
      "type": "method",
      "start_line": 218,
      "end_line": 221,
      "content_hash": "2a4f7b4f76d6c1478c9253334f1640155c2af3aa",
      "content": "    def test_success_response_not_failure(self, router_module):\n        \"\"\"Successful responses are not failures.\"\"\"\n        resp = {\"result\": \"data\", \"ok\": True}\n        assert router_module._is_failure_response(resp) is False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_empty_response_not_failure_223": {
      "name": "test_empty_response_not_failure",
      "type": "method",
      "start_line": 223,
      "end_line": 225,
      "content_hash": "493f7527f00636ab69b70a6f58567ada2c5d2805",
      "content": "    def test_empty_response_not_failure(self, router_module):\n        \"\"\"Empty dicts are not failures.\"\"\"\n        assert router_module._is_failure_response({}) is False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_test_detects_isError_true_227": {
      "name": "test_detects_isError_true",
      "type": "method",
      "start_line": 227,
      "end_line": 233,
      "content_hash": "9b944f6f49270f6fc6c89c8a672c7866df244495",
      "content": "    def test_detects_isError_true(self, router_module):\n        \"\"\"Detects responses with isError=True.\"\"\"\n        # Note: depends on actual implementation\n        resp = {\"isError\": True, \"content\": []}\n        result = router_module._is_failure_response(resp)\n        # May be True or False depending on implementation\n        assert isinstance(result, bool)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}