{
  "file_path": "/work/external-deps/Context-Engine/scripts/prune.py",
  "file_hash": "66ee7e897bd80c01200e6ffa2264f93aaf2f73e7",
  "updated_at": "2025-12-26T17:34:23.942425",
  "symbols": {
    "function_sha1_file_15": {
      "name": "sha1_file",
      "type": "function",
      "start_line": 15,
      "end_line": 20,
      "content_hash": "f5512ffd0b9904ee7869921850049b453c795f04",
      "content": "def sha1_file(path: Path) -> str:\n    try:\n        data = path.read_bytes()\n    except Exception:\n        return \"\"\n    return hashlib.sha1(data).hexdigest()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_delete_by_path_23": {
      "name": "delete_by_path",
      "type": "function",
      "start_line": 23,
      "end_line": 38,
      "content_hash": "d522f9185b650ee223acc8273055266e8a5b0af0",
      "content": "def delete_by_path(client: QdrantClient, path_str: str) -> int:\n    flt = models.Filter(\n        must=[\n            models.FieldCondition(\n                key=\"metadata.path\", match=models.MatchValue(value=path_str)\n            )\n        ]\n    )\n    try:\n        res = client.delete(\n            collection_name=COLLECTION,\n            points_selector=models.FilterSelector(filter=flt),\n        )\n        return 1\n    except Exception:\n        return 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_main_41": {
      "name": "main",
      "type": "function",
      "start_line": 41,
      "end_line": 85,
      "content_hash": "aafd1640974a30b7747c9ba01dbc9f228faf96b1",
      "content": "def main():\n    client = QdrantClient(url=QDRANT_URL, api_key=API_KEY or None)\n\n    seen = set()\n    removed_missing = 0\n    removed_mismatch = 0\n\n    next_page = None\n    while True:\n        points, next_page = client.scroll(\n            collection_name=COLLECTION,\n            with_payload=True,\n            limit=256,\n            offset=next_page,\n            scroll_filter=None,\n        )\n        if not points:\n            break\n        for p in points:\n            md = (p.payload or {}).get(\"metadata\") or {}\n            path_str = md.get(\"path\")\n            file_hash = md.get(\"file_hash\")\n            if not path_str or path_str in seen:\n                continue\n            seen.add(path_str)\n            abs_path = (\n                ROOT / Path(path_str).relative_to(\"/work\")\n                if path_str.startswith(\"/work/\")\n                else ROOT / path_str\n            )\n            if not abs_path.exists():\n                removed_missing += delete_by_path(client, path_str)\n                print(f\"[prune] removed missing file points: {path_str}\")\n                continue\n            current_hash = sha1_file(abs_path)\n            if file_hash and current_hash and current_hash != file_hash:\n                removed_mismatch += delete_by_path(client, path_str)\n                print(f\"[prune] removed outdated points (hash mismatch): {path_str}\")\n\n        if next_page is None:\n            break\n\n    print(\n        f\"Prune complete. removed_missing={removed_missing}, removed_mismatch={removed_mismatch}\"\n    )",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}