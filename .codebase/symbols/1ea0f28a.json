{
  "file_path": "/work/context-engine/scripts/mcp_router/planning.py",
  "file_hash": "213d2f5173e705d2296f5b5d56f52b1b46e173c6",
  "updated_at": "2025-12-26T17:34:21.486532",
  "symbols": {
    "function_build_plan_31": {
      "name": "build_plan",
      "type": "function",
      "start_line": 31,
      "end_line": 250,
      "content_hash": "da2cf38dc979ab3d354656076a3ee0a088871336",
      "content": "def build_plan(q: str) -> List[Tuple[str, Dict[str, Any]]]:\n    \"\"\"Build execution plan for a query.\"\"\"\n    intent = classify_intent(q)\n    include_snippet = str(os.environ.get(\"ROUTER_INCLUDE_SNIPPET\", \"1\")).lower() in {\"1\", \"true\", \"yes\", \"on\"}\n    search_limit = int(os.environ.get(\"ROUTER_SEARCH_LIMIT\", \"8\") or 8)\n    max_tokens_env = os.environ.get(\"ROUTER_MAX_TOKENS\", \"\").strip()\n\n    def _reuse_last_filters(args: Dict[str, Any]) -> None:\n        try:\n            if looks_like_same_filters(q):\n                sp = load_scratchpad()\n                lf = sp.get(\"last_filters\") if isinstance(sp, dict) else None\n                if isinstance(lf, dict):\n                    for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n                        if k not in args and lf.get(k) not in (None, \"\"):\n                            args[k] = lf.get(k)\n        except Exception:\n            pass\n\n    # Repeat/redo handling\n    try:\n        if looks_like_repeat(q):\n            sp = load_scratchpad()\n            lp = sp.get(\"last_plan\")\n            if isinstance(lp, list) and lp:\n                norm: list[tuple] = []\n                for it in lp:\n                    if isinstance(it, (list, tuple)) and len(it) == 2:\n                        norm.append((it[0], it[1]))\n                if norm:\n                    return norm\n    except Exception:\n        pass\n\n    # Multi-intent: memory store + reindex\n    lowq = q.lower()\n    if any(w in lowq for w in [\"remember this\", \"store memory\", \"save memory\", \"remember that\"]) and any(w in lowq for w in [\"reindex\", \"index now\", \"recreate\", \"fresh index\"]):\n        idx_args: Dict[str, Any] = {}\n        if any(w in lowq for w in [\"recreate\", \"fresh\", \"from scratch\", \"fresh index\"]):\n            idx_args[\"recreate\"] = True\n        info, meta = parse_memory_store_payload(q)\n        store_args: Dict[str, Any] = {\"information\": info or q.strip()}\n        if meta:\n            allowed = {\"priority\", \"tags\", \"topic\", \"category\", \"owner\"}\n            cleaned = {k: v for k, v in meta.items() if k in allowed and v not in (None, \"\", [])}\n            if cleaned:\n                store_args[\"metadata\"] = cleaned\n        return [(\"store\", store_args), (\"qdrant_index_root\", idx_args)]\n\n    if intent == INTENT_INDEX:\n        recreate = True if any(w in q.lower() for w in [\"recreate\", \"fresh\", \"from scratch\"]) else None\n        args = {}\n        if recreate is True:\n            args[\"recreate\"] = True\n        return [(\"qdrant_index_root\", args)]\n\n    if intent == INTENT_PRUNE:\n        return [(\"qdrant_prune\", {})]\n\n    if intent == INTENT_STATUS:\n        return [(\"qdrant_status\", {})]\n\n    if intent == INTENT_LIST:\n        return [(\"qdrant_list\", {})]\n\n    if intent == INTENT_SEARCH:\n        hints = parse_repo_hints(q)\n        clean_q, dsl_filters = clean_query_and_dsl(q)\n        args = {\"query\": clean_q}\n        if search_limit:\n            args[\"limit\"] = search_limit\n        if include_snippet:\n            args[\"include_snippet\"] = True\n        _reuse_last_filters(args)\n\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = dsl_filters.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        try:\n            tool_servers = discover_tool_endpoints(allow_network=False)\n            picked = select_best_search_tool_by_signature(q, tool_servers, allow_network=False) or \"repo_search\"\n        except Exception:\n            picked = \"repo_search\"\n        return [(picked, args)]\n\n    if intent == INTENT_SEARCH_TESTS:\n        hints = parse_repo_hints(q)\n        clean_q, dsl_filters = clean_query_and_dsl(q)\n        args = {\"query\": clean_q}\n        if search_limit:\n            args[\"limit\"] = search_limit\n        if include_snippet:\n            args[\"include_snippet\"] = True\n        _reuse_last_filters(args)\n\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = dsl_filters.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        return [(\"search_tests_for\", args)]\n\n    if intent == INTENT_SEARCH_CONFIG:\n        hints = parse_repo_hints(q)\n        clean_q, dsl_filters = clean_query_and_dsl(q)\n        args = {\"query\": clean_q}\n        if search_limit:\n            args[\"limit\"] = search_limit\n        if include_snippet:\n            args[\"include_snippet\"] = True\n        _reuse_last_filters(args)\n\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = dsl_filters.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        return [(\"search_config_for\", args)]\n\n    if intent == INTENT_MEMORY_STORE:\n        info, meta = parse_memory_store_payload(q)\n        payload: Dict[str, Any] = {\"information\": info or q.strip()}\n        if meta:\n            allowed = {\"priority\", \"tags\", \"topic\", \"category\", \"owner\"}\n            cleaned = {k: v for k, v in meta.items() if k in allowed and v not in (None, \"\", [])}\n            if cleaned:\n                payload[\"metadata\"] = cleaned\n        return [(\"store\", payload)]\n\n    if intent == INTENT_MEMORY_FIND:\n        args = {\"query\": q}\n        if search_limit:\n            args[\"limit\"] = max(5, search_limit)\n        return [(\"find\", args)]\n\n    if intent == INTENT_SEARCH_CALLERS:\n        hints = parse_repo_hints(q)\n        clean_q, dsl_filters = clean_query_and_dsl(q)\n        args = {\"query\": clean_q}\n        if search_limit:\n            args[\"limit\"] = search_limit\n        _reuse_last_filters(args)\n\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = dsl_filters.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        return [(\"search_callers_for\", args)]\n\n    if intent == INTENT_SEARCH_IMPORTERS:\n        hints = parse_repo_hints(q)\n        clean_q, dsl_filters = clean_query_and_dsl(q)\n        args = {\"query\": clean_q}\n        if search_limit:\n            args[\"limit\"] = search_limit\n        _reuse_last_filters(args)\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = dsl_filters.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\") and k not in args:\n                args[k] = v\n        return [(\"search_importers_for\", args)]\n\n    if intent == INTENT_ANSWER:\n        def _looks_like_design_recap(s: str) -> bool:\n            low = s.lower()\n            return any(w in low for w in [\"recap\", \"design doc\", \"architecture\", \"adr\", \"retrospective\", \"postmortem\"]) and any(w in low for w in [\"design\", \"summary\", \"recap\", \"explain\"])\n\n        args: Dict[str, Any] = {\"query\": q}\n        if max_tokens_env:\n            try:\n                mt = int(max_tokens_env)\n                if mt > 0:\n                    args[\"max_tokens\"] = mt\n            except Exception:\n                pass\n\n        hints = parse_repo_hints(q)\n        lowq = q.lower()\n        if \"router\" in lowq:\n            router_globs = [\"**/mcp_router.py\", \"**/*router*.py\"]\n            if not hints.get(\"path_glob\"):\n                hints[\"path_glob\"] = router_globs\n            if not hints.get(\"language\"):\n                hints[\"language\"] = \"python\"\n        for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n            v = hints.get(k)\n            if v not in (None, \"\"):\n                args[k] = v\n\n        plan: List[Tuple[str, Dict[str, Any]]] = []\n        if _looks_like_design_recap(q):\n            plan.append((\"find\", {\"query\": q, \"limit\": 3}))\n        plan.extend([\n            (\"context_answer_compat\", dict(args)),\n            (\"context_answer\", dict(args)),\n            (\"repo_search\", {**{k: v for k, v in args.items() if k != \"max_tokens\"}, \"limit\": max(5, search_limit)}),\n        ])\n        return plan\n\n    # Fallback\n    return [(\"repo_search\", {\"query\": q, \"limit\": search_limit})]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__reuse_last_filters_38": {
      "name": "_reuse_last_filters",
      "type": "function",
      "start_line": 38,
      "end_line": 48,
      "content_hash": "00a787b0ca7f2d67ba863c88269e55622b13fb06",
      "content": "    def _reuse_last_filters(args: Dict[str, Any]) -> None:\n        try:\n            if looks_like_same_filters(q):\n                sp = load_scratchpad()\n                lf = sp.get(\"last_filters\") if isinstance(sp, dict) else None\n                if isinstance(lf, dict):\n                    for k in (\"language\", \"under\", \"symbol\", \"ext\", \"path_glob\", \"not_glob\"):\n                        if k not in args and lf.get(k) not in (None, \"\"):\n                            args[k] = lf.get(k)\n        except Exception:\n            pass",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__looks_like_design_recap_213": {
      "name": "_looks_like_design_recap",
      "type": "function",
      "start_line": 213,
      "end_line": 215,
      "content_hash": "c2458bd94991cb10697970645ec7dbfcb8fa36f6",
      "content": "        def _looks_like_design_recap(s: str) -> bool:\n            low = s.lower()\n            return any(w in low for w in [\"recap\", \"design doc\", \"architecture\", \"adr\", \"retrospective\", \"postmortem\"]) and any(w in low for w in [\"design\", \"summary\", \"recap\", \"explain\"])",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}