{
  "file_path": "/work/internal/db/connect.go",
  "file_hash": "1c0756730bd3c45c6946f05cee41aa4fa070aedc",
  "updated_at": "2025-12-26T17:34:24.006226",
  "symbols": {
    "function_Connect_17": {
      "name": "Connect",
      "type": "function",
      "start_line": 17,
      "end_line": 64,
      "content_hash": "3af1eeeb500a28f0dea6683081479278ab11d39c",
      "content": "func Connect(ctx context.Context, dataDir string) (*sql.DB, error) {\n\tif dataDir == \"\" {\n\t\treturn nil, fmt.Errorf(\"data.dir is not set\")\n\t}\n\tdbPath := filepath.Join(dataDir, \"nexora.db\")\n\n\t// Set pragmas for better performance\n\tpragmas := []string{\n\t\t\"PRAGMA foreign_keys = ON;\",\n\t\t\"PRAGMA journal_mode = WAL;\",\n\t\t\"PRAGMA page_size = 4096;\",\n\t\t\"PRAGMA cache_size = -8000;\",\n\t\t\"PRAGMA synchronous = NORMAL;\",\n\t\t\"PRAGMA secure_delete = ON;\",\n\t}\n\n\tdb, err := driver.Open(dbPath, func(c *sqlite3.Conn) error {\n\t\tfor _, pragma := range pragmas {\n\t\t\tif err := c.Exec(pragma); err != nil {\n\t\t\t\treturn fmt.Errorf(\"failed to set pragma `%s`: %w\", pragma, err)\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to open database: %w\", err)\n\t}\n\n\t// Verify connection\n\tif err = db.PingContext(ctx); err != nil {\n\t\tdb.Close()\n\t\treturn nil, fmt.Errorf(\"failed to connect to database: %w\", err)\n\t}\n\n\tgoose.SetBaseFS(FS)\n\n\tif err := goose.SetDialect(\"sqlite3\"); err != nil {\n\t\tslog.Error(\"Failed to set dialect\", \"error\", err)\n\t\treturn nil, fmt.Errorf(\"failed to set dialect: %w\", err)\n\t}\n\n\tif err := goose.Up(db, \"migrations\"); err != nil {\n\t\tslog.Error(\"Failed to apply migrations\", \"error\", err)\n\t\treturn nil, fmt.Errorf(\"failed to apply migrations: %w\", err)\n\t}\n\n\treturn db, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}