{
  "file_path": "/work/external-deps/Context-Engine/tests/test_service_context_search.py",
  "file_hash": "266a582701f81ad3cdb8357ba2c069161d937936",
  "updated_at": "2025-12-26T17:34:21.580017",
  "symbols": {
    "class_FakePoint_8": {
      "name": "FakePoint",
      "type": "class",
      "start_line": 8,
      "end_line": 11,
      "content_hash": "1b992f53b2064193ddcd970c831e8d2c430602a8",
      "content": "class FakePoint:\n    def __init__(self, score, payload):\n        self.score = score\n        self.payload = payload",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___9": {
      "name": "__init__",
      "type": "method",
      "start_line": 9,
      "end_line": 11,
      "content_hash": "c666fdf5f2f587742dc56bd299fe74bcb1ce97c0",
      "content": "    def __init__(self, score, payload):\n        self.score = score\n        self.payload = payload",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_FakeQdrantMem_14": {
      "name": "FakeQdrantMem",
      "type": "class",
      "start_line": 14,
      "end_line": 22,
      "content_hash": "20745f2aec6bb2e743ce074e27dd57ebdd6bbfe8",
      "content": "class FakeQdrantMem:\n    def __init__(self, items):\n        self._items = items\n\n    def search(self, **kwargs):\n        return self._items\n\n    def scroll(self, **kwargs):\n        return (self._items, None)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___15": {
      "name": "__init__",
      "type": "method",
      "start_line": 15,
      "end_line": 16,
      "content_hash": "860476237949da61135245bfd22a65dc591c2266",
      "content": "    def __init__(self, items):\n        self._items = items",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_search_18": {
      "name": "search",
      "type": "method",
      "start_line": 18,
      "end_line": 19,
      "content_hash": "ab45cfc5caf546024311d8243a89f3b18ac9bab1",
      "content": "    def search(self, **kwargs):\n        return self._items",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_scroll_21": {
      "name": "scroll",
      "type": "method",
      "start_line": 21,
      "end_line": 22,
      "content_hash": "46adcecbe876017ae8aab29a1f6bc22ba4fe392b",
      "content": "    def scroll(self, **kwargs):\n        return (self._items, None)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_FakeEmbed_25": {
      "name": "FakeEmbed",
      "type": "class",
      "start_line": 25,
      "end_line": 33,
      "content_hash": "c890b9298807e0076e6f44163bc4dd5022d8bda7",
      "content": "class FakeEmbed:\n    class _Vec:\n        def tolist(self):\n            return [0.1] * 8\n\n    def embed(self, texts):\n        # return an iterator of vector-like objects with .tolist()\n        for _ in texts:\n            yield self._Vec()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class__Vec_26": {
      "name": "_Vec",
      "type": "class",
      "start_line": 26,
      "end_line": 28,
      "content_hash": "6c897e5d23a3919c7ecc855bcc5c7b9dd15a035b",
      "content": "    class _Vec:\n        def tolist(self):\n            return [0.1] * 8",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_tolist_27": {
      "name": "tolist",
      "type": "method",
      "start_line": 27,
      "end_line": 28,
      "content_hash": "b172862a6d8b3fca4b05469a86a96a2cbf47736d",
      "content": "        def tolist(self):\n            return [0.1] * 8",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_embed_30": {
      "name": "embed",
      "type": "method",
      "start_line": 30,
      "end_line": 33,
      "content_hash": "93c1e97fb2463d3931891dff874879b236a50244",
      "content": "    def embed(self, texts):\n        # return an iterator of vector-like objects with .tolist()\n        for _ in texts:\n            yield self._Vec()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_context_search_blend_compact_38": {
      "name": "test_context_search_blend_compact",
      "type": "function",
      "start_line": 38,
      "end_line": 77,
      "content_hash": "c9af763fa2d1218d34b246042cb601f4f60193b3",
      "content": "async def test_context_search_blend_compact(monkeypatch):\n    # repo_search returns two code hits (async stub)\n    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.8, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3},\n                {\"score\": 0.6, \"path\": \"/x/b.py\", \"start_line\": 5, \"end_line\": 9},\n            ]\n        }\n\n    monkeypatch.setattr(srv, \"repo_search\", fake_repo_search)\n    monkeypatch.setattr(srv, \"_get_embedding_model\", lambda *a, **k: FakeEmbed())\n\n    # Memory fallback via Qdrant: two memory-like points (no path in metadata)\n    mem_items = [\n        FakePoint(0.9, {\"content\": \"foo note one\", \"metadata\": {}}),\n        FakePoint(0.2, {\"content\": \"bar note two\", \"metadata\": {}}),\n    ]\n    import qdrant_client\n\n    monkeypatch.setattr(\n        qdrant_client, \"QdrantClient\", lambda *a, **k: FakeQdrantMem(mem_items)\n    )\n\n    res = await srv.context_search(\n        query=\"foo bar\",\n        limit=3,\n        per_path=1,\n        include_memories=True,\n        memory_weight=0.5,\n        compact=True,\n    )\n\n    assert \"results\" in res\n    # Compact shape: code entries have path+lines; memory entries have content only\n    for it in res[\"results\"]:\n        if it.get(\"source\") == \"code\":\n            assert \"path\" in it and \"start_line\" in it and \"end_line\" in it\n        else:\n            assert \"content\" in it and len(it[\"content\"]) > 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fake_repo_search_40": {
      "name": "fake_repo_search",
      "type": "function",
      "start_line": 40,
      "end_line": 46,
      "content_hash": "b20a3681d802274c52feb13ade37b549a5e29659",
      "content": "    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.8, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3},\n                {\"score\": 0.6, \"path\": \"/x/b.py\", \"start_line\": 5, \"end_line\": 9},\n            ]\n        }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_context_search_weight_scaling_82": {
      "name": "test_context_search_weight_scaling",
      "type": "function",
      "start_line": 82,
      "end_line": 144,
      "content_hash": "52aad91de526923bb971f269d42f1535b0768339",
      "content": "async def test_context_search_weight_scaling(monkeypatch):\n    # repo_search returns one code hit (async stub)\n    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.5, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3}\n            ]\n        }\n\n    monkeypatch.setattr(srv, \"repo_search\", fake_repo_search)\n\n    # Force SSE memory path with a fake FastMCP client\n    monkeypatch.setenv(\"MEMORY_SSE_ENABLED\", \"1\")\n\n    class T:\n        def __init__(self, name):\n            self.name = name\n\n    class Item:\n        def __init__(self, text):\n            self.text = text\n\n    class Resp:\n        def __init__(self):\n            self.content = [Item(\"foo note\")]\n\n    class FakeClient:\n        async def __aenter__(self):\n            return self\n\n        async def __aexit__(self, exc_type, exc, tb):\n            return False\n\n        async def list_tools(self):\n            return [T(\"find\")]\n\n        async def call_tool(self, *a, **k):\n            return Resp()\n\n    # Import fastmcp inside test to avoid module-level import conflicts\n    # Clear any broken mcp modules from sys.modules first\n    import sys\n    mcp_modules = [k for k in sys.modules.keys() if k == 'mcp' or k.startswith('mcp.')]\n    for mod in mcp_modules:\n        if mod in sys.modules and not hasattr(sys.modules.get(mod, object()), 'types'):\n            del sys.modules[mod]\n    import fastmcp\n    monkeypatch.setattr(fastmcp, \"Client\", lambda *a, **k: FakeClient())\n\n    res = await srv.context_search(\n        query=\"foo\",\n        limit=2,\n        per_path=1,\n        include_memories=True,\n        memory_weight=2.0,\n        compact=False,\n    )\n\n    mem_scores = [r[\"score\"] for r in res[\"results\"] if r.get(\"source\") == \"memory\"]\n    code_scores = [r[\"score\"] for r in res[\"results\"] if r.get(\"source\") == \"code\"]\n    assert mem_scores, \"expected at least one memory result\"\n    assert code_scores, \"expected at least one code result\"\n    assert max(mem_scores) > max(code_scores)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fake_repo_search_84": {
      "name": "fake_repo_search",
      "type": "function",
      "start_line": 84,
      "end_line": 89,
      "content_hash": "912200758b02c63cc869e6328a4e0a140a025b29",
      "content": "    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.5, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3}\n            ]\n        }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_T_96": {
      "name": "T",
      "type": "class",
      "start_line": 96,
      "end_line": 98,
      "content_hash": "55b6d086156cce06dfca872bc6a5c36ef2e94cf2",
      "content": "    class T:\n        def __init__(self, name):\n            self.name = name",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___97": {
      "name": "__init__",
      "type": "method",
      "start_line": 97,
      "end_line": 98,
      "content_hash": "0d576261baee3482552d9ef65361c6c627e724bc",
      "content": "        def __init__(self, name):\n            self.name = name",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_Item_100": {
      "name": "Item",
      "type": "class",
      "start_line": 100,
      "end_line": 102,
      "content_hash": "406d0bcc823f20668bdd710cc45d15b791d0ee6b",
      "content": "    class Item:\n        def __init__(self, text):\n            self.text = text",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___101": {
      "name": "__init__",
      "type": "method",
      "start_line": 101,
      "end_line": 102,
      "content_hash": "a5ac3a7cce0899e6072d25152a9c0e4a40ec7887",
      "content": "        def __init__(self, text):\n            self.text = text",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_Resp_104": {
      "name": "Resp",
      "type": "class",
      "start_line": 104,
      "end_line": 106,
      "content_hash": "0c763213e30263fb0fe0cafdce7f4c0520abd067",
      "content": "    class Resp:\n        def __init__(self):\n            self.content = [Item(\"foo note\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___105": {
      "name": "__init__",
      "type": "method",
      "start_line": 105,
      "end_line": 106,
      "content_hash": "2c144f13006c2966333f32a23b14482e60034276",
      "content": "        def __init__(self):\n            self.content = [Item(\"foo note\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_FakeClient_108": {
      "name": "FakeClient",
      "type": "class",
      "start_line": 108,
      "end_line": 119,
      "content_hash": "c869ea1b2a15e902c6016a26d79d1107e5f37785",
      "content": "    class FakeClient:\n        async def __aenter__(self):\n            return self\n\n        async def __aexit__(self, exc_type, exc, tb):\n            return False\n\n        async def list_tools(self):\n            return [T(\"find\")]\n\n        async def call_tool(self, *a, **k):\n            return Resp()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___aenter___109": {
      "name": "__aenter__",
      "type": "method",
      "start_line": 109,
      "end_line": 110,
      "content_hash": "aad37f487d495d041e97fde20996f960f8fba597",
      "content": "        async def __aenter__(self):\n            return self",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___aexit___112": {
      "name": "__aexit__",
      "type": "method",
      "start_line": 112,
      "end_line": 113,
      "content_hash": "498a14495a001ee14a0ef0c00be5a196554e6627",
      "content": "        async def __aexit__(self, exc_type, exc, tb):\n            return False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_list_tools_115": {
      "name": "list_tools",
      "type": "method",
      "start_line": 115,
      "end_line": 116,
      "content_hash": "2b6e1c715ea1afa6fbf85d57b4e9f96bbb600729",
      "content": "        async def list_tools(self):\n            return [T(\"find\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_call_tool_118": {
      "name": "call_tool",
      "type": "method",
      "start_line": 118,
      "end_line": 119,
      "content_hash": "49d1d3429a0b081728d6315a3ab3bc31b9c327e2",
      "content": "        async def call_tool(self, *a, **k):\n            return Resp()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_context_search_per_source_limits_149": {
      "name": "test_context_search_per_source_limits",
      "type": "function",
      "start_line": 149,
      "end_line": 214,
      "content_hash": "55f74a5993419dfd855a213532ca60e372b8091f",
      "content": "async def test_context_search_per_source_limits(monkeypatch):\n    # repo_search returns three code hits\n    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.9, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3},\n                {\"score\": 0.8, \"path\": \"/x/b.py\", \"start_line\": 4, \"end_line\": 6},\n                {\"score\": 0.7, \"path\": \"/x/c.py\", \"start_line\": 7, \"end_line\": 9},\n            ]\n        }\n\n    monkeypatch.setattr(srv, \"repo_search\", fake_repo_search)\n    monkeypatch.setattr(srv, \"_get_embedding_model\", lambda *a, **k: FakeEmbed())\n\n    # Drive memory hits via SSE path with a fake FastMCP client yielding 3 notes\n    monkeypatch.setenv(\"MEMORY_SSE_ENABLED\", \"1\")\n\n    class T:\n        def __init__(self, name):\n            self.name = name\n\n    class Item:\n        def __init__(self, text):\n            self.text = text\n\n    class Resp:\n        def __init__(self):\n            self.content = [Item(\"m1\"), Item(\"m2\"), Item(\"m3\")]\n\n    class FakeClient:\n        async def __aenter__(self):\n            return self\n\n        async def __aexit__(self, exc_type, exc, tb):\n            return False\n\n        async def list_tools(self):\n            return [T(\"find\")]\n\n        async def call_tool(self, *a, **k):\n            return Resp()\n\n    # Import fastmcp inside test to avoid module-level import conflicts\n    # Clear any broken mcp modules from sys.modules first\n    import sys\n    mcp_modules = [k for k in sys.modules.keys() if k == 'mcp' or k.startswith('mcp.')]\n    for mod in mcp_modules:\n        if mod in sys.modules and not hasattr(sys.modules.get(mod, object()), 'types'):\n            del sys.modules[mod]\n    import fastmcp\n    monkeypatch.setattr(fastmcp, \"Client\", lambda *a, **k: FakeClient())\n\n    res = await srv.context_search(\n        query=\"foo\",\n        limit=5,\n        per_path=1,\n        include_memories=True,\n        per_source_limits=json.dumps({\"code\": 1, \"memory\": 2}),\n        compact=True,\n    )\n\n    kinds = [r.get(\"source\") for r in res.get(\"results\", [])]\n    assert kinds.count(\"code\") <= 1\n    assert kinds.count(\"memory\") <= 2\n    # Ensure at least one of each (since both sources available)\n    assert \"code\" in kinds and \"memory\" in kinds",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fake_repo_search_151": {
      "name": "fake_repo_search",
      "type": "function",
      "start_line": 151,
      "end_line": 158,
      "content_hash": "acf91e47ad1254570db2cb789360da5d01cf2286",
      "content": "    async def fake_repo_search(**kwargs):\n        return {\n            \"results\": [\n                {\"score\": 0.9, \"path\": \"/x/a.py\", \"start_line\": 1, \"end_line\": 3},\n                {\"score\": 0.8, \"path\": \"/x/b.py\", \"start_line\": 4, \"end_line\": 6},\n                {\"score\": 0.7, \"path\": \"/x/c.py\", \"start_line\": 7, \"end_line\": 9},\n            ]\n        }",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_T_166": {
      "name": "T",
      "type": "class",
      "start_line": 166,
      "end_line": 168,
      "content_hash": "55b6d086156cce06dfca872bc6a5c36ef2e94cf2",
      "content": "    class T:\n        def __init__(self, name):\n            self.name = name",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___167": {
      "name": "__init__",
      "type": "method",
      "start_line": 167,
      "end_line": 168,
      "content_hash": "0d576261baee3482552d9ef65361c6c627e724bc",
      "content": "        def __init__(self, name):\n            self.name = name",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_Item_170": {
      "name": "Item",
      "type": "class",
      "start_line": 170,
      "end_line": 172,
      "content_hash": "406d0bcc823f20668bdd710cc45d15b791d0ee6b",
      "content": "    class Item:\n        def __init__(self, text):\n            self.text = text",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___171": {
      "name": "__init__",
      "type": "method",
      "start_line": 171,
      "end_line": 172,
      "content_hash": "a5ac3a7cce0899e6072d25152a9c0e4a40ec7887",
      "content": "        def __init__(self, text):\n            self.text = text",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_Resp_174": {
      "name": "Resp",
      "type": "class",
      "start_line": 174,
      "end_line": 176,
      "content_hash": "d33a4eec80974f0b162f1293419c78a907346c2e",
      "content": "    class Resp:\n        def __init__(self):\n            self.content = [Item(\"m1\"), Item(\"m2\"), Item(\"m3\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___init___175": {
      "name": "__init__",
      "type": "method",
      "start_line": 175,
      "end_line": 176,
      "content_hash": "9cee0376b566548e634e8f12e996520be36ff976",
      "content": "        def __init__(self):\n            self.content = [Item(\"m1\"), Item(\"m2\"), Item(\"m3\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "class_FakeClient_178": {
      "name": "FakeClient",
      "type": "class",
      "start_line": 178,
      "end_line": 189,
      "content_hash": "c869ea1b2a15e902c6016a26d79d1107e5f37785",
      "content": "    class FakeClient:\n        async def __aenter__(self):\n            return self\n\n        async def __aexit__(self, exc_type, exc, tb):\n            return False\n\n        async def list_tools(self):\n            return [T(\"find\")]\n\n        async def call_tool(self, *a, **k):\n            return Resp()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___aenter___179": {
      "name": "__aenter__",
      "type": "method",
      "start_line": 179,
      "end_line": 180,
      "content_hash": "aad37f487d495d041e97fde20996f960f8fba597",
      "content": "        async def __aenter__(self):\n            return self",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method___aexit___182": {
      "name": "__aexit__",
      "type": "method",
      "start_line": 182,
      "end_line": 183,
      "content_hash": "498a14495a001ee14a0ef0c00be5a196554e6627",
      "content": "        async def __aexit__(self, exc_type, exc, tb):\n            return False",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_list_tools_185": {
      "name": "list_tools",
      "type": "method",
      "start_line": 185,
      "end_line": 186,
      "content_hash": "2b6e1c715ea1afa6fbf85d57b4e9f96bbb600729",
      "content": "        async def list_tools(self):\n            return [T(\"find\")]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_call_tool_188": {
      "name": "call_tool",
      "type": "method",
      "start_line": 188,
      "end_line": 189,
      "content_hash": "49d1d3429a0b081728d6315a3ab3bc31b9c327e2",
      "content": "        async def call_tool(self, *a, **k):\n            return Resp()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}