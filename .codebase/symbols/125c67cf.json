{
  "file_path": "/work/internal/agent/tools/sourcegraph.go",
  "file_hash": "515e3d5aab0a31570df67050bb1bf08a490f0a70",
  "updated_at": "2025-12-26T17:34:21.538487",
  "symbols": {
    "struct_SourcegraphParams_17": {
      "name": "SourcegraphParams",
      "type": "struct",
      "start_line": 17,
      "end_line": 23,
      "content_hash": "78ea8cd818856d64af42e8a5079161dcf29be00a",
      "content": "type SourcegraphParams struct {\n\tQuery         string `json:\"query\" description:\"The Sourcegraph search query\"`\n\tCount         int    `json:\"count,omitempty\" description:\"Optional number of results to return (default: 10, max: 20)\"`\n\tContextWindow int    `json:\"context_window,omitempty\" description:\"The context around the match to return (default: 10 lines)\"`\n\tTimeout       int    `json:\"timeout,omitempty\" description:\"Optional timeout in seconds (max 120)\"`\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_SourcegraphResponseMetadata_24": {
      "name": "SourcegraphResponseMetadata",
      "type": "struct",
      "start_line": 24,
      "end_line": 33,
      "content_hash": "d2e7d5403a353339f0a842dc9c62ed4ec900bb03",
      "content": "type SourcegraphResponseMetadata struct {\n\tNumberOfMatches int  `json:\"number_of_matches\"`\n\tTruncated       bool `json:\"truncated\"`\n}\n\nconst SourcegraphToolName = \"sourcegraph\"\n\n//go:embed sourcegraph.md\nvar sourcegraphDescription []byte\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewSourcegraphTool_34": {
      "name": "NewSourcegraphTool",
      "type": "function",
      "start_line": 34,
      "end_line": 74,
      "content_hash": "7fbdc20a7cc24075a6a7a65a1fdb5298fcf438e4",
      "content": "func NewSourcegraphTool(client *http.Client) fantasy.AgentTool {\n\tif client == nil {\n\t\tclient = &http.Client{\n\t\t\tTimeout: 30 * time.Second,\n\t\t\tTransport: &http.Transport{\n\t\t\t\tMaxIdleConns:        100,\n\t\t\t\tMaxIdleConnsPerHost: 10,\n\t\t\t\tIdleConnTimeout:     90 * time.Second,\n\t\t\t},\n\t\t}\n\t}\n\treturn fantasy.NewParallelAgentTool(\n\t\tSourcegraphToolName,\n\t\tstring(sourcegraphDescription),\n\t\tfunc(ctx context.Context, params SourcegraphParams, call fantasy.ToolCall) (fantasy.ToolResponse, error) {\n\t\t\tif params.Query == \"\" {\n\t\t\t\treturn fantasy.NewTextErrorResponse(\"Query parameter is required\"), nil\n\t\t\t}\n\n\t\t\tif params.Count <= 0 {\n\t\t\t\tparams.Count = 10\n\t\t\t} else if params.Count > 20 {\n\t\t\t\tparams.Count = 20 // Limit to 20 results\n\t\t\t}\n\n\t\t\tif params.ContextWindow <= 0 {\n\t\t\t\tparams.ContextWindow = 10 // Default context window\n\t\t\t}\n\n\t\t\t// Handle timeout with context\n\t\t\trequestCtx := ctx\n\t\t\tif params.Timeout > 0 {\n\t\t\t\tmaxTimeout := 120 // 2 minutes\n\t\t\t\tif params.Timeout > maxTimeout {\n\t\t\t\t\tparams.Timeout = maxTimeout\n\t\t\t\t}\n\t\t\t\tvar cancel context.CancelFunc\n\t\t\t\trequestCtx, cancel = context.WithTimeout(ctx, time.Duration(params.Timeout)*time.Second)\n\t\t\t\tdefer cancel()\n\t\t\t}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_graphqlRequest_75": {
      "name": "graphqlRequest",
      "type": "struct",
      "start_line": 75,
      "end_line": 138,
      "content_hash": "e4da5c851de6cd6fde9b1e0281f79a4b8c34d527",
      "content": "\t\t\ttype graphqlRequest struct {\n\t\t\t\tQuery     string `json:\"query\"`\n\t\t\t\tVariables struct {\n\t\t\t\t\tQuery string `json:\"query\"`\n\t\t\t\t} `json:\"variables\"`\n\t\t\t}\n\n\t\t\trequest := graphqlRequest{\n\t\t\t\tQuery: \"query Search($query: String!) { search(query: $query, version: V2, patternType: keyword ) { results { matchCount, limitHit, resultCount, approximateResultCount, missing { name }, timedout { name }, indexUnavailable, results { __typename, ... on FileMatch { repository { name }, file { path, url, content }, lineMatches { preview, lineNumber, offsetAndLengths } } } } } }\",\n\t\t\t}\n\t\t\trequest.Variables.Query = params.Query\n\n\t\t\tgraphqlQueryBytes, err := json.Marshal(request)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"failed to marshal GraphQL request: %w\", err)\n\t\t\t}\n\t\t\tgraphqlQuery := string(graphqlQueryBytes)\n\n\t\t\treq, err := http.NewRequestWithContext(\n\t\t\t\trequestCtx,\n\t\t\t\t\"POST\",\n\t\t\t\t\"https://sourcegraph.com/.api/graphql\",\n\t\t\t\tbytes.NewBuffer([]byte(graphqlQuery)),\n\t\t\t)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"failed to create request: %w\", err)\n\t\t\t}\n\n\t\t\treq.Header.Set(\"Content-Type\", \"application/json\")\n\t\t\treq.Header.Set(\"User-Agent\", \"nexora/1.0\")\n\n\t\t\tresp, err := client.Do(req)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"failed to fetch URL: %w\", err)\n\t\t\t}\n\t\t\tdefer resp.Body.Close()\n\n\t\t\tif resp.StatusCode != http.StatusOK {\n\t\t\t\tbody, _ := io.ReadAll(resp.Body)\n\t\t\t\tif len(body) > 0 {\n\t\t\t\t\treturn fantasy.NewTextErrorResponse(fmt.Sprintf(\"Request failed with status code: %d, response: %s\", resp.StatusCode, string(body))), nil\n\t\t\t\t}\n\n\t\t\t\treturn fantasy.NewTextErrorResponse(fmt.Sprintf(\"Request failed with status code: %d\", resp.StatusCode)), nil\n\t\t\t}\n\t\t\tbody, err := io.ReadAll(resp.Body)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"failed to read response body: %w\", err)\n\t\t\t}\n\n\t\t\tvar result map[string]any\n\t\t\tif err = json.Unmarshal(body, &result); err != nil {\n\t\t\t\treturn fantasy.ToolResponse{}, fmt.Errorf(\"failed to unmarshal response: %w\", err)\n\t\t\t}\n\n\t\t\tformattedResults, err := formatSourcegraphResults(result, params.ContextWindow)\n\t\t\tif err != nil {\n\t\t\t\treturn fantasy.NewTextErrorResponse(\"Failed to format results: \" + err.Error()), nil\n\t\t\t}\n\n\t\t\treturn fantasy.NewTextResponse(formattedResults), nil\n\t\t})\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_formatSourcegraphResults_139": {
      "name": "formatSourcegraphResults",
      "type": "function",
      "start_line": 139,
      "end_line": 267,
      "content_hash": "882273f95969bc3dccca6259466d0cb2ea509a74",
      "content": "func formatSourcegraphResults(result map[string]any, contextWindow int) (string, error) {\n\tvar buffer strings.Builder\n\n\tif errors, ok := result[\"errors\"].([]any); ok && len(errors) > 0 {\n\t\tbuffer.WriteString(\"## Sourcegraph API Error\\n\\n\")\n\t\tfor _, err := range errors {\n\t\t\tif errMap, ok := err.(map[string]any); ok {\n\t\t\t\tif message, ok := errMap[\"message\"].(string); ok {\n\t\t\t\t\tbuffer.WriteString(fmt.Sprintf(\"- %s\\n\", message))\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn buffer.String(), nil\n\t}\n\n\tdata, ok := result[\"data\"].(map[string]any)\n\tif !ok {\n\t\treturn \"\", fmt.Errorf(\"invalid response format: missing data field\")\n\t}\n\n\tsearch, ok := data[\"search\"].(map[string]any)\n\tif !ok {\n\t\treturn \"\", fmt.Errorf(\"invalid response format: missing search field\")\n\t}\n\n\tsearchResults, ok := search[\"results\"].(map[string]any)\n\tif !ok {\n\t\treturn \"\", fmt.Errorf(\"invalid response format: missing results field\")\n\t}\n\n\tmatchCount, _ := searchResults[\"matchCount\"].(float64)\n\tresultCount, _ := searchResults[\"resultCount\"].(float64)\n\tlimitHit, _ := searchResults[\"limitHit\"].(bool)\n\n\tbuffer.WriteString(\"# Sourcegraph Search Results\\n\\n\")\n\tbuffer.WriteString(fmt.Sprintf(\"Found %d matches across %d results\\n\", int(matchCount), int(resultCount)))\n\n\tif limitHit {\n\t\tbuffer.WriteString(\"(Result limit reached, try a more specific query)\\n\")\n\t}\n\n\tbuffer.WriteString(\"\\n\")\n\n\tresults, ok := searchResults[\"results\"].([]any)\n\tif !ok || len(results) == 0 {\n\t\tbuffer.WriteString(\"No results found. Try a different query.\\n\")\n\t\treturn buffer.String(), nil\n\t}\n\n\tmaxResults := 10\n\tif len(results) > maxResults {\n\t\tresults = results[:maxResults]\n\t}\n\n\tfor i, res := range results {\n\t\tfileMatch, ok := res.(map[string]any)\n\t\tif !ok {\n\t\t\tcontinue\n\t\t}\n\n\t\ttypeName, _ := fileMatch[\"__typename\"].(string)\n\t\tif typeName != \"FileMatch\" {\n\t\t\tcontinue\n\t\t}\n\n\t\trepo, _ := fileMatch[\"repository\"].(map[string]any)\n\t\tfile, _ := fileMatch[\"file\"].(map[string]any)\n\t\tlineMatches, _ := fileMatch[\"lineMatches\"].([]any)\n\n\t\tif repo == nil || file == nil {\n\t\t\tcontinue\n\t\t}\n\n\t\trepoName, _ := repo[\"name\"].(string)\n\t\tfilePath, _ := file[\"path\"].(string)\n\t\tfileURL, _ := file[\"url\"].(string)\n\t\tfileContent, _ := file[\"content\"].(string)\n\n\t\tbuffer.WriteString(fmt.Sprintf(\"## Result %d: %s/%s\\n\\n\", i+1, repoName, filePath))\n\n\t\tif fileURL != \"\" {\n\t\t\tbuffer.WriteString(fmt.Sprintf(\"URL: %s\\n\\n\", fileURL))\n\t\t}\n\n\t\tif len(lineMatches) > 0 {\n\t\t\tfor _, lm := range lineMatches {\n\t\t\t\tlineMatch, ok := lm.(map[string]any)\n\t\t\t\tif !ok {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tlineNumber, _ := lineMatch[\"lineNumber\"].(float64)\n\t\t\t\tpreview, _ := lineMatch[\"preview\"].(string)\n\n\t\t\t\tif fileContent != \"\" {\n\t\t\t\t\tlines := strings.Split(fileContent, \"\\n\")\n\n\t\t\t\t\tbuffer.WriteString(\"```\\n\")\n\n\t\t\t\t\tstartLine := max(1, int(lineNumber)-contextWindow)\n\n\t\t\t\t\tfor j := startLine - 1; j < int(lineNumber)-1 && j < len(lines); j++ {\n\t\t\t\t\t\tif j >= 0 {\n\t\t\t\t\t\t\tbuffer.WriteString(fmt.Sprintf(\"%d| %s\\n\", j+1, lines[j]))\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tbuffer.WriteString(fmt.Sprintf(\"%d|  %s\\n\", int(lineNumber), preview))\n\n\t\t\t\t\tendLine := int(lineNumber) + contextWindow\n\n\t\t\t\t\tfor j := int(lineNumber); j < endLine && j < len(lines); j++ {\n\t\t\t\t\t\tif j < len(lines) {\n\t\t\t\t\t\t\tbuffer.WriteString(fmt.Sprintf(\"%d| %s\\n\", j+1, lines[j]))\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tbuffer.WriteString(\"```\\n\\n\")\n\t\t\t\t} else {\n\t\t\t\t\tbuffer.WriteString(\"```\\n\")\n\t\t\t\t\tbuffer.WriteString(fmt.Sprintf(\"%d| %s\\n\", int(lineNumber), preview))\n\t\t\t\t\tbuffer.WriteString(\"```\\n\\n\")\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn buffer.String(), nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}