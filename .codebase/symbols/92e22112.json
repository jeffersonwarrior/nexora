{
  "file_path": "/work/external-deps/claude-mem/plugin/scripts/smart-install.js",
  "file_hash": "ba539c5fabcd14b6727a4b6af16a1afa075abfee",
  "updated_at": "2025-12-26T17:34:21.832934",
  "symbols": {
    "function_isBunInstalled_20": {
      "name": "isBunInstalled",
      "type": "function",
      "start_line": 20,
      "end_line": 38,
      "content_hash": "4a5015f0a5963d2f8434a6c5aeec95a2d548dd63",
      "content": "function isBunInstalled() {\n  try {\n    const result = spawnSync('bun', ['--version'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: IS_WINDOWS\n    });\n    if (result.status === 0) return true;\n  } catch {\n    // PATH check failed, try common installation paths\n  }\n\n  // Check common installation paths (handles fresh installs before PATH reload)\n  const bunPaths = IS_WINDOWS\n    ? [join(homedir(), '.bun', 'bin', 'bun.exe')]\n    : [join(homedir(), '.bun', 'bin', 'bun'), '/usr/local/bin/bun'];\n\n  return bunPaths.some(existsSync);\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_getBunPath_43": {
      "name": "getBunPath",
      "type": "function",
      "start_line": 43,
      "end_line": 66,
      "content_hash": "1eff1fb133e9b057f74ba5df2b1bc93b35421fa4",
      "content": "function getBunPath() {\n  // Try PATH first\n  try {\n    const result = spawnSync('bun', ['--version'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: IS_WINDOWS\n    });\n    if (result.status === 0) return 'bun';\n  } catch {\n    // Not in PATH\n  }\n\n  // Check common installation paths\n  const bunPaths = IS_WINDOWS\n    ? [join(homedir(), '.bun', 'bin', 'bun.exe')]\n    : [join(homedir(), '.bun', 'bin', 'bun'), '/usr/local/bin/bun'];\n\n  for (const bunPath of bunPaths) {\n    if (existsSync(bunPath)) return bunPath;\n  }\n\n  return null;\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_getBunVersion_71": {
      "name": "getBunVersion",
      "type": "function",
      "start_line": 71,
      "end_line": 85,
      "content_hash": "3f0d22c38d58c85924fecf1f75311809976d4e2f",
      "content": "function getBunVersion() {\n  const bunPath = getBunPath();\n  if (!bunPath) return null;\n\n  try {\n    const result = spawnSync(bunPath, ['--version'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: IS_WINDOWS\n    });\n    return result.status === 0 ? result.stdout.trim() : null;\n  } catch {\n    return null;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_isUvInstalled_90": {
      "name": "isUvInstalled",
      "type": "function",
      "start_line": 90,
      "end_line": 108,
      "content_hash": "2897b3a97ec1f6749cb80d5c1e07646edcb9e2b7",
      "content": "function isUvInstalled() {\n  try {\n    const result = spawnSync('uv', ['--version'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: IS_WINDOWS\n    });\n    if (result.status === 0) return true;\n  } catch {\n    // PATH check failed, try common installation paths\n  }\n\n  // Check common installation paths (handles fresh installs before PATH reload)\n  const uvPaths = IS_WINDOWS\n    ? [join(homedir(), '.local', 'bin', 'uv.exe'), join(homedir(), '.cargo', 'bin', 'uv.exe')]\n    : [join(homedir(), '.local', 'bin', 'uv'), join(homedir(), '.cargo', 'bin', 'uv'), '/usr/local/bin/uv'];\n\n  return uvPaths.some(existsSync);\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_getUvVersion_113": {
      "name": "getUvVersion",
      "type": "function",
      "start_line": 113,
      "end_line": 124,
      "content_hash": "9db606db1a5ca7e0e7cbacaea513092b1eaf1be8",
      "content": "function getUvVersion() {\n  try {\n    const result = spawnSync('uv', ['--version'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: IS_WINDOWS\n    });\n    return result.status === 0 ? result.stdout.trim() : null;\n  } catch {\n    return null;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_installBun_129": {
      "name": "installBun",
      "type": "function",
      "start_line": 129,
      "end_line": 189,
      "content_hash": "7309b54c19ea2dc0a80d776ee2eb1e4f9760602f",
      "content": "function installBun() {\n  console.error('\ud83d\udd27 Bun not found. Installing Bun runtime...');\n\n  try {\n    if (IS_WINDOWS) {\n      // Windows: Use PowerShell installer\n      console.error('   Installing via PowerShell...');\n      execSync('powershell -c \"irm bun.sh/install.ps1 | iex\"', {\n        stdio: 'inherit',\n        shell: true\n      });\n    } else {\n      // Unix/macOS: Use curl installer\n      console.error('   Installing via curl...');\n      execSync('curl -fsSL https://bun.sh/install | bash', {\n        stdio: 'inherit',\n        shell: true\n      });\n    }\n\n    // Verify installation\n    if (isBunInstalled()) {\n      const version = getBunVersion();\n      console.error(`\u2705 Bun ${version} installed successfully`);\n      return true;\n    } else {\n      // Bun may be installed but not in PATH yet for this session\n      // Try common installation paths\n      const bunPaths = IS_WINDOWS\n        ? [join(homedir(), '.bun', 'bin', 'bun.exe')]\n        : [join(homedir(), '.bun', 'bin', 'bun'), '/usr/local/bin/bun'];\n\n      for (const bunPath of bunPaths) {\n        if (existsSync(bunPath)) {\n          console.error(`\u2705 Bun installed at ${bunPath}`);\n          console.error('\u26a0\ufe0f  Please restart your terminal or add Bun to PATH:');\n          if (IS_WINDOWS) {\n            console.error(`   $env:Path += \";${join(homedir(), '.bun', 'bin')}\"`);\n          } else {\n            console.error(`   export PATH=\"$HOME/.bun/bin:$PATH\"`);\n          }\n          return true;\n        }\n      }\n\n      throw new Error('Bun installation completed but binary not found');\n    }\n  } catch (error) {\n    console.error('\u274c Failed to install Bun automatically');\n    console.error('   Please install manually:');\n    if (IS_WINDOWS) {\n      console.error('   - winget install Oven-sh.Bun');\n      console.error('   - Or: powershell -c \"irm bun.sh/install.ps1 | iex\"');\n    } else {\n      console.error('   - curl -fsSL https://bun.sh/install | bash');\n      console.error('   - Or: brew install oven-sh/bun/bun');\n    }\n    console.error('   Then restart your terminal and try again.');\n    throw error;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_installUv_194": {
      "name": "installUv",
      "type": "function",
      "start_line": 194,
      "end_line": 254,
      "content_hash": "34cb486636e610935337719eabb7b4e2a346ce82",
      "content": "function installUv() {\n  console.error('\ud83d\udc0d Installing uv for Python/Chroma support...');\n\n  try {\n    if (IS_WINDOWS) {\n      // Windows: Use PowerShell installer\n      console.error('   Installing via PowerShell...');\n      execSync('powershell -ExecutionPolicy ByPass -c \"irm https://astral.sh/uv/install.ps1 | iex\"', {\n        stdio: 'inherit',\n        shell: true\n      });\n    } else {\n      // Unix/macOS: Use curl installer\n      console.error('   Installing via curl...');\n      execSync('curl -LsSf https://astral.sh/uv/install.sh | sh', {\n        stdio: 'inherit',\n        shell: true\n      });\n    }\n\n    // Verify installation\n    if (isUvInstalled()) {\n      const version = getUvVersion();\n      console.error(`\u2705 uv ${version} installed successfully`);\n      return true;\n    } else {\n      // uv may be installed but not in PATH yet for this session\n      // Try common installation paths\n      const uvPaths = IS_WINDOWS\n        ? [join(homedir(), '.local', 'bin', 'uv.exe'), join(homedir(), '.cargo', 'bin', 'uv.exe')]\n        : [join(homedir(), '.local', 'bin', 'uv'), join(homedir(), '.cargo', 'bin', 'uv'), '/usr/local/bin/uv'];\n\n      for (const uvPath of uvPaths) {\n        if (existsSync(uvPath)) {\n          console.error(`\u2705 uv installed at ${uvPath}`);\n          console.error('\u26a0\ufe0f  Please restart your terminal or add uv to PATH:');\n          if (IS_WINDOWS) {\n            console.error(`   $env:Path += \";${join(homedir(), '.local', 'bin')}\"`);\n          } else {\n            console.error(`   export PATH=\"$HOME/.local/bin:$PATH\"`);\n          }\n          return true;\n        }\n      }\n\n      throw new Error('uv installation completed but binary not found');\n    }\n  } catch (error) {\n    console.error('\u274c Failed to install uv automatically');\n    console.error('   Please install manually:');\n    if (IS_WINDOWS) {\n      console.error('   - winget install astral-sh.uv');\n      console.error('   - Or: powershell -c \"irm https://astral.sh/uv/install.ps1 | iex\"');\n    } else {\n      console.error('   - curl -LsSf https://astral.sh/uv/install.sh | sh');\n      console.error('   - Or: brew install uv (macOS)');\n    }\n    console.error('   Then restart your terminal and try again.');\n    throw error;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_installCLI_260": {
      "name": "installCLI",
      "type": "function",
      "start_line": 260,
      "end_line": 345,
      "content_hash": "578e1e895a882334a0a185eb2c13190c731201b3",
      "content": "function installCLI() {\n  const CLI_NAME = 'claude-mem';\n  const WORKER_CLI = join(ROOT, 'plugin', 'scripts', 'worker-cli.js');\n\n  if (IS_WINDOWS) {\n    // Windows: Create .cmd file in LocalAppData\n    const cliDir = join(process.env.LOCALAPPDATA || join(homedir(), 'AppData', 'Local'), 'Programs', 'claude-mem');\n    const cliPath = join(cliDir, `${CLI_NAME}.cmd`);\n    const markerPath = join(cliDir, '.cli-installed');\n\n    // Skip if already installed\n    if (existsSync(markerPath)) return;\n\n    try {\n      // Create directory if needed\n      if (!existsSync(cliDir)) {\n        execSync(`mkdir \"${cliDir}\"`, { stdio: 'ignore', shell: true });\n      }\n\n      // Get Bun path for the wrapper\n      const bunPath = getBunPath() || 'bun';\n\n      // Create the wrapper script\n      const cmdContent = `@echo off\n\"${bunPath}\" \"${WORKER_CLI}\" %*\n`;\n      writeFileSync(cliPath, cmdContent);\n      writeFileSync(markerPath, new Date().toISOString());\n\n      console.error(`\u2705 CLI installed: ${cliPath}`);\n      console.error('');\n      console.error('\ud83d\udccb Add to PATH (run once in PowerShell as Admin):');\n      console.error(`   [Environment]::SetEnvironmentVariable(\"Path\", $env:Path + \";${cliDir}\", \"User\")`);\n      console.error('');\n      console.error('   Then restart your terminal and use: claude-mem start|stop|restart|status');\n    } catch (error) {\n      console.error(`\u26a0\ufe0f  Could not install CLI: ${error.message}`);\n      console.error(`   You can still use: bun \"${WORKER_CLI}\" <command>`);\n    }\n  } else {\n    // Unix: Create shell script in ~/.local/bin\n    const cliDir = join(homedir(), '.local', 'bin');\n    const cliPath = join(cliDir, CLI_NAME);\n    const markerPath = join(ROOT, '.cli-installed');\n\n    // Skip if already installed\n    if (existsSync(markerPath) && existsSync(cliPath)) return;\n\n    try {\n      // Create directory if needed\n      if (!existsSync(cliDir)) {\n        execSync(`mkdir -p \"${cliDir}\"`, { stdio: 'ignore', shell: true });\n      }\n\n      // Get Bun path for the wrapper\n      const bunPath = getBunPath() || 'bun';\n\n      // Create the wrapper script\n      const shContent = `#!/usr/bin/env bash\n# claude-mem CLI wrapper - manages the worker service\nexec \"${bunPath}\" \"${WORKER_CLI}\" \"$@\"\n`;\n      writeFileSync(cliPath, shContent, { mode: 0o755 });\n      writeFileSync(markerPath, new Date().toISOString());\n\n      console.error(`\u2705 CLI installed: ${cliPath}`);\n\n      // Check if ~/.local/bin is in PATH\n      const pathDirs = (process.env.PATH || '').split(':');\n      const localBinInPath = pathDirs.some(p => p === cliDir || p === '$HOME/.local/bin' || p.endsWith('/.local/bin'));\n\n      if (!localBinInPath) {\n        console.error('');\n        console.error('\ud83d\udccb Add to PATH (add to ~/.bashrc or ~/.zshrc):');\n        console.error('   export PATH=\"$HOME/.local/bin:$PATH\"');\n        console.error('');\n        console.error('   Then restart your terminal and use: claude-mem start|stop|restart|status');\n      } else {\n        console.error('   Usage: claude-mem start|stop|restart|status');\n      }\n    } catch (error) {\n      console.error(`\u26a0\ufe0f  Could not install CLI: ${error.message}`);\n      console.error(`   You can still use: bun \"${WORKER_CLI}\" <command>`);\n    }\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_needsInstall_350": {
      "name": "needsInstall",
      "type": "function",
      "start_line": 350,
      "end_line": 359,
      "content_hash": "a7718dec7ef7ff877df9e78d54bbff3ed8113748",
      "content": "function needsInstall() {\n  if (!existsSync(join(ROOT, 'node_modules'))) return true;\n  try {\n    const pkg = JSON.parse(readFileSync(join(ROOT, 'package.json'), 'utf-8'));\n    const marker = JSON.parse(readFileSync(MARKER, 'utf-8'));\n    return pkg.version !== marker.version || getBunVersion() !== marker.bun;\n  } catch {\n    return true;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_installDeps_368": {
      "name": "installDeps",
      "type": "function",
      "start_line": 368,
      "end_line": 412,
      "content_hash": "ee42b45530dbe78b3749239bef6464888388d280",
      "content": "function installDeps() {\n  const bunPath = getBunPath();\n  if (!bunPath) {\n    throw new Error('Bun executable not found');\n  }\n\n  console.error('\ud83d\udce6 Installing dependencies with Bun...');\n\n  // Quote path for Windows paths with spaces\n  const bunCmd = IS_WINDOWS && bunPath.includes(' ') ? `\"${bunPath}\"` : bunPath;\n\n  let bunSucceeded = false;\n  try {\n    execSync(`${bunCmd} install`, { cwd: ROOT, stdio: 'inherit', shell: IS_WINDOWS });\n    bunSucceeded = true;\n  } catch {\n    // First attempt failed, try with force flag\n    try {\n      execSync(`${bunCmd} install --force`, { cwd: ROOT, stdio: 'inherit', shell: IS_WINDOWS });\n      bunSucceeded = true;\n    } catch {\n      // Bun failed completely, will try npm fallback\n    }\n  }\n\n  // Fallback to npm if bun failed (handles npm alias packages correctly)\n  if (!bunSucceeded) {\n    console.error('\u26a0\ufe0f  Bun install failed, falling back to npm...');\n    console.error('   (This can happen with npm alias packages like *-cjs)');\n    try {\n      execSync('npm install', { cwd: ROOT, stdio: 'inherit', shell: IS_WINDOWS });\n    } catch (npmError) {\n      throw new Error('Both bun and npm install failed: ' + npmError.message);\n    }\n  }\n\n  // Write version marker\n  const pkg = JSON.parse(readFileSync(join(ROOT, 'package.json'), 'utf-8'));\n  writeFileSync(MARKER, JSON.stringify({\n    version: pkg.version,\n    bun: getBunVersion(),\n    uv: getUvVersion(),\n    installedAt: new Date().toISOString()\n  }));\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}