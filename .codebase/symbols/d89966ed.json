{
  "file_path": "/work/external-deps/claude-mem/src/services/worker/http/middleware.ts",
  "file_hash": "6c9b6fdb7a87df259480d2f8e29177775838656d",
  "updated_at": "2025-12-26T17:34:22.361163",
  "symbols": {
    "function_createMiddleware_19": {
      "name": "createMiddleware",
      "type": "function",
      "start_line": 19,
      "end_line": 63,
      "content_hash": "46d68fb62f0031234f9fba4ca292a8a339c96e60",
      "content": "export function createMiddleware(\n  summarizeRequestBody: (method: string, path: string, body: any) => string\n): RequestHandler[] {\n  const middlewares: RequestHandler[] = [];\n\n  // JSON parsing with 50mb limit\n  middlewares.push(express.json({ limit: '50mb' }));\n\n  // CORS\n  middlewares.push(cors());\n\n  // HTTP request/response logging\n  middlewares.push((req: Request, res: Response, next: NextFunction) => {\n    // Skip logging for static assets and health checks\n    const staticExtensions = ['.html', '.js', '.css', '.svg', '.png', '.jpg', '.jpeg', '.webp', '.woff', '.woff2', '.ttf', '.eot'];\n    const isStaticAsset = staticExtensions.some(ext => req.path.endsWith(ext));\n    if (req.path.startsWith('/health') || req.path === '/' || isStaticAsset) {\n      return next();\n    }\n\n    const start = Date.now();\n    const requestId = `${req.method}-${Date.now()}`;\n\n    // Log incoming request with body summary\n    const bodySummary = summarizeRequestBody(req.method, req.path, req.body);\n    logger.info('HTTP', `\u2192 ${req.method} ${req.path}`, { requestId }, bodySummary);\n\n    // Capture response\n    const originalSend = res.send.bind(res);\n    res.send = function(body: any) {\n      const duration = Date.now() - start;\n      logger.info('HTTP', `\u2190 ${res.statusCode} ${req.path}`, { requestId, duration: `${duration}ms` });\n      return originalSend(body);\n    };\n\n    next();\n  });\n\n  // Serve static files for web UI (viewer-bundle.js, logos, fonts, etc.)\n  const packageRoot = getPackageRoot();\n  const uiDir = path.join(packageRoot, 'plugin', 'ui');\n  middlewares.push(express.static(uiDir));\n\n  return middlewares;\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_requireLocalhost_69": {
      "name": "requireLocalhost",
      "type": "function",
      "start_line": 69,
      "end_line": 91,
      "content_hash": "40ffe849bd75c28c458261132dd62dd7ca16119f",
      "content": "export function requireLocalhost(req: Request, res: Response, next: NextFunction): void {\n  const clientIp = req.ip || req.connection.remoteAddress || '';\n  const isLocalhost =\n    clientIp === '127.0.0.1' ||\n    clientIp === '::1' ||\n    clientIp === '::ffff:127.0.0.1' ||\n    clientIp === 'localhost';\n\n  if (!isLocalhost) {\n    logger.warn('SECURITY', 'Admin endpoint access denied - not localhost', {\n      endpoint: req.path,\n      clientIp,\n      method: req.method\n    });\n    res.status(403).json({\n      error: 'Forbidden',\n      message: 'Admin endpoints are only accessible from localhost'\n    });\n    return;\n  }\n\n  next();\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_summarizeRequestBody_97": {
      "name": "summarizeRequestBody",
      "type": "function",
      "start_line": 97,
      "end_line": 119,
      "content_hash": "a8b5a6082ed67230ba5a5e246fafc9bd0ef1b96d",
      "content": "export function summarizeRequestBody(method: string, path: string, body: any): string {\n  if (!body || Object.keys(body).length === 0) return '';\n\n  // Session init\n  if (path.includes('/init')) {\n    return '';\n  }\n\n  // Observations\n  if (path.includes('/observations')) {\n    const toolName = body.tool_name || '?';\n    const toolInput = body.tool_input;\n    const toolSummary = logger.formatTool(toolName, toolInput);\n    return `tool=${toolSummary}`;\n  }\n\n  // Summarize request\n  if (path.includes('/summarize')) {\n    return 'requesting summary';\n  }\n\n  return '';\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}