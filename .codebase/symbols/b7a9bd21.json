{
  "file_path": "/work/internal/message/message.go",
  "file_hash": "ae2b05eff1708482109a57e6f22ab0e180e55e80",
  "updated_at": "2025-12-26T17:34:20.984640",
  "symbols": {
    "struct_CreateMessageParams_15": {
      "name": "CreateMessageParams",
      "type": "struct",
      "start_line": 15,
      "end_line": 22,
      "content_hash": "4881b0697c2ffc7ba1aad854bcb881ddf185119f",
      "content": "type CreateMessageParams struct {\n\tRole             MessageRole\n\tParts            []ContentPart\n\tModel            string\n\tProvider         string\n\tIsSummaryMessage bool\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "interface_Service_23": {
      "name": "Service",
      "type": "interface",
      "start_line": 23,
      "end_line": 32,
      "content_hash": "49aa2ff4de719b67b57fb0906b70fc9b11449b33",
      "content": "type Service interface {\n\tpubsub.Suscriber[Message]\n\tCreate(ctx context.Context, sessionID string, params CreateMessageParams) (Message, error)\n\tUpdate(ctx context.Context, message Message) error\n\tGet(ctx context.Context, id string) (Message, error)\n\tList(ctx context.Context, sessionID string) ([]Message, error)\n\tDelete(ctx context.Context, id string) error\n\tDeleteSessionMessages(ctx context.Context, sessionID string) error\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_service_33": {
      "name": "service",
      "type": "struct",
      "start_line": 33,
      "end_line": 37,
      "content_hash": "caaf92df2ea0488df633d3d006f634dfc05ee9f3",
      "content": "type service struct {\n\t*pubsub.Broker[Message]\n\tq db.Querier\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewService_38": {
      "name": "NewService",
      "type": "function",
      "start_line": 38,
      "end_line": 44,
      "content_hash": "7e9f5570a97859082407554471fa7db991fa70d6",
      "content": "func NewService(q db.Querier) Service {\n\treturn &service{\n\t\tBroker: pubsub.NewBroker[Message](),\n\t\tq:      q,\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Delete_45": {
      "name": "Delete",
      "type": "method",
      "start_line": 45,
      "end_line": 57,
      "content_hash": "879fb685b699adfb0f677cdc0bdd6ef14d8a37c8",
      "content": "func (s *service) Delete(ctx context.Context, id string) error {\n\tmessage, err := s.Get(ctx, id)\n\tif err != nil {\n\t\treturn err\n\t}\n\terr = s.q.DeleteMessage(ctx, message.ID)\n\tif err != nil {\n\t\treturn err\n\t}\n\ts.Publish(pubsub.DeletedEvent, message)\n\treturn nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Create_58": {
      "name": "Create",
      "type": "method",
      "start_line": 58,
      "end_line": 91,
      "content_hash": "3f82efe790cb5a74221f05137af6f5669a4eeb75",
      "content": "func (s *service) Create(ctx context.Context, sessionID string, params CreateMessageParams) (Message, error) {\n\tif params.Role != Assistant {\n\t\tparams.Parts = append(params.Parts, Finish{\n\t\t\tReason: \"stop\",\n\t\t})\n\t}\n\tpartsJSON, err := marshallParts(params.Parts)\n\tif err != nil {\n\t\treturn Message{}, err\n\t}\n\tisSummary := int64(0)\n\tif params.IsSummaryMessage {\n\t\tisSummary = 1\n\t}\n\tdbMessage, err := s.q.CreateMessage(ctx, db.CreateMessageParams{\n\t\tID:               uuid.New().String(),\n\t\tSessionID:        sessionID,\n\t\tRole:             string(params.Role),\n\t\tParts:            string(partsJSON),\n\t\tModel:            sql.NullString{String: string(params.Model), Valid: true},\n\t\tProvider:         sql.NullString{String: params.Provider, Valid: params.Provider != \"\"},\n\t\tIsSummaryMessage: isSummary,\n\t})\n\tif err != nil {\n\t\treturn Message{}, err\n\t}\n\tmessage, err := s.fromDBItem(dbMessage)\n\tif err != nil {\n\t\treturn Message{}, err\n\t}\n\ts.Publish(pubsub.CreatedEvent, message)\n\treturn message, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteSessionMessages_92": {
      "name": "DeleteSessionMessages",
      "type": "method",
      "start_line": 92,
      "end_line": 107,
      "content_hash": "6fe6d99f46e76af5cd3c667145568e197c89f781",
      "content": "func (s *service) DeleteSessionMessages(ctx context.Context, sessionID string) error {\n\tmessages, err := s.List(ctx, sessionID)\n\tif err != nil {\n\t\treturn err\n\t}\n\tfor _, message := range messages {\n\t\tif message.SessionID == sessionID {\n\t\t\terr = s.Delete(ctx, message.ID)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t}\n\treturn nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Update_108": {
      "name": "Update",
      "type": "method",
      "start_line": 108,
      "end_line": 130,
      "content_hash": "f442b63afa64ef28175e08edd984435b5ed31ee6",
      "content": "func (s *service) Update(ctx context.Context, message Message) error {\n\tparts, err := marshallParts(message.Parts)\n\tif err != nil {\n\t\treturn err\n\t}\n\tfinishedAt := sql.NullInt64{}\n\tif f := message.FinishPart(); f != nil {\n\t\tfinishedAt.Int64 = f.Time\n\t\tfinishedAt.Valid = true\n\t}\n\terr = s.q.UpdateMessage(ctx, db.UpdateMessageParams{\n\t\tID:         message.ID,\n\t\tParts:      string(parts),\n\t\tFinishedAt: finishedAt,\n\t})\n\tif err != nil {\n\t\treturn err\n\t}\n\tmessage.UpdatedAt = time.Now().Unix()\n\ts.Publish(pubsub.UpdatedEvent, message)\n\treturn nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Get_131": {
      "name": "Get",
      "type": "method",
      "start_line": 131,
      "end_line": 138,
      "content_hash": "7849940b038d3e5c842b1491414810eb315941a1",
      "content": "func (s *service) Get(ctx context.Context, id string) (Message, error) {\n\tdbMessage, err := s.q.GetMessage(ctx, id)\n\tif err != nil {\n\t\treturn Message{}, err\n\t}\n\treturn s.fromDBItem(dbMessage)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_List_139": {
      "name": "List",
      "type": "method",
      "start_line": 139,
      "end_line": 153,
      "content_hash": "acbc9f4a40c4235c8f543dc78aba22108c270e3f",
      "content": "func (s *service) List(ctx context.Context, sessionID string) ([]Message, error) {\n\tdbMessages, err := s.q.ListMessagesBySession(ctx, sessionID)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tmessages := make([]Message, len(dbMessages))\n\tfor i, dbMessage := range dbMessages {\n\t\tmessages[i], err = s.fromDBItem(dbMessage)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\treturn messages, nil\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_fromDBItem_154": {
      "name": "fromDBItem",
      "type": "method",
      "start_line": 154,
      "end_line": 183,
      "content_hash": "82e40a265659b3f3493d066aa0f3eecdd7a5124b",
      "content": "func (s *service) fromDBItem(item db.Message) (Message, error) {\n\tparts, err := unmarshallParts([]byte(item.Parts))\n\tif err != nil {\n\t\treturn Message{}, err\n\t}\n\treturn Message{\n\t\tID:               item.ID,\n\t\tSessionID:        item.SessionID,\n\t\tRole:             MessageRole(item.Role),\n\t\tParts:            parts,\n\t\tModel:            item.Model.String,\n\t\tProvider:         item.Provider.String,\n\t\tCreatedAt:        item.CreatedAt,\n\t\tUpdatedAt:        item.UpdatedAt,\n\t\tIsSummaryMessage: item.IsSummaryMessage != 0,\n\t}, nil\n}\n\ntype partType string\n\nconst (\n\treasoningType  partType = \"reasoning\"\n\ttextType       partType = \"text\"\n\timageURLType   partType = \"image_url\"\n\tbinaryType     partType = \"binary\"\n\ttoolCallType   partType = \"tool_call\"\n\ttoolResultType partType = \"tool_result\"\n\tfinishType     partType = \"finish\"\n)\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_partWrapper_184": {
      "name": "partWrapper",
      "type": "struct",
      "start_line": 184,
      "end_line": 188,
      "content_hash": "89337812406e3d47fbc95e05d7fabddcc6a6cd84",
      "content": "type partWrapper struct {\n\tType partType    `json:\"type\"`\n\tData ContentPart `json:\"data\"`\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_marshallParts_189": {
      "name": "marshallParts",
      "type": "function",
      "start_line": 189,
      "end_line": 221,
      "content_hash": "7e55e853ddbff21bc365246ad2470ef7d0d309eb",
      "content": "func marshallParts(parts []ContentPart) ([]byte, error) {\n\twrappedParts := make([]partWrapper, len(parts))\n\n\tfor i, part := range parts {\n\t\tvar typ partType\n\n\t\tswitch part.(type) {\n\t\tcase ReasoningContent:\n\t\t\ttyp = reasoningType\n\t\tcase TextContent:\n\t\t\ttyp = textType\n\t\tcase ImageURLContent:\n\t\t\ttyp = imageURLType\n\t\tcase BinaryContent:\n\t\t\ttyp = binaryType\n\t\tcase ToolCall:\n\t\t\ttyp = toolCallType\n\t\tcase ToolResult:\n\t\t\ttyp = toolResultType\n\t\tcase Finish:\n\t\t\ttyp = finishType\n\t\tdefault:\n\t\t\treturn nil, fmt.Errorf(\"unknown part type: %T\", part)\n\t\t}\n\n\t\twrappedParts[i] = partWrapper{\n\t\t\tType: typ,\n\t\t\tData: part,\n\t\t}\n\t}\n\treturn json.Marshal(wrappedParts)\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_unmarshallParts_222": {
      "name": "unmarshallParts",
      "type": "function",
      "start_line": 222,
      "end_line": 290,
      "content_hash": "6341c5e46ba9e9e10112adfebb0ad623a00ea9e6",
      "content": "func unmarshallParts(data []byte) ([]ContentPart, error) {\n\ttemp := []json.RawMessage{}\n\n\tif err := json.Unmarshal(data, &temp); err != nil {\n\t\treturn nil, err\n\t}\n\n\tparts := make([]ContentPart, 0)\n\n\tfor _, rawPart := range temp {\n\t\tvar wrapper struct {\n\t\t\tType partType        `json:\"type\"`\n\t\t\tData json.RawMessage `json:\"data\"`\n\t\t}\n\n\t\tif err := json.Unmarshal(rawPart, &wrapper); err != nil {\n\t\t\treturn nil, err\n\t\t}\n\n\t\tswitch wrapper.Type {\n\t\tcase reasoningType:\n\t\t\tpart := ReasoningContent{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase textType:\n\t\t\tpart := TextContent{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase imageURLType:\n\t\t\tpart := ImageURLContent{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase binaryType:\n\t\t\tpart := BinaryContent{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase toolCallType:\n\t\t\tpart := ToolCall{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase toolResultType:\n\t\t\tpart := ToolResult{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tcase finishType:\n\t\t\tpart := Finish{}\n\t\t\tif err := json.Unmarshal(wrapper.Data, &part); err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tparts = append(parts, part)\n\t\tdefault:\n\t\t\treturn nil, fmt.Errorf(\"unknown part type: %s\", wrapper.Type)\n\t\t}\n\t}\n\n\treturn parts, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}