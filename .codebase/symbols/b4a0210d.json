{
  "file_path": "/work/external-deps/Context-Engine/tests/test_admin_collection_delete.py",
  "file_hash": "99a1b75781c1f48e8fc1ab3b979c1b7e4e0b62fa",
  "updated_at": "2025-12-26T17:34:19.901461",
  "symbols": {
    "function_test_env_gate_blocks_delete_endpoint_9": {
      "name": "test_env_gate_blocks_delete_endpoint",
      "type": "function",
      "start_line": 9,
      "end_line": 32,
      "content_hash": "9c6eedd3b172709fe11e5e8d0e0e3ccbfcc1de2d",
      "content": "def test_env_gate_blocks_delete_endpoint(monkeypatch):\n    monkeypatch.setenv(\"CTXCE_ADMIN_COLLECTION_DELETE_ENABLED\", \"0\")\n\n    srv = importlib.import_module(\"scripts.upload_service\")\n    srv = importlib.reload(srv)\n\n    def _noop_admin(_request):\n        return {\"user_id\": \"admin\"}\n\n    monkeypatch.setattr(srv, \"_require_admin_session\", _noop_admin)\n\n    def _fake_render_admin_error(_request, title, message, back_href=\"/admin\", status_code=400):\n        return Response(content=f\"{title}: {message}\", status_code=status_code)\n\n    monkeypatch.setattr(srv, \"render_admin_error\", _fake_render_admin_error)\n\n    def _should_not_be_called(**_kwargs):\n        raise AssertionError(\"delete_collection_everywhere should not be called when env gate is off\")\n\n    monkeypatch.setattr(srv, \"delete_collection_everywhere\", _should_not_be_called)\n\n    client = TestClient(srv.app)\n    resp = client.post(\"/admin/collections/delete\", data={\"collection\": \"c1\", \"delete_fs\": \"\"})\n    assert resp.status_code == 403",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__noop_admin_15": {
      "name": "_noop_admin",
      "type": "function",
      "start_line": 15,
      "end_line": 16,
      "content_hash": "1dbbe8319bcb805c9ed4a9bd1090d8b0786c5821",
      "content": "    def _noop_admin(_request):\n        return {\"user_id\": \"admin\"}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__fake_render_admin_error_20": {
      "name": "_fake_render_admin_error",
      "type": "function",
      "start_line": 20,
      "end_line": 21,
      "content_hash": "d99b9c8fcf3897ae134e29cd7ec2b2eb8232fe94",
      "content": "    def _fake_render_admin_error(_request, title, message, back_href=\"/admin\", status_code=400):\n        return Response(content=f\"{title}: {message}\", status_code=status_code)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function__should_not_be_called_25": {
      "name": "_should_not_be_called",
      "type": "function",
      "start_line": 25,
      "end_line": 26,
      "content_hash": "0e5e881d0a5423dd00cadff608282acc1b685b9f",
      "content": "    def _should_not_be_called(**_kwargs):\n        raise AssertionError(\"delete_collection_everywhere should not be called when env gate is off\")",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_admin_role_gate_blocks_non_admin_36": {
      "name": "test_admin_role_gate_blocks_non_admin",
      "type": "function",
      "start_line": 36,
      "end_line": 52,
      "content_hash": "4e1ec9cf4b4ed8b81ac6011bb17173cd6f0b4f55",
      "content": "def test_admin_role_gate_blocks_non_admin(monkeypatch):\n    monkeypatch.setenv(\"CTXCE_AUTH_ENABLED\", \"1\")\n    monkeypatch.setenv(\"CTXCE_ADMIN_COLLECTION_DELETE_ENABLED\", \"1\")\n\n    auth = importlib.import_module(\"scripts.auth_backend\")\n    importlib.reload(auth)\n\n    srv = importlib.import_module(\"scripts.upload_service\")\n    srv = importlib.reload(srv)\n\n    monkeypatch.setattr(srv, \"_get_valid_session_record\", lambda _req: {\"user_id\": \"u1\"})\n    monkeypatch.setattr(srv, \"is_admin_user\", lambda _uid: False)\n\n    client = TestClient(srv.app)\n    resp = client.post(\"/admin/collections/delete\", data={\"collection\": \"c1\"})\n    assert resp.status_code == 403\n    assert resp.json().get(\"detail\") == \"Admin required\"",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_collection_admin_refuses_when_env_disabled_56": {
      "name": "test_collection_admin_refuses_when_env_disabled",
      "type": "function",
      "start_line": 56,
      "end_line": 62,
      "content_hash": "121e334177acccfd7e3217341a17214e69c73992",
      "content": "def test_collection_admin_refuses_when_env_disabled(monkeypatch):\n    monkeypatch.setenv(\"CTXCE_ADMIN_COLLECTION_DELETE_ENABLED\", \"0\")\n    ca = importlib.import_module(\"scripts.collection_admin\")\n    ca = importlib.reload(ca)\n\n    with pytest.raises(PermissionError):\n        ca.delete_collection_everywhere(collection=\"c1\", cleanup_fs=False)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_managed_upload_marker_gates_workspace_deletion_66": {
      "name": "test_managed_upload_marker_gates_workspace_deletion",
      "type": "function",
      "start_line": 66,
      "end_line": 81,
      "content_hash": "17eed3a44a0f97ded98da97de6211e2ed7d36b77",
      "content": "def test_managed_upload_marker_gates_workspace_deletion(tmp_path):\n    ca = importlib.import_module(\"scripts.collection_admin\")\n    ca = importlib.reload(ca)\n\n    work_root = tmp_path / \"work\"\n    work_root.mkdir(parents=True, exist_ok=True)\n\n    slug = work_root / \"repo-0123456789abcdef\"\n    slug.mkdir(parents=True, exist_ok=True)\n\n    assert ca._is_managed_upload_workspace_dir(slug, work_root=work_root) is False\n\n    marker = work_root / \".codebase\" / \"repos\" / slug.name\n    marker.mkdir(parents=True, exist_ok=True)\n    (marker / \".ctxce_managed_upload\").write_text(\"1\\n\")\n    assert ca._is_managed_upload_workspace_dir(slug, work_root=work_root) is True",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_registry_undelete_on_discovery_85": {
      "name": "test_registry_undelete_on_discovery",
      "type": "function",
      "start_line": 85,
      "end_line": 110,
      "content_hash": "98a161ea4034e1002dc8504772308bb502d46f4b",
      "content": "def test_registry_undelete_on_discovery(monkeypatch, tmp_path):\n    db = tmp_path / \"auth.sqlite\"\n\n    monkeypatch.setenv(\"CTXCE_AUTH_ENABLED\", \"1\")\n    monkeypatch.setenv(\"CTXCE_AUTH_DB_URL\", f\"sqlite:///{db}\")\n    monkeypatch.setenv(\"CTXCE_COLLECTION_REGISTRY_UNDELETE_ON_DISCOVERY\", \"1\")\n\n    ab = importlib.import_module(\"scripts.auth_backend\")\n    ab = importlib.reload(ab)\n\n    ab._ensure_db()\n    with ab._db_connection() as conn:\n        with conn:\n            conn.execute(\n                \"INSERT INTO collections (id, qdrant_collection, created_at, metadata_json, is_deleted) VALUES (?, ?, ?, ?, 1)\",\n                (\"c1\", \"c1\", 123, None),\n            )\n\n    got = ab.ensure_collection(\"c1\")\n    assert got.get(\"is_deleted\") == 0\n\n    with ab._db_connection() as conn:\n        cur = conn.cursor()\n        cur.execute(\"SELECT is_deleted FROM collections WHERE qdrant_collection = ?\", (\"c1\",))\n        row = cur.fetchone()\n    assert int(row[0] or 0) == 0",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_cleanup_state_files_deletes_symbol_caches_single_repo_114": {
      "name": "test_cleanup_state_files_deletes_symbol_caches_single_repo",
      "type": "function",
      "start_line": 114,
      "end_line": 134,
      "content_hash": "cb7e37b0047d279e0350f2aaa7caba35d2c782af",
      "content": "def test_cleanup_state_files_deletes_symbol_caches_single_repo(monkeypatch, tmp_path):\n    monkeypatch.setenv(\"WORK_DIR\", str(tmp_path / \"work\"))\n    ca = importlib.import_module(\"scripts.collection_admin\")\n    ca = importlib.reload(ca)\n\n    ws = tmp_path / \"ws\"\n    st_dir = ws / \".codebase\"\n    st_dir.mkdir(parents=True, exist_ok=True)\n\n    state_file = st_dir / \"state.json\"\n    state_file.write_text(\"{}\")\n    (st_dir / \"cache.json\").write_text(\"{}\")\n    (st_dir / \"symbols_aaa.json\").write_text(\"{}\")\n    (st_dir / \"symbols_bbb.json\").write_text(\"{}\")\n\n    removed = ca._cleanup_state_files_for_mapping({\"state_file\": str(state_file)})\n    assert removed >= 1\n    assert not state_file.exists()\n    assert not (st_dir / \"cache.json\").exists()\n    assert not (st_dir / \"symbols_aaa.json\").exists()\n    assert not (st_dir / \"symbols_bbb.json\").exists()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_cleanup_state_files_deletes_repo_dir_multi_repo_138": {
      "name": "test_cleanup_state_files_deletes_repo_dir_multi_repo",
      "type": "function",
      "start_line": 138,
      "end_line": 160,
      "content_hash": "51d3011e7ae5c505f5b473ba57244152cd3831de",
      "content": "def test_cleanup_state_files_deletes_repo_dir_multi_repo(monkeypatch, tmp_path):\n    monkeypatch.setenv(\"MULTI_REPO_MODE\", \"1\")\n    monkeypatch.setenv(\"WORK_DIR\", str(tmp_path / \"work\"))\n    monkeypatch.setenv(\"WORKSPACE_PATH\", str(tmp_path / \"work\"))\n\n    ca = importlib.import_module(\"scripts.collection_admin\")\n    ca = importlib.reload(ca)\n\n    work_root = tmp_path / \"work\"\n    repo_name = \"repo-0123456789abcdef\"\n\n    repo_dir = work_root / \".codebase\" / \"repos\" / repo_name\n    repo_dir.mkdir(parents=True, exist_ok=True)\n    (repo_dir / \"state.json\").write_text(\"{}\")\n    (repo_dir / \"cache.json\").write_text(\"{}\")\n    (repo_dir / \"symbols_aaa.json\").write_text(\"{}\")\n\n    removed = ca._cleanup_state_files_for_mapping(\n        {\"state_file\": str(repo_dir / \"state.json\")},\n        work_root=work_root,\n    )\n    assert removed >= 1\n    assert not repo_dir.exists()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_workspace_state_does_not_recreate_repo_metadata_when_workspace_missing_164": {
      "name": "test_workspace_state_does_not_recreate_repo_metadata_when_workspace_missing",
      "type": "function",
      "start_line": 164,
      "end_line": 179,
      "content_hash": "7ab35e2bc45e0f02fee08ed03e4115b3bf983d59",
      "content": "def test_workspace_state_does_not_recreate_repo_metadata_when_workspace_missing(monkeypatch, tmp_path):\n    monkeypatch.setenv(\"MULTI_REPO_MODE\", \"1\")\n    monkeypatch.setenv(\"WORKSPACE_PATH\", str(tmp_path / \"work\"))\n\n    ws_root = tmp_path / \"work\"\n    ws_root.mkdir(parents=True, exist_ok=True)\n\n    repo_name = \"repo-0123456789abcdef\"\n    state_dir = ws_root / \".codebase\" / \"repos\" / repo_name\n    assert not state_dir.exists()\n\n    ws = importlib.import_module(\"scripts.workspace_state\")\n    ws = importlib.reload(ws)\n\n    ws.log_activity(repo_name=repo_name, action=\"deleted\", workspace_path=str(ws_root))\n    assert not state_dir.exists()",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}