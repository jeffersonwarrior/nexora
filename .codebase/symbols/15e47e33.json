{
  "file_path": "/work/external-deps/helix-db/helix-db/benches/bm25_benches.rs",
  "file_hash": "94768f4b87467cbdaec999bca004069e9b59f999",
  "updated_at": "2025-12-26T17:34:23.820325",
  "symbols": {
    "function_setup_test_env_16": {
      "name": "setup_test_env",
      "type": "function",
      "start_line": 16,
      "end_line": 30,
      "content_hash": "606161a43a46b9be748599a0339e027cd704f239",
      "content": "    fn setup_test_env() -> (Env, tempfile::TempDir) {\n        let temp_dir = tempdir().unwrap();\n        let path = temp_dir.path();\n\n        let env = unsafe {\n            EnvOpenOptions::new()\n                .map_size(4 * 1024 * 1024 * 1024) // 4GB\n                .max_dbs(20)\n                .open(path)\n                .unwrap()\n        };\n\n        (env, temp_dir)\n    }\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_setup_bm25_config_31": {
      "name": "setup_bm25_config",
      "type": "function",
      "start_line": 31,
      "end_line": 40,
      "content_hash": "aa476c115fec9335c5a29578702dc28a2aa6c151",
      "content": "    fn setup_bm25_config() -> (HBM25Config, tempfile::TempDir) {\n        let (env, temp_dir) = setup_test_env();\n        let mut wtxn = env.write_txn().unwrap();\n        let config = HBM25Config::new(&env, &mut wtxn).unwrap();\n        wtxn.commit().unwrap();\n        (config, temp_dir)\n    }\n\n    /// 5 most frequent words: (the: 27660, and: 26784, i: 22538, to: 19819, of: 18191)\n    /// 5 least frequent words: (glowed: 1, lovered: 1, hovered: 1, unexperient: 1, preached: 1)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_fetch_shakespeare_41": {
      "name": "fetch_shakespeare",
      "type": "function",
      "start_line": 41,
      "end_line": 47,
      "content_hash": "27e3d9bb2147e7f220d1d9edf5f202087377c723",
      "content": "    fn fetch_shakespeare() -> Result<String, reqwest::Error> {\n        get(\"https://ocw.mit.edu/ans7870/6/6.006/s08/lecturenotes/files/t8.shakespeare.txt\")?.text()\n    }\n\n    /// Tests the precision (number of docs returned) of the implemented\n    /// bm25 search algorithm\n    #[test]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_bm25_precision_short_48": {
      "name": "test_bm25_precision_short",
      "type": "function",
      "start_line": 48,
      "end_line": 103,
      "content_hash": "00ba6b850255a2b8d821709a66010d799318fa40",
      "content": "    fn test_bm25_precision_short() {\n        let (bm25, _temp_dir) = setup_bm25_config();\n        let mut wtxn = bm25.graph_env.write_txn().unwrap();\n\n        let mut rng = rand::rng();\n        let mut docs = vec![];\n        let relevant_count = 4000 as usize;\n        let total_docs = 1_000_000;\n\n        for i in tqdm::new(\n            0..relevant_count,\n            relevant_count,\n            None,\n            Some(\"relevant docs\"),\n        ) {\n            let id = v6_uuid();\n            let doc = format!(\"queryterm document {}\", i);\n            docs.push((id, doc));\n        }\n\n        for i in tqdm::new(\n            relevant_count..total_docs,\n            total_docs - relevant_count,\n            None,\n            Some(\"irrelevant docs\"),\n        ) {\n            let id = v6_uuid();\n            let doc = format!(\"document {} other words\", i);\n            docs.push((id, doc));\n        }\n\n        docs.shuffle(&mut rng);\n        for (doc_id, doc) in tqdm::new(docs.iter(), total_docs, None, Some(\"inserting docs\")) {\n            bm25.insert_doc(&mut wtxn, *doc_id, doc).unwrap();\n        }\n\n        wtxn.commit().unwrap();\n\n        let rtxn = bm25.graph_env.read_txn().unwrap();\n        let results = bm25.search(&rtxn, \"queryterm\", relevant_count + 1).unwrap();\n\n        let precision = results.len() as f64 / results.len() as f64;\n\n        assert!(\n            precision >= 0.9,\n            \"precision {} below threshold 0.9\",\n            precision\n        );\n        assert_eq!(\n            results.len(),\n            relevant_count,\n            \"not all relevant docs retrieved\"\n        );\n    }\n\n    #[test]",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_test_bm25_precision_long_104": {
      "name": "test_bm25_precision_long",
      "type": "function",
      "start_line": 104,
      "end_line": 157,
      "content_hash": "9ab08f0aaeef2c3f70a0046fd3b69432e081c309",
      "content": "    fn test_bm25_precision_long() {\n        let (bm25, _temp_dir) = setup_bm25_config();\n        let mut wtxn = bm25.graph_env.write_txn().unwrap();\n\n        let query_terms = vec![\"the\", \"and\"];\n        let mut query_term_counts: HashMap<String, usize> = HashMap::new();\n        for term in &query_terms {\n            query_term_counts.insert(term.to_string(), 0);\n        }\n        let limit = 30_000;\n\n        let txt = fetch_shakespeare().unwrap();\n        //let word_count = shakespeare_txt.split_whitespace().count();\n\n        let docs = txt\n            .split_whitespace()\n            .collect::<Vec<_>>()\n            .chunks(250)\n            .map(|chunk| chunk.join(\" \"))\n            .collect::<Vec<_>>();\n\n        for doc in tqdm::new(docs.iter(), docs.len(), None, Some(\"inserting docs\")) {\n            let id = v6_uuid();\n            let doc_lower = doc.to_lowercase();\n\n            let _ = bm25.insert_doc(&mut wtxn, id, &doc_lower).unwrap();\n\n            for term in &query_terms {\n                if doc_lower.contains(term) {\n                    *query_term_counts.get_mut(*term).unwrap() += 1;\n                }\n            }\n        }\n\n        wtxn.commit().unwrap();\n\n        for query_term in query_terms {\n            let rtxn = bm25.graph_env.read_txn().unwrap();\n            let term_count = query_term_counts.get(query_term).unwrap().clone();\n\n            let results = bm25.search(&rtxn, query_term, limit).unwrap();\n\n            let precision = results.len() as f64 / term_count as f64;\n\n            debug_println!(\"term count: {}, results len: {}\", term_count, results.len());\n\n            assert!(\n                precision >= 0.9 && precision <= 1.0,\n                \"precision {} below 0.9 or above 1.0\",\n                precision\n            );\n        }\n    }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}