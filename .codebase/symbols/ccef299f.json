{
  "file_path": "/work/external-deps/claude-swarm/src/utils/plan-evaluator.ts",
  "file_hash": "3903d458e626716e280d146b87a9a89385e5e2e6",
  "updated_at": "2025-12-26T17:34:20.157552",
  "symbols": {
    "function_evaluatePlan_74": {
      "name": "evaluatePlan",
      "type": "function",
      "start_line": 74,
      "end_line": 264,
      "content_hash": "33defc6a708f9fcf4da3bb8f17158e151e5b9939",
      "content": "function evaluatePlan(\n  plan: StructuredPlan,\n  feature: Feature,\n  projectDir: string,\n  planId: \"A\" | \"B\"\n): PlanEvaluation {\n  const concerns: string[] = [];\n  const strengths: string[] = [];\n\n  // 1. Completeness Score (0-25)\n  let completeness = 15; // Base score\n\n  // Check if plan has meaningful steps\n  if (plan.steps.length === 0) {\n    completeness -= 10;\n    concerns.push(\"No implementation steps defined\");\n  } else if (plan.steps.length >= 3) {\n    completeness += 5;\n    strengths.push(\"Well-structured multi-step approach\");\n  }\n\n  // Check if summary addresses the feature\n  const featureKeywords = feature.description\n    .toLowerCase()\n    .split(/\\s+/)\n    .filter((w) => w.length > 4);\n  const summaryLower = plan.summary.toLowerCase();\n  const keywordMatches = featureKeywords.filter((kw) =>\n    summaryLower.includes(kw)\n  );\n  if (keywordMatches.length >= 2) {\n    completeness += 3;\n    strengths.push(\"Summary directly addresses feature requirements\");\n  }\n\n  // Check for test strategy\n  if (plan.testStrategy && plan.testStrategy.length > 20) {\n    completeness += 2;\n    strengths.push(\"Includes test strategy\");\n  } else {\n    concerns.push(\"Missing or inadequate test strategy\");\n  }\n\n  completeness = Math.max(0, Math.min(25, completeness));\n\n  // 2. Feasibility Score (0-25)\n  let feasibility = 15; // Base score\n\n  // Check if mentioned files exist (sample check)\n  const allFiles = [...plan.filesToCreate, ...plan.filesToModify];\n  const filesWithExtensions = allFiles.filter((f) =>\n    /\\.(ts|js|tsx|jsx|json|md|py|rs|go|css|scss|html)$/i.test(f)\n  );\n\n  if (filesWithExtensions.length > 0) {\n    // Check a sample of files to modify - they should exist\n    const filesToCheck = plan.filesToModify.slice(0, 3);\n    let existingCount = 0;\n    for (const file of filesToCheck) {\n      const fullPath = path.join(projectDir, file);\n      if (fs.existsSync(fullPath)) {\n        existingCount++;\n      }\n    }\n    if (filesToCheck.length > 0 && existingCount === filesToCheck.length) {\n      feasibility += 5;\n      strengths.push(\"Files to modify exist and are valid\");\n    } else if (filesToCheck.length > 0 && existingCount === 0) {\n      feasibility -= 5;\n      concerns.push(\"Some files to modify may not exist\");\n    }\n  }\n\n  // Check for reasonable step count (not too few, not too many)\n  if (plan.steps.length >= 2 && plan.steps.length <= 10) {\n    feasibility += 3;\n  } else if (plan.steps.length > 15) {\n    feasibility -= 3;\n    concerns.push(\"Plan may be overly complex with too many steps\");\n  }\n\n  // Penalize if no files are specified\n  if (allFiles.length === 0) {\n    feasibility -= 8;\n    concerns.push(\"No files specified for creation or modification\");\n  } else {\n    feasibility += 2;\n  }\n\n  feasibility = Math.max(0, Math.min(25, feasibility));\n\n  // 3. Risk Awareness Score (0-20)\n  let riskAwareness = 10; // Base score\n\n  if (plan.risks && plan.risks.length > 0) {\n    riskAwareness += Math.min(8, plan.risks.length * 2);\n    strengths.push(`Identifies ${plan.risks.length} potential risks`);\n\n    // Check if risks mention mitigation\n    const mitigationKeywords = [\n      \"mitigat\",\n      \"prevent\",\n      \"avoid\",\n      \"handle\",\n      \"fallback\",\n      \"rollback\",\n    ];\n    const hasMitigation = plan.risks.some((risk) =>\n      mitigationKeywords.some((kw) => risk.toLowerCase().includes(kw))\n    );\n    if (hasMitigation) {\n      riskAwareness += 2;\n      strengths.push(\"Includes risk mitigation strategies\");\n    }\n  } else {\n    riskAwareness -= 5;\n    concerns.push(\"No risks identified - may indicate lack of thoroughness\");\n  }\n\n  riskAwareness = Math.max(0, Math.min(20, riskAwareness));\n\n  // 4. Clarity Score (0-15)\n  let clarity = 8; // Base score\n\n  // Check if steps have descriptions\n  const stepsWithDescriptions = plan.steps.filter(\n    (s) => s.description && s.description.length > 10\n  );\n  if (stepsWithDescriptions.length === plan.steps.length && plan.steps.length > 0) {\n    clarity += 4;\n    strengths.push(\"All steps have clear descriptions\");\n  }\n\n  // Check if steps have validation criteria\n  const stepsWithValidation = plan.steps.filter(\n    (s) => s.validation && s.validation.length > 0\n  );\n  if (stepsWithValidation.length >= plan.steps.length / 2) {\n    clarity += 3;\n    strengths.push(\"Steps include validation criteria\");\n  }\n\n  // Check summary length (not too short, not too long)\n  if (plan.summary.length >= 50 && plan.summary.length <= 500) {\n    clarity += 2;\n  } else if (plan.summary.length < 20) {\n    clarity -= 3;\n    concerns.push(\"Summary is too brief\");\n  }\n\n  clarity = Math.max(0, Math.min(15, clarity));\n\n  // 5. Efficiency Score (0-15)\n  let efficiency = 10; // Base score\n\n  // Fewer steps (when appropriate) indicates efficiency\n  if (plan.steps.length >= 2 && plan.steps.length <= 5) {\n    efficiency += 3;\n    strengths.push(\"Efficient step count\");\n  } else if (plan.steps.length > 10) {\n    efficiency -= 2;\n  }\n\n  // Fewer files to modify (when appropriate) indicates focused changes\n  const totalFiles = plan.filesToCreate.length + plan.filesToModify.length;\n  if (totalFiles >= 1 && totalFiles <= 5) {\n    efficiency += 2;\n    strengths.push(\"Focused file modifications\");\n  } else if (totalFiles > 10) {\n    efficiency -= 2;\n    concerns.push(\"Large number of files may indicate scope creep\");\n  }\n\n  efficiency = Math.max(0, Math.min(15, efficiency));\n\n  const total = completeness + feasibility + riskAwareness + clarity + efficiency;\n\n  return {\n    planId,\n    scores: {\n      completeness,\n      feasibility,\n      riskAwareness,\n      clarity,\n      efficiency,\n      total,\n    },\n    concerns,\n    strengths,\n  };\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_evaluatePlans_269": {
      "name": "evaluatePlans",
      "type": "function",
      "start_line": 269,
      "end_line": 303,
      "content_hash": "c25a11b4fb6e9085aa2f761b2e8cf6a69484269d",
      "content": "export function evaluatePlans(\n  feature: Feature,\n  planA: StructuredPlan,\n  planB: StructuredPlan,\n  projectDir: string\n): EvaluationResult {\n  const evalA = evaluatePlan(planA, feature, projectDir, \"A\");\n  const evalB = evaluatePlan(planB, feature, projectDir, \"B\");\n\n  const winner: \"A\" | \"B\" = evalA.scores.total >= evalB.scores.total ? \"A\" : \"B\";\n  const marginOfVictory = Math.abs(evalA.scores.total - evalB.scores.total);\n\n  // Generate selection reason\n  let selectionReason: string;\n  if (marginOfVictory < 5) {\n    selectionReason = `Plans are nearly equal (margin: ${marginOfVictory}). Plan ${winner} selected based on slight advantages.`;\n  } else if (marginOfVictory < 15) {\n    const winnerEval = winner === \"A\" ? evalA : evalB;\n    const topStrength = winnerEval.strengths[0] || \"overall quality\";\n    selectionReason = `Plan ${winner} selected with moderate advantage (margin: ${marginOfVictory}). Key strength: ${topStrength}`;\n  } else {\n    const winnerEval = winner === \"A\" ? evalA : evalB;\n    selectionReason = `Plan ${winner} clearly superior (margin: ${marginOfVictory}). Strengths: ${winnerEval.strengths.slice(0, 2).join(\", \")}`;\n  }\n\n  return {\n    winner,\n    evaluations: {\n      A: evalA,\n      B: evalB,\n    },\n    selectionReason,\n    marginOfVictory,\n  };\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_parsePlanFromFile_308": {
      "name": "parsePlanFromFile",
      "type": "function",
      "start_line": 308,
      "end_line": 343,
      "content_hash": "93476f0e770e46f57540959c9c2c1ae180d86860",
      "content": "export function parsePlanFromFile(filePath: string): StructuredPlan | null {\n  try {\n    if (!fs.existsSync(filePath)) {\n      return null;\n    }\n\n    const content = fs.readFileSync(filePath, \"utf-8\");\n    const parsed = JSON.parse(content);\n\n    // Validate required fields\n    if (!parsed.summary || !Array.isArray(parsed.steps)) {\n      return null;\n    }\n\n    // Normalize the plan structure\n    return {\n      summary: parsed.summary || \"\",\n      steps: (parsed.steps || []).map(\n        (step: Partial<PlanStep>, index: number) => ({\n          order: step.order ?? index + 1,\n          description: step.description || \"\",\n          files: step.files || [],\n          validation: step.validation,\n        })\n      ),\n      filesToCreate: parsed.filesToCreate || [],\n      filesToModify: parsed.filesToModify || [],\n      testStrategy: parsed.testStrategy || \"\",\n      risks: parsed.risks || [],\n      estimatedComplexity: parsed.estimatedComplexity,\n      dependencies: parsed.dependencies,\n    };\n  } catch {\n    return null;\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_formatEvaluationResult_348": {
      "name": "formatEvaluationResult",
      "type": "function",
      "start_line": 348,
      "end_line": 377,
      "content_hash": "71ea91203dc5026bd7e512d180bbf0e2e7155ac9",
      "content": "export function formatEvaluationResult(result: EvaluationResult): string {\n  const lines: string[] = [];\n\n  lines.push(`Winner: Plan ${result.winner}`);\n  lines.push(`Margin: ${result.marginOfVictory} points`);\n  lines.push(`Reason: ${result.selectionReason}`);\n  lines.push(\"\");\n\n  for (const planId of [\"A\", \"B\"] as const) {\n    const evaluation = result.evaluations[planId];\n    lines.push(`--- Plan ${planId} (${evaluation.scores.total}/100) ---`);\n    lines.push(\n      `  Completeness: ${evaluation.scores.completeness}/25`\n    );\n    lines.push(`  Feasibility: ${evaluation.scores.feasibility}/25`);\n    lines.push(`  Risk Awareness: ${evaluation.scores.riskAwareness}/20`);\n    lines.push(`  Clarity: ${evaluation.scores.clarity}/15`);\n    lines.push(`  Efficiency: ${evaluation.scores.efficiency}/15`);\n\n    if (evaluation.strengths.length > 0) {\n      lines.push(`  Strengths: ${evaluation.strengths.join(\"; \")}`);\n    }\n    if (evaluation.concerns.length > 0) {\n      lines.push(`  Concerns: ${evaluation.concerns.join(\"; \")}`);\n    }\n    lines.push(\"\");\n  }\n\n  return lines.join(\"\\n\");\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}