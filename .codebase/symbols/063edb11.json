{
  "file_path": "/work/.local/tools/modelscan/sdk/storage/message.go",
  "file_hash": "6940b18fbf6073d0ec3ed1fc96c323c0d59694c6",
  "updated_at": "2025-12-26T17:34:19.950858",
  "symbols": {
    "struct_Message_12": {
      "name": "Message",
      "type": "struct",
      "start_line": 12,
      "end_line": 23,
      "content_hash": "85465b0041d52d23a12f70e8c6a92139216743e7",
      "content": "type Message struct {\n\tID        string                 `json:\"id\"`\n\tTaskID    string                 `json:\"task_id\"`\n\tAgentID   string                 `json:\"agent_id\"`\n\tTeamID    *string                `json:\"team_id,omitempty\"`\n\tType      string                 `json:\"type\"`\n\tContent   string                 `json:\"content\"`\n\tMetadata  map[string]interface{} `json:\"metadata\"`\n\tCreatedAt time.Time              `json:\"created_at\"`\n}\n\n// MessageRepository handles message database operations",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_MessageRepository_24": {
      "name": "MessageRepository",
      "type": "struct",
      "start_line": 24,
      "end_line": 28,
      "content_hash": "5abc9e4424f782be9917b297dec284e7b268eea5",
      "content": "type MessageRepository struct {\n\tdb *sql.DB\n}\n\n// NewMessageRepository creates a new message repository",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewMessageRepository_29": {
      "name": "NewMessageRepository",
      "type": "function",
      "start_line": 29,
      "end_line": 33,
      "content_hash": "d0401802ae4add7473ac005e82892769e823abf6",
      "content": "func NewMessageRepository(db *sql.DB) *MessageRepository {\n\treturn &MessageRepository{db: db}\n}\n\n// Create creates a new message",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Create_34": {
      "name": "Create",
      "type": "method",
      "start_line": 34,
      "end_line": 52,
      "content_hash": "df3df9d6e15fc9d5f46987c58cb2cadb39893f26",
      "content": "func (r *MessageRepository) Create(ctx context.Context, message *Message) error {\n\tmetadataJSON, _ := json.Marshal(message.Metadata)\n\n\tquery := `\n\t\tINSERT INTO messages (id, task_id, agent_id, team_id, type, content, metadata)\n\t\tVALUES (?, ?, ?, ?, ?, ?, ?)\n\t`\n\n\t_, err := r.db.ExecContext(ctx, query,\n\t\tmessage.ID, message.TaskID, message.AgentID, message.TeamID,\n\t\tmessage.Type, message.Content, metadataJSON)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to create message: %w\", err)\n\t}\n\n\treturn nil\n}\n\n// Get retrieves a message by ID",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Get_53": {
      "name": "Get",
      "type": "method",
      "start_line": 53,
      "end_line": 81,
      "content_hash": "c2ee9158edff576ea86b3a2bb9e4cbab9883b80a",
      "content": "func (r *MessageRepository) Get(ctx context.Context, id string) (*Message, error) {\n\tquery := `\n\t\tSELECT id, task_id, agent_id, team_id, type, content, metadata, created_at\n\t\tFROM messages WHERE id = ?\n\t`\n\n\tmessage := &Message{}\n\tvar metadataJSON []byte\n\n\terr := r.db.QueryRowContext(ctx, query, id).Scan(\n\t\t&message.ID, &message.TaskID, &message.AgentID, &message.TeamID,\n\t\t&message.Type, &message.Content, &metadataJSON, &message.CreatedAt)\n\tif err != nil {\n\t\tif err == sql.ErrNoRows {\n\t\t\treturn nil, fmt.Errorf(\"message not found: %s\", id)\n\t\t}\n\t\treturn nil, fmt.Errorf(\"failed to get message: %w\", err)\n\t}\n\n\tif len(metadataJSON) > 0 {\n\t\tif err := json.Unmarshal(metadataJSON, &message.Metadata); err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to unmarshal metadata: %w\", err)\n\t\t}\n\t}\n\n\treturn message, nil\n}\n\n// Delete deletes a message",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Delete_82": {
      "name": "Delete",
      "type": "method",
      "start_line": 82,
      "end_line": 102,
      "content_hash": "f53762206944d01f8a03874419d738573cdd045f",
      "content": "func (r *MessageRepository) Delete(ctx context.Context, id string) error {\n\tquery := `DELETE FROM messages WHERE id = ?`\n\n\tresult, err := r.db.ExecContext(ctx, query, id)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to delete message: %w\", err)\n\t}\n\n\trowsAffected, err := result.RowsAffected()\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to get rows affected: %w\", err)\n\t}\n\n\tif rowsAffected == 0 {\n\t\treturn fmt.Errorf(\"message not found: %s\", id)\n\t}\n\n\treturn nil\n}\n\n// ListByTask retrieves messages for a specific task",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListByTask_103": {
      "name": "ListByTask",
      "type": "method",
      "start_line": 103,
      "end_line": 142,
      "content_hash": "07fa05f59dc4a6da739b9099bd3ca62b3824b07e",
      "content": "func (r *MessageRepository) ListByTask(ctx context.Context, taskID string, limit, offset int) ([]*Message, error) {\n\tquery := `\n\t\tSELECT id, task_id, agent_id, team_id, type, content, metadata, created_at\n\t\tFROM messages \n\t\tWHERE task_id = ?\n\t\tORDER BY created_at ASC\n\t\tLIMIT ? OFFSET ?\n\t`\n\n\trows, err := r.db.QueryContext(ctx, query, taskID, limit, offset)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to list messages by task: %w\", err)\n\t}\n\tdefer rows.Close()\n\n\tvar messages []*Message\n\tfor rows.Next() {\n\t\tmessage := &Message{}\n\t\tvar metadataJSON []byte\n\n\t\terr := rows.Scan(\n\t\t\t&message.ID, &message.TaskID, &message.AgentID, &message.TeamID,\n\t\t\t&message.Type, &message.Content, &metadataJSON, &message.CreatedAt)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to scan message: %w\", err)\n\t\t}\n\n\t\tif len(metadataJSON) > 0 {\n\t\t\tif err := json.Unmarshal(metadataJSON, &message.Metadata); err != nil {\n\t\t\t\treturn nil, fmt.Errorf(\"failed to unmarshal metadata: %w\", err)\n\t\t\t}\n\t\t}\n\n\t\tmessages = append(messages, message)\n\t}\n\n\treturn messages, nil\n}\n\n// ListByAgent retrieves messages for a specific agent",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListByAgent_143": {
      "name": "ListByAgent",
      "type": "method",
      "start_line": 143,
      "end_line": 182,
      "content_hash": "eae55a252cd47d843d32dd526651a434d207a97f",
      "content": "func (r *MessageRepository) ListByAgent(ctx context.Context, agentID string, limit, offset int) ([]*Message, error) {\n\tquery := `\n\t\tSELECT id, task_id, agent_id, team_id, type, content, metadata, created_at\n\t\tFROM messages \n\t\tWHERE agent_id = ?\n\t\tORDER BY created_at DESC\n\t\tLIMIT ? OFFSET ?\n\t`\n\n\trows, err := r.db.QueryContext(ctx, query, agentID, limit, offset)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to list messages by agent: %w\", err)\n\t}\n\tdefer rows.Close()\n\n\tvar messages []*Message\n\tfor rows.Next() {\n\t\tmessage := &Message{}\n\t\tvar metadataJSON []byte\n\n\t\terr := rows.Scan(\n\t\t\t&message.ID, &message.TaskID, &message.AgentID, &message.TeamID,\n\t\t\t&message.Type, &message.Content, &metadataJSON, &message.CreatedAt)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to scan message: %w\", err)\n\t\t}\n\n\t\tif len(metadataJSON) > 0 {\n\t\t\tif err := json.Unmarshal(metadataJSON, &message.Metadata); err != nil {\n\t\t\t\treturn nil, fmt.Errorf(\"failed to unmarshal metadata: %w\", err)\n\t\t\t}\n\t\t}\n\n\t\tmessages = append(messages, message)\n\t}\n\n\treturn messages, nil\n}\n\n// ListByTeam retrieves messages for a specific team",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_ListByTeam_183": {
      "name": "ListByTeam",
      "type": "method",
      "start_line": 183,
      "end_line": 222,
      "content_hash": "cf2d2cb2d43fe52eb1e7a4411ee29584a4eda99a",
      "content": "func (r *MessageRepository) ListByTeam(ctx context.Context, teamID string, limit, offset int) ([]*Message, error) {\n\tquery := `\n\t\tSELECT id, task_id, agent_id, team_id, type, content, metadata, created_at\n\t\tFROM messages \n\t\tWHERE team_id = ?\n\t\tORDER BY created_at DESC\n\t\tLIMIT ? OFFSET ?\n\t`\n\n\trows, err := r.db.QueryContext(ctx, query, teamID, limit, offset)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to list messages by team: %w\", err)\n\t}\n\tdefer rows.Close()\n\n\tvar messages []*Message\n\tfor rows.Next() {\n\t\tmessage := &Message{}\n\t\tvar metadataJSON []byte\n\n\t\terr := rows.Scan(\n\t\t\t&message.ID, &message.TaskID, &message.AgentID, &message.TeamID,\n\t\t\t&message.Type, &message.Content, &metadataJSON, &message.CreatedAt)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to scan message: %w\", err)\n\t\t}\n\n\t\tif len(metadataJSON) > 0 {\n\t\t\tif err := json.Unmarshal(metadataJSON, &message.Metadata); err != nil {\n\t\t\t\treturn nil, fmt.Errorf(\"failed to unmarshal metadata: %w\", err)\n\t\t\t}\n\t\t}\n\n\t\tmessages = append(messages, message)\n\t}\n\n\treturn messages, nil\n}\n\n// DeleteByTask deletes all messages for a task",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_DeleteByTask_223": {
      "name": "DeleteByTask",
      "type": "method",
      "start_line": 223,
      "end_line": 234,
      "content_hash": "086b8b44061ed835c6eef3b0759e3e9093e350b4",
      "content": "func (r *MessageRepository) DeleteByTask(ctx context.Context, taskID string) error {\n\tquery := `DELETE FROM messages WHERE task_id = ?`\n\n\t_, err := r.db.ExecContext(ctx, query, taskID)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to delete messages by task: %w\", err)\n\t}\n\n\treturn nil\n}\n\n// GetConversationThread retrieves the conversation thread for a task",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetConversationThread_235": {
      "name": "GetConversationThread",
      "type": "method",
      "start_line": 235,
      "end_line": 271,
      "content_hash": "63ca10d919920228efcbc9b7938017aa96b0cbd4",
      "content": "func (r *MessageRepository) GetConversationThread(ctx context.Context, taskID string) ([]*Message, error) {\n\tquery := `\n\t\tSELECT id, task_id, agent_id, team_id, type, content, metadata, created_at\n\t\tFROM messages \n\t\tWHERE task_id = ?\n\t\tORDER BY created_at ASC\n\t`\n\n\trows, err := r.db.QueryContext(ctx, query, taskID)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to get conversation thread: %w\", err)\n\t}\n\tdefer rows.Close()\n\n\tvar messages []*Message\n\tfor rows.Next() {\n\t\tmessage := &Message{}\n\t\tvar metadataJSON []byte\n\n\t\terr := rows.Scan(\n\t\t\t&message.ID, &message.TaskID, &message.AgentID, &message.TeamID,\n\t\t\t&message.Type, &message.Content, &metadataJSON, &message.CreatedAt)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to scan message: %w\", err)\n\t\t}\n\n\t\tif len(metadataJSON) > 0 {\n\t\t\tif err := json.Unmarshal(metadataJSON, &message.Metadata); err != nil {\n\t\t\t\treturn nil, fmt.Errorf(\"failed to unmarshal metadata: %w\", err)\n\t\t\t}\n\t\t}\n\n\t\tmessages = append(messages, message)\n\t}\n\n\treturn messages, nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}