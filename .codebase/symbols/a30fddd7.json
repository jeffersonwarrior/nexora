{
  "file_path": "/work/internal/agent/common_test.go",
  "file_hash": "c9dbe93c8f14034e96e629a7a2cb4fb425cbaecd",
  "updated_at": "2025-12-26T17:34:22.806798",
  "symbols": {
    "struct_fakeEnv_34": {
      "name": "fakeEnv",
      "type": "struct",
      "start_line": 34,
      "end_line": 44,
      "content_hash": "cc51ef1e51b8bc2cbf9ebda90b0edaf2091158bc",
      "content": "type fakeEnv struct {\n\tworkingDir  string\n\tsessions    session.Service\n\tmessages    message.Service\n\tpermissions permission.Service\n\thistory     history.Service\n\tlspClients  *csync.Map[string, *lsp.Client]\n}\n\ntype builderFunc func(t *testing.T, r *vcr.Recorder) (fantasy.LanguageModel, error)\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "struct_modelPair_45": {
      "name": "modelPair",
      "type": "struct",
      "start_line": 45,
      "end_line": 50,
      "content_hash": "f6ac8e1ad6cdbe79e2de7b129c32b5721ad56bdb",
      "content": "type modelPair struct {\n\tname       string\n\tlargeModel builderFunc\n\tsmallModel builderFunc\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_anthropicBuilder_51": {
      "name": "anthropicBuilder",
      "type": "function",
      "start_line": 51,
      "end_line": 63,
      "content_hash": "cb1daa4336c863e51b0431fc483db7e9239b4aec",
      "content": "func anthropicBuilder(model string) builderFunc {\n\treturn func(t *testing.T, r *vcr.Recorder) (fantasy.LanguageModel, error) {\n\t\tprovider, err := anthropic.New(\n\t\t\tanthropic.WithAPIKey(os.Getenv(\"NEXORA_ANTHROPIC_API_KEY\")),\n\t\t\tanthropic.WithHTTPClient(&http.Client{Transport: r}),\n\t\t)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn provider.LanguageModel(t.Context(), model)\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_openaiBuilder_64": {
      "name": "openaiBuilder",
      "type": "function",
      "start_line": 64,
      "end_line": 76,
      "content_hash": "9b827f1d2892402339f92e904574df08502a8f99",
      "content": "func openaiBuilder(model string) builderFunc {\n\treturn func(t *testing.T, r *vcr.Recorder) (fantasy.LanguageModel, error) {\n\t\tprovider, err := openai.New(\n\t\t\topenai.WithAPIKey(os.Getenv(\"NEXORA_OPENAI_API_KEY\")),\n\t\t\topenai.WithHTTPClient(&http.Client{Transport: r}),\n\t\t)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn provider.LanguageModel(t.Context(), model)\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_openRouterBuilder_77": {
      "name": "openRouterBuilder",
      "type": "function",
      "start_line": 77,
      "end_line": 89,
      "content_hash": "cc2b5b9588e031b1c379f8db9d8a92c40edc92a4",
      "content": "func openRouterBuilder(model string) builderFunc {\n\treturn func(t *testing.T, r *vcr.Recorder) (fantasy.LanguageModel, error) {\n\t\tprovider, err := openrouter.New(\n\t\t\topenrouter.WithAPIKey(os.Getenv(\"NEXORA_OPENROUTER_API_KEY\")),\n\t\t\topenrouter.WithHTTPClient(&http.Client{Transport: r}),\n\t\t)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn provider.LanguageModel(t.Context(), model)\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_zAIBuilder_90": {
      "name": "zAIBuilder",
      "type": "function",
      "start_line": 90,
      "end_line": 103,
      "content_hash": "fb004e46e41b55cb54cf54eea8e7beb1667d263a",
      "content": "func zAIBuilder(model string) builderFunc {\n\treturn func(t *testing.T, r *vcr.Recorder) (fantasy.LanguageModel, error) {\n\t\tprovider, err := openaicompat.New(\n\t\t\topenaicompat.WithBaseURL(\"https://api.z.ai/api/coding/paas/v4\"),\n\t\t\topenaicompat.WithAPIKey(os.Getenv(\"NEXORA_ZAI_API_KEY\")),\n\t\t\topenaicompat.WithHTTPClient(&http.Client{Transport: r}),\n\t\t)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn provider.LanguageModel(t.Context(), model)\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_testEnv_104": {
      "name": "testEnv",
      "type": "function",
      "start_line": 104,
      "end_line": 136,
      "content_hash": "5b56edc942a419ed2a92939f8dfaceead1f9cf2e",
      "content": "func testEnv(t *testing.T) fakeEnv {\n\tworkingDir := filepath.Join(\"/tmp/nexora-test/\", t.Name())\n\tos.RemoveAll(workingDir)\n\n\terr := os.MkdirAll(workingDir, 0o755)\n\trequire.NoError(t, err)\n\n\tconn, err := db.Connect(t.Context(), t.TempDir())\n\trequire.NoError(t, err)\n\n\tq := db.New(conn)\n\tsessions := session.NewService(q)\n\tmessages := message.NewService(q)\n\n\tpermissions := permission.NewPermissionService(workingDir, true, []string{})\n\thistory := history.NewService(q, conn)\n\tlspClients := csync.NewMap[string, *lsp.Client]()\n\n\tt.Cleanup(func() {\n\t\tconn.Close()\n\t\tos.RemoveAll(workingDir)\n\t})\n\n\treturn fakeEnv{\n\t\tworkingDir,\n\t\tsessions,\n\t\tmessages,\n\t\tpermissions,\n\t\thistory,\n\t\tlspClients,\n\t}\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_testSessionAgent_137": {
      "name": "testSessionAgent",
      "type": "function",
      "start_line": 137,
      "end_line": 166,
      "content_hash": "1b9409fe3dbc62711cbb4578f9bd3da39dc148b5",
      "content": "func testSessionAgent(env fakeEnv, large, small fantasy.LanguageModel, systemPrompt string, tools ...fantasy.AgentTool) SessionAgent {\n\tlargeModel := Model{\n\t\tModel: large,\n\t\tCatwalkCfg: catwalk.Model{\n\t\t\tContextWindow:    200000,\n\t\t\tDefaultMaxTokens: 10000,\n\t\t},\n\t}\n\tsmallModel := Model{\n\t\tModel: small,\n\t\tCatwalkCfg: catwalk.Model{\n\t\t\tContextWindow:    200000,\n\t\t\tDefaultMaxTokens: 10000,\n\t\t},\n\t}\n\tagent := NewSessionAgent(SessionAgentOptions{\n\t\tLargeModel:           largeModel,\n\t\tSmallModel:           smallModel,\n\t\tSystemPromptPrefix:   \"\",\n\t\tSystemPrompt:         systemPrompt,\n\t\tDisableAutoSummarize: false,\n\t\tIsYolo:               true,\n\t\tSessions:             env.sessions,\n\t\tMessages:             env.messages,\n\t\tTools:                tools,\n\t\tAIOPS:                nil, // Tests don't use AIOPS\n\t})\n\treturn agent\n}\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_coderAgent_167": {
      "name": "coderAgent",
      "type": "function",
      "start_line": 167,
      "end_line": 223,
      "content_hash": "b03c44851bfc6efea8ec0c01040aa05239f7f56e",
      "content": "func coderAgent(r *vcr.Recorder, env fakeEnv, large, small fantasy.LanguageModel) (SessionAgent, error) {\n\t// Context for test agent setup - using background context for deterministic testing\n\tctx := context.Background()\n\tfixedTime := func() time.Time {\n\t\tt, _ := time.Parse(\"1/2/2006\", \"1/1/2025\")\n\t\treturn t\n\t}\n\tprompt, err := coderPrompt(\n\t\tprompt.WithTimeFunc(fixedTime),\n\t\tprompt.WithPlatform(\"linux\"),\n\t\tprompt.WithWorkingDir(filepath.ToSlash(env.workingDir)),\n\t)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tcfg, err := config.Init(env.workingDir, \"\", false)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\t// NOTE(@andreynering): Set a fixed config to ensure cassettes match\n\t// independently of user config on `$HOME/.config/nexora/nexora.json`.\n\tcfg.Options.Attribution = &config.Attribution{\n\t\tTrailerStyle:  \"co-authored-by\",\n\t\tGeneratedWith: true,\n\t}\n\n\tsystemPrompt, err := prompt.Build(ctx, large.Provider(), large.Model(), *cfg)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Get the model name for the bash tool\n\tmodelName := large.Model() // fallback to ID if Name not available\n\tif model := cfg.GetModel(large.Provider(), large.Model()); model != nil {\n\t\tmodelName = model.Name\n\t}\n\n\tallTools := []fantasy.AgentTool{\n\t\ttools.NewBashTool(env.permissions, env.workingDir, cfg.Options.Attribution, modelName),\n\t\ttools.NewDownloadTool(env.permissions, env.workingDir, r.GetDefaultClient()),\n\t\ttools.NewEditTool(env.lspClients, env.permissions, env.history, env.workingDir, nil),\n\t\ttools.NewMultiEditTool(env.lspClients, env.permissions, env.history, env.workingDir, nil),\n\t\ttools.NewFetchTool(env.permissions, env.workingDir, r.GetDefaultClient()),\n\t\ttools.NewGlobTool(env.workingDir),\n\t\ttools.NewGrepTool(env.workingDir),\n\t\ttools.NewLsTool(env.permissions, env.workingDir, cfg.Tools.Ls),\n\t\ttools.NewSourcegraphTool(r.GetDefaultClient()),\n\t\ttools.NewViewTool(env.lspClients, env.permissions, env.workingDir),\n\t\ttools.NewWriteTool(env.lspClients, env.permissions, env.history, env.workingDir),\n\t}\n\n\treturn testSessionAgent(env, large, small, systemPrompt, allTools...), nil\n}\n\n// createSimpleGoProject creates a simple Go project structure in the given directory.\n// It creates a go.mod file and a main.go file with a basic hello world program.",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_createSimpleGoProject_224": {
      "name": "createSimpleGoProject",
      "type": "function",
      "start_line": 224,
      "end_line": 235,
      "content_hash": "4bfc5493e28f381b8fee74297300d072c8967590",
      "content": "func createSimpleGoProject(t *testing.T, dir string) {\n\tgoMod := `module example.com/testproject\n\ngo 1.23\n`\n\terr := os.WriteFile(dir+\"/go.mod\", []byte(goMod), 0o644)\n\trequire.NoError(t, err)\n\n\tmainGo := `package main\n\nimport \"fmt\"\n",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_main_236": {
      "name": "main",
      "type": "function",
      "start_line": 236,
      "end_line": 242,
      "content_hash": "1594e65707916de1fdf09a4cff38e3fad295bcdb",
      "content": "func main() {\n\tfmt.Println(\"Hello, World!\")\n}\n`\n\terr = os.WriteFile(dir+\"/main.go\", []byte(mainGo), 0o644)\n\trequire.NoError(t, err)\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}