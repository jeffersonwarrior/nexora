{
  "file_path": "/work/external-deps/Context-Engine/vscode-extension/context-engine-uploader/auth_utils.js",
  "file_hash": "fdf0d1228dc12273801af38748d94ce0ca9904e3",
  "updated_at": "2025-12-26T17:34:21.752943",
  "symbols": {
    "function_getFetch_5": {
      "name": "getFetch",
      "type": "function",
      "start_line": 5,
      "end_line": 16,
      "content_hash": "62be655faba9e132bb65be130fd1de712fb58d69",
      "content": "function getFetch(deps) {\n  if (deps && typeof deps.fetchGlobal === 'function') {\n    return deps.fetchGlobal;\n  }\n  try {\n    if (typeof fetch === 'function') {\n      return fetch;\n    }\n  } catch (_) {\n  }\n  return null;\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_ensureAuthIfRequired_18": {
      "name": "ensureAuthIfRequired",
      "type": "function",
      "start_line": 18,
      "end_line": 123,
      "content_hash": "a0bc93c51e14c141103c74b2f3aa16f0db452b8f",
      "content": "async function ensureAuthIfRequired(endpoint, deps) {\n  try {\n    if (!deps || !deps.vscode || !deps.spawnSync || !deps.resolveBridgeCliInvocation || !deps.getWorkspaceFolderPath || !deps.log) {\n      return;\n    }\n    const { vscode, spawnSync, resolveBridgeCliInvocation, getWorkspaceFolderPath, log } = deps;\n    const fetchFn = getFetch(deps);\n    const raw = (endpoint || '').trim();\n    if (!raw) {\n      return;\n    }\n    if (!fetchFn) {\n      log('Auth status probe skipped: fetch is not available in this runtime.');\n      return;\n    }\n\n    let baseUrl = raw;\n    try {\n      const u = new URL(raw);\n      baseUrl = `${u.protocol}//${u.host}`;\n    } catch (_) {\n      baseUrl = raw.replace(/\\/+$/, '');\n    }\n    const statusUrl = `${baseUrl.replace(/\\/+$/, '')}/auth/status`;\n\n    let res;\n    try {\n      res = await fetchFn(statusUrl, { method: 'GET' });\n    } catch (error) {\n      log(`Auth status probe failed: ${error instanceof Error ? error.message : String(error)}`);\n      return;\n    }\n    if (!res || !res.ok) {\n      return;\n    }\n\n    let json;\n    try {\n      json = await res.json();\n    } catch (_) {\n      return;\n    }\n    if (!json || !json.enabled) {\n      return;\n    }\n\n    const invocation = resolveBridgeCliInvocation();\n    if (!invocation) {\n      log('Context Engine Uploader: ctxce CLI not found; skipping auth status check.');\n      return;\n    }\n\n    const backendUrl = baseUrl;\n    const workspacePath = (typeof getWorkspaceFolderPath === 'function' && getWorkspaceFolderPath()) || '';\n    const skipKey = `${backendUrl}::${workspacePath}`;\n    if (_skippedAuthCombos.has(skipKey)) {\n      return;\n    }\n\n    const args = [...invocation.args, 'auth', 'status', '--json', '--backend-url', backendUrl];\n    let result;\n    try {\n      result = spawnSync(invocation.command, args, {\n        cwd: getWorkspaceFolderPath() || process.cwd(),\n        env: {\n          ...process.env,\n          CTXCE_AUTH_BACKEND_URL: backendUrl,\n        },\n        encoding: 'utf8',\n      });\n    } catch (error) {\n      log(`Auth status check failed to run: ${error instanceof Error ? error.message : String(error)}`);\n      return;\n    }\n\n    const stdout = (result && result.stdout) || '';\n    let parsed;\n    try {\n      parsed = stdout ? JSON.parse(stdout) : null;\n    } catch (_) {\n      parsed = null;\n    }\n    const state = parsed && typeof parsed.state === 'string' ? parsed.state : undefined;\n    const exitCode = result && typeof result.status === 'number' ? result.status : undefined;\n    log(`Context Engine Uploader: auth status JSON state=${state || '<unknown>'} exitCode=${exitCode !== undefined ? exitCode : '<none>'}`);\n    if (state === 'ok' || result.status === 0) {\n      return;\n    }\n\n    const choice = await vscode.window.showInformationMessage(\n      'Context Engine: authentication is enabled on the backend but no valid session is available.',\n      'Sign In',\n      'Skip for now',\n    );\n    if (choice !== 'Sign In') {\n      _skippedAuthCombos.add(skipKey);\n      return;\n    }\n\n    await runAuthLoginFlow(backendUrl, deps);\n  } catch (error) {\n    if (deps && typeof deps.log === 'function') {\n      deps.log(`ensureAuthIfRequired error: ${error instanceof Error ? error.message : String(error)}`);\n    }\n  }\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_runAuthLoginFlow_125": {
      "name": "runAuthLoginFlow",
      "type": "function",
      "start_line": 125,
      "end_line": 246,
      "content_hash": "a0be55b57309c6d4d1e546e8cc1e745c8d3d47ce",
      "content": "async function runAuthLoginFlow(explicitBackendUrl, deps) {\n  if (!deps || !deps.vscode || !deps.spawn || !deps.resolveBridgeCliInvocation || !deps.getWorkspaceFolderPath || !deps.attachOutput || !deps.log) {\n    return;\n  }\n  const { vscode, spawn, resolveBridgeCliInvocation, getWorkspaceFolderPath, attachOutput, log } = deps;\n  let endpoint = '';\n  try {\n    if (deps && typeof deps.getEffectiveConfig === 'function') {\n      const cfg = deps.getEffectiveConfig();\n      endpoint = (cfg.get('endpoint') || '').trim();\n    }\n  } catch (_) {\n    endpoint = '';\n  }\n  if (!endpoint) {\n    const settings = vscode.workspace.getConfiguration('contextEngineUploader');\n    endpoint = (settings.get('endpoint') || '').trim();\n  }\n  let backendUrl = explicitBackendUrl || endpoint;\n  if (!backendUrl) {\n    vscode.window.showErrorMessage('Context Engine Uploader: backend endpoint is not configured (contextEngineUploader.endpoint).');\n    return;\n  }\n\n  try {\n    const u = new URL(backendUrl);\n    backendUrl = `${u.protocol}//${u.host}`;\n  } catch (_) {\n    backendUrl = backendUrl.replace(/\\/+$/, '');\n  }\n\n  const mode = await vscode.window.showQuickPick(\n    ['Token (shared dev token)', 'Username / password'],\n    { placeHolder: 'Select Context Engine auth method' },\n  );\n  if (!mode) {\n    return;\n  }\n\n  const invocation = resolveBridgeCliInvocation();\n  if (!invocation) {\n    vscode.window.showErrorMessage('Context Engine Uploader: unable to locate ctxce CLI for auth.');\n    return;\n  }\n  const cwd = getWorkspaceFolderPath() || process.cwd();\n\n  if (mode.startsWith('Token')) {\n    const token = await vscode.window.showInputBox({\n      prompt: 'Enter Context Engine shared auth token',\n      password: true,\n      ignoreFocusOut: true,\n    });\n    if (!token) {\n      return;\n    }\n    const args = [...invocation.args, 'auth', 'login'];\n    const env = {\n      ...process.env,\n      CTXCE_AUTH_BACKEND_URL: backendUrl,\n      CTXCE_AUTH_TOKEN: token,\n    };\n    await new Promise(resolve => {\n      const child = spawn(invocation.command, args, { cwd, env });\n      attachOutput(child, 'auth');\n      child.on('error', error => {\n        log(`ctxce auth login (token) failed to start: ${error instanceof Error ? error.message : String(error)}`);\n        vscode.window.showErrorMessage('Context Engine Uploader: auth login failed to start. See output for details.');\n        resolve();\n      });\n      child.on('close', code => {\n        if (code === 0) {\n          vscode.window.showInformationMessage('Context Engine Uploader: auth login successful.');\n        } else {\n          vscode.window.showErrorMessage(`Context Engine Uploader: auth login failed with exit code ${code}. See output for details.`);\n        }\n        resolve();\n      });\n    });\n    return;\n  }\n\n  const username = await vscode.window.showInputBox({\n    prompt: 'Enter Context Engine username',\n    ignoreFocusOut: true,\n  });\n  if (!username) {\n    return;\n  }\n  const password = await vscode.window.showInputBox({\n    prompt: 'Enter Context Engine password',\n    password: true,\n    ignoreFocusOut: true,\n  });\n  if (!password) {\n    return;\n  }\n\n  const args = [...invocation.args, 'auth', 'login'];\n  const env = {\n    ...process.env,\n    CTXCE_AUTH_BACKEND_URL: backendUrl,\n    CTXCE_AUTH_USERNAME: username,\n    CTXCE_AUTH_PASSWORD: password,\n  };\n  await new Promise(resolve => {\n    const child = spawn(invocation.command, args, { cwd, env });\n    attachOutput(child, 'auth');\n    child.on('error', error => {\n      log(`ctxce auth login failed to start: ${error instanceof Error ? error.message : String(error)}`);\n      vscode.window.showErrorMessage('Context Engine Uploader: auth login failed to start. See output for details.');\n      resolve();\n    });\n    child.on('close', code => {\n      if (code === 0) {\n        vscode.window.showInformationMessage('Context Engine Uploader: auth login successful.');\n      } else {\n        vscode.window.showErrorMessage(`Context Engine Uploader: auth login failed with exit code ${code}. See output for details.`);\n      }\n      resolve();\n    });\n  });\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}