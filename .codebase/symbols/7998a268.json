{
  "file_path": "/work/.local/tools/modelscan/sdk/storage/storage.go",
  "file_hash": "5db2950d737a566971be550c02f4a925d47cc047",
  "updated_at": "2025-12-26T17:34:24.441401",
  "symbols": {
    "struct_Storage_14": {
      "name": "Storage",
      "type": "struct",
      "start_line": 14,
      "end_line": 24,
      "content_hash": "c1d87af2c539467ffe02a86a2f14d7ab075f5bef",
      "content": "type Storage struct {\n\tdb             *sql.DB\n\tAgents         *AgentRepository\n\tTasks          *TaskRepository\n\tMessages       *MessageRepository\n\tTeams          *TeamRepository\n\tToolExecutions *ToolExecutionRepository\n\tdataRetention  time.Duration\n}\n\n// NewStorage creates a new storage instance with all repositories",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "function_NewStorage_25": {
      "name": "NewStorage",
      "type": "function",
      "start_line": 25,
      "end_line": 37,
      "content_hash": "852303a89344944b2cebbcbb978ed9b633b294d5",
      "content": "func NewStorage(db *sql.DB, dataRetention time.Duration) *Storage {\n\treturn &Storage{\n\t\tdb:             db,\n\t\tAgents:         NewAgentRepository(db),\n\t\tTasks:          NewTaskRepository(db),\n\t\tMessages:       NewMessageRepository(db),\n\t\tTeams:          NewTeamRepository(db),\n\t\tToolExecutions: NewToolExecutionRepository(db),\n\t\tdataRetention:  dataRetention,\n\t}\n}\n\n// NewAgentWithDefaults creates a new agent with default values",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_NewAgentWithDefaults_38": {
      "name": "NewAgentWithDefaults",
      "type": "method",
      "start_line": 38,
      "end_line": 50,
      "content_hash": "f1b4b1e8c17b06a5597bedf9e3719f4bb190c3f4",
      "content": "func (s *Storage) NewAgentWithDefaults(name, agentType string, capabilities []string) *Agent {\n\treturn &Agent{\n\t\tID:           uuid.New().String(),\n\t\tName:         name,\n\t\tCapabilities: capabilities,\n\t\tConfig:       fmt.Sprintf(`{\"type\": \"%s\", \"version\": \"1.0\"}`, agentType),\n\t\tStatus:       \"idle\",\n\t\tCreatedAt:    time.Now(),\n\t\tUpdatedAt:    time.Now(),\n\t}\n}\n\n// NewTaskWithDefaults creates a new task with default values",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_NewTaskWithDefaults_51": {
      "name": "NewTaskWithDefaults",
      "type": "method",
      "start_line": 51,
      "end_line": 65,
      "content_hash": "6cde6518bf53869f7f6916bcb36c9ca784416ce4",
      "content": "func (s *Storage) NewTaskWithDefaults(agentID, taskType, input string, priority int) *Task {\n\treturn &Task{\n\t\tID:        uuid.New().String(),\n\t\tAgentID:   agentID,\n\t\tType:      taskType,\n\t\tStatus:    \"pending\",\n\t\tPriority:  priority,\n\t\tInput:     input,\n\t\tMetadata:  make(map[string]interface{}),\n\t\tCreatedAt: time.Now(),\n\t\tUpdatedAt: time.Now(),\n\t}\n}\n\n// NewMessageWithDefaults creates a new message with default values",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_NewMessageWithDefaults_66": {
      "name": "NewMessageWithDefaults",
      "type": "method",
      "start_line": 66,
      "end_line": 78,
      "content_hash": "73acafda777729f158081d14984157ce3706d69a",
      "content": "func (s *Storage) NewMessageWithDefaults(taskID, agentID, messageType, content string) *Message {\n\treturn &Message{\n\t\tID:        uuid.New().String(),\n\t\tTaskID:    taskID,\n\t\tAgentID:   agentID,\n\t\tType:      messageType,\n\t\tContent:   content,\n\t\tMetadata:  make(map[string]interface{}),\n\t\tCreatedAt: time.Now(),\n\t}\n}\n\n// NewTeamWithDefaults creates a new team with default values",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_NewTeamWithDefaults_79": {
      "name": "NewTeamWithDefaults",
      "type": "method",
      "start_line": 79,
      "end_line": 91,
      "content_hash": "43628b6592e070c521720e562d119b360df6e08c",
      "content": "func (s *Storage) NewTeamWithDefaults(name, description string) *Team {\n\treturn &Team{\n\t\tID:          uuid.New().String(),\n\t\tName:        name,\n\t\tDescription: description,\n\t\tConfig:      `{\"version\": \"1.0\"}`,\n\t\tMetadata:    make(map[string]interface{}),\n\t\tCreatedAt:   time.Now(),\n\t\tUpdatedAt:   time.Now(),\n\t}\n}\n\n// NewToolExecutionWithDefaults creates a new tool execution with default values",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_NewToolExecutionWithDefaults_92": {
      "name": "NewToolExecutionWithDefaults",
      "type": "method",
      "start_line": 92,
      "end_line": 107,
      "content_hash": "f13dd5efb4a102c2dee3ffbcbba417d983f8bfac",
      "content": "func (s *Storage) NewToolExecutionWithDefaults(taskID, agentID, toolName, toolType, input string) *ToolExecution {\n\treturn &ToolExecution{\n\t\tID:        uuid.New().String(),\n\t\tTaskID:    taskID,\n\t\tAgentID:   agentID,\n\t\tToolName:  toolName,\n\t\tToolType:  toolType,\n\t\tInput:     input,\n\t\tStatus:    \"running\",\n\t\tDuration:  0,\n\t\tMetadata:  make(map[string]interface{}),\n\t\tStartedAt: time.Now(),\n\t}\n}\n\n// CleanupOldData removes old data based on retention policy",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CleanupOldData_108": {
      "name": "CleanupOldData",
      "type": "method",
      "start_line": 108,
      "end_line": 132,
      "content_hash": "1b6fa34f5829d95c15feaf82b154a22c4db81166",
      "content": "func (s *Storage) CleanupOldData(ctx context.Context) error {\n\tcutoffDate := time.Now().Add(-s.dataRetention)\n\n\t// Clean up old tasks\n\t_, err := s.db.ExecContext(ctx, \"DELETE FROM tasks WHERE created_at < ?\", cutoffDate)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to cleanup old tasks: %w\", err)\n\t}\n\n\t// Clean up old messages\n\t_, err = s.db.ExecContext(ctx, \"DELETE FROM messages WHERE created_at < ?\", cutoffDate)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to cleanup old messages: %w\", err)\n\t}\n\n\t// Clean up old tool executions\n\t_, err = s.db.ExecContext(ctx, \"DELETE FROM tool_executions WHERE started_at < ?\", cutoffDate)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to cleanup old tool executions: %w\", err)\n\t}\n\n\treturn nil\n}\n\n// GetStorageStats returns statistics about the storage",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_GetStorageStats_133": {
      "name": "GetStorageStats",
      "type": "method",
      "start_line": 133,
      "end_line": 188,
      "content_hash": "470cf4d2089e76cde14c0d0a9357a89a4caff469",
      "content": "func (s *Storage) GetStorageStats(ctx context.Context) (map[string]interface{}, error) {\n\tstats := make(map[string]interface{})\n\n\t// Count agents\n\tvar agentCount int\n\terr := s.db.QueryRowContext(ctx, \"SELECT COUNT(*) FROM agents\").Scan(&agentCount)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to count agents: %w\", err)\n\t}\n\tstats[\"agents\"] = agentCount\n\n\t// Count tasks\n\tvar taskCount int\n\terr = s.db.QueryRowContext(ctx, \"SELECT COUNT(*) FROM tasks\").Scan(&taskCount)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to count tasks: %w\", err)\n\t}\n\tstats[\"tasks\"] = taskCount\n\n\t// Count messages\n\tvar messageCount int\n\terr = s.db.QueryRowContext(ctx, \"SELECT COUNT(*) FROM messages\").Scan(&messageCount)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to count messages: %w\", err)\n\t}\n\tstats[\"messages\"] = messageCount\n\n\t// Count teams\n\tvar teamCount int\n\terr = s.db.QueryRowContext(ctx, \"SELECT COUNT(*) FROM teams\").Scan(&teamCount)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to count teams: %w\", err)\n\t}\n\tstats[\"teams\"] = teamCount\n\n\t// Count tool executions\n\tvar toolExecCount int\n\terr = s.db.QueryRowContext(ctx, \"SELECT COUNT(*) FROM tool_executions\").Scan(&toolExecCount)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to count tool executions: %w\", err)\n\t}\n\tstats[\"tool_executions\"] = toolExecCount\n\n\t// Database size (SQLite specific)\n\tvar dbSize int64\n\terr = s.db.QueryRowContext(ctx, \"SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size()\").Scan(&dbSize)\n\tif err != nil {\n\t\t// Fallback if pragma queries fail\n\t\tdbSize = -1\n\t}\n\tstats[\"database_size_bytes\"] = dbSize\n\n\treturn stats, nil\n}\n\n// PerformHealthCheck performs a health check on the storage",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_PerformHealthCheck_189": {
      "name": "PerformHealthCheck",
      "type": "method",
      "start_line": 189,
      "end_line": 210,
      "content_hash": "d9a31d3e2ba6569dd9d3e74280f6c98076492cba",
      "content": "func (s *Storage) PerformHealthCheck(ctx context.Context) error {\n\t// Test database connection\n\terr := s.db.PingContext(ctx)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"database ping failed: %w\", err)\n\t}\n\n\t// Test a simple query\n\tvar result int\n\terr = s.db.QueryRowContext(ctx, \"SELECT 1\").Scan(&result)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"database query failed: %w\", err)\n\t}\n\n\tif result != 1 {\n\t\treturn fmt.Errorf(\"unexpected query result: %d\", result)\n\t}\n\n\treturn nil\n}\n\n// Close closes the database connection",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_Close_211": {
      "name": "Close",
      "type": "method",
      "start_line": 211,
      "end_line": 218,
      "content_hash": "77dab9cec6c14d48615eaa2b3216bfafa82c069f",
      "content": "func (s *Storage) Close() error {\n\tif s.db != nil {\n\t\treturn s.db.Close()\n\t}\n\treturn nil\n}\n\n// SetAllAgentsIdle sets all agents to idle status (for startup zero-state)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_SetAllAgentsIdle_219": {
      "name": "SetAllAgentsIdle",
      "type": "method",
      "start_line": 219,
      "end_line": 230,
      "content_hash": "035fe381a15998da7fb2e27d2c18bec55060ff23",
      "content": "func (s *Storage) SetAllAgentsIdle(ctx context.Context) error {\n\tquery := `UPDATE agents SET status = 'idle', updated_at = CURRENT_TIMESTAMP WHERE status != 'idle'`\n\n\t_, err := s.db.ExecContext(ctx, query)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to set all agents idle: %w\", err)\n\t}\n\n\treturn nil\n}\n\n// CancelAllPendingTasks cancels all pending tasks (for startup zero-state)",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_CancelAllPendingTasks_231": {
      "name": "CancelAllPendingTasks",
      "type": "method",
      "start_line": 231,
      "end_line": 242,
      "content_hash": "4306a57795d1b69d400c1d98bf4c1cd184860920",
      "content": "func (s *Storage) CancelAllPendingTasks(ctx context.Context) error {\n\tquery := `UPDATE tasks SET status = 'cancelled', updated_at = CURRENT_TIMESTAMP WHERE status = 'pending' OR status = 'running'`\n\n\t_, err := s.db.ExecContext(ctx, query)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to cancel all pending tasks: %w\", err)\n\t}\n\n\treturn nil\n}\n\n// InitializeZeroState performs startup zero-state initialization",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    },
    "method_InitializeZeroState_243": {
      "name": "InitializeZeroState",
      "type": "method",
      "start_line": 243,
      "end_line": 255,
      "content_hash": "23880e919fd5920d9bb7f7bb2942b6befe64f427",
      "content": "func (s *Storage) InitializeZeroState(ctx context.Context) error {\n\t// Set all agents to idle\n\tif err := s.SetAllAgentsIdle(ctx); err != nil {\n\t\treturn fmt.Errorf(\"failed to set agents idle: %w\", err)\n\t}\n\n\t// Cancel all pending tasks\n\tif err := s.CancelAllPendingTasks(ctx); err != nil {\n\t\treturn fmt.Errorf(\"failed to cancel pending tasks: %w\", err)\n\t}\n\n\treturn nil\n}",
      "pseudo": "",
      "tags": [],
      "qdrant_ids": []
    }
  }
}