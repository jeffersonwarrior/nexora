name: Request AI Fix for CI Failures

on:
  workflow_run:
    workflows: ["lint", "build"]  # Trigger after these workflows
    types:
      - completed
  workflow_dispatch:
    inputs:
      issue_url:
        description: 'Issue URL to analyze'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  request-ai-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Request AI Fix via API
        run: |
          # Extract information from the failed workflow
          WORKFLOW_URL="${{ github.event.workflow_run.html_url || github.event.repository.html_url }}"
          ISSUE_URL="${{ github.event.inputs.issue_url || '' }}"
          
          # Prepare the request payload
          cat > fix-request.json << EOF
          {
            "model": "zai-glm-4.6",
            "provider": "cerebras",
            "messages": [
              {
                "role": "system",
                "content": "You are an AI assistant helping to fix CI failures in the Nexora project. Analyze the provided failure information and generate a patch or detailed fix instructions."
              },
              {
                "role": "user",
                "content": "CI workflow failed. Please analyze and provide a fix.\n\nRepository: ${{ github.repository }}\nWorkflow URL: $WORKFLOW_URL\nIssue URL: $ISSUE_URL\n\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\n\nPlease:\n1. Identify the root cause of the failure\n2. Provide specific code fixes or patches\n3. Explain what went wrong\n4. Suggest how to prevent similar issues"
              }
            ],
            "max_tokens": 4000,
            "temperature": 0.1
          }
          EOF
          
          echo "ü§ñ Requesting AI fix for CI failure..."
          echo "Workflow: $WORKFLOW_URL"
          echo "Issue: $ISSUE_URL"
          
          # Call the AI API
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $AI_API_KEY" \
            -d @fix-request.json \
            "$AI_API_ENDPOINT" > ai-response.json
          
          # Extract the AI response
          AI_RESPONSE=$(cat ai-response.json | jq -r '.choices[0].message.content // "No response received"')
          
          # Create or update an issue with the AI response
          if [[ -n "$ISSUE_URL" ]]; then
            # Comment on existing issue
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed -n 's/.*\/issues\/\([0-9]*\).*/\1/p')
            gh issue comment "$ISSUE_NUMBER" --body "## ü§ñ AI Analysis and Fix

$AI_RESPONSE

---
*Generated by AI Fix Request workflow on $(date)*" || echo "Failed to comment on issue"
          else
            # Create new issue
            gh issue create \
              --title "ü§ñ AI Fix Request: CI Failure in ${{ github.event.workflow_run.name || 'Manual Request' }}" \
              --body "## CI Failure Detected

**Workflow:** ${{ github.event.workflow_run.name || 'Manual Request' }}
**Branch:** ${{ github.ref_name }}
**Commit:** ${{ github.sha }}
**Workflow URL:** $WORKFLOW_URL

## ü§ñ AI Analysis and Fix

$AI_RESPONSE

---
*Generated by AI Fix Request workflow on $(date)*

## Next Steps
1. Review the AI-provided fixes above
2. Apply the suggested changes
3. Test the fixes locally
4. Create a PR with the fixes" \
              --label "ai-fix-request,ci-failure" || echo "Failed to create issue"
          fi
        env:
          AI_API_ENDPOINT: ${{ secrets.AI_API_ENDPOINT || 'https://api.cerebras.ai/v1/chat/completions' }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  alternative-fix:
    runs-on: ubuntu-latest
    if: always() && failure()  # Run if the above fails
    steps:
      - name: Create issue for manual fixing
        run: |
          echo "‚ö†Ô∏è AI fix request failed, creating manual fix request..."
          
          gh issue create \
            --title "üîß Manual Fix Request: CI Failure in ${{ github.event.workflow_run.name }}" \
            --body "## CI Failure Detected

**Workflow:** ${{ github.event.workflow_run.name }}
**Branch:** ${{ github.ref_name }}
**Commit:** ${{ github.sha }}

The workflow failed and the AI fix request could not be completed.

## Manual Fix Steps:
1. [Check the workflow logs](${{ github.event.workflow_run.html_url }})
2. Identify the specific error messages
3. Apply appropriate fixes
4. Create a PR with the fixes

## Common Fixes:
- **Lint failures:** Run \`golangci-lint run --fix\` locally
- **Build failures:** Check for missing dependencies with \`go mod tidy\`
- **Test failures:** Run tests locally with \`go test ./...\`
- **Formatting issues:** Run \`gofmt -s -w .\`"

Please review the workflow logs and apply the necessary fixes." \
            --label "manual-fix-request,ci-failure" || echo "Failed to create manual fix issue"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}