name: Dependency Management

on:
  schedule:
    - cron: '0 5 * * 1'  # Every Monday at 5 AM UTC
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        type: choice
        options:
          - 'all'
          - 'security'
          - 'major'
          - 'minor'
        default: 'security'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Update Go dependencies
        run: |
          MODE="${{ github.event.inputs.update_type || 'security' }}"
          echo "Update mode: $MODE"
          
          case "$MODE" in
            "security")
              echo "üîí Updating security dependencies only..."
              # Only update known vulnerable packages
              go get -u=patch github.com/...
              ;;
            "all")
              echo "üîÑ Updating all dependencies..."
              go get -u ./...
              ;;
            "minor")
              echo "‚¨ÜÔ∏è Updating minor versions..."
              go get -u=patch ./...
              ;;
            "major")
              echo "‚ö†Ô∏è Updating major versions (risky)..."
              go get -u ./...
              ;;
          esac
          
          # Tidy up
          go mod tidy
          
          # Check for issues
          if ! go mod verify; then
            echo "‚ùå Dependency verification failed"
            exit 1
          fi

      - name: Test updates
        run: |
          # Quick test to ensure nothing breaks
          make test-quick
          
          # Test build
          make build

      - name: Create PR if changes made
        if: always()
        run: |
          # Check if changes were made
          if [[ -n $(git status --porcelain go.mod go.sum) ]]; then
            echo "‚úÖ Dependencies updated, creating PR..."
            
            # Create branch
            BRANCH_NAME="deps/update-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git add go.mod go.sum
            git commit -m "chore: update Go dependencies

            - Updated dependencies in ${{ github.event.inputs.update_type || 'security' }} mode
            - Auto-generated by CI/CD pipeline

            üíò Generated with Crush"

            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            PR_URL=$(gh pr create \
              --title "üîÑ Dependency Update ($(date +%Y-%m-%d))" \
              --body "## Automated Dependency Update

            **Update Type:** ${{ github.event.inputs.update_type || 'security' }}
            **Triggered:** $(date)

            ### Changes
            - Updated Go dependencies in \`go.mod\`
            - Updated checksums in \`go.sum\`
            - All tests passed after update

            ### Verification
            - ‚úÖ Dependencies verified
            - ‚úÖ Tests passed
            - ‚úÖ Build successful

            Please review and merge if everything looks correct." \
              --label "dependencies,automation" \
              --assignee ${{ github.actor }} || echo "PR creation failed")
            
            echo "üîó PR created: $PR_URL"
          else
            echo "‚ÑπÔ∏è No dependency updates needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-workflows:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Update GitHub Actions
        run: |
          echo "üîÑ Checking for GitHub Actions updates..."
          
          # Find all workflow files
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
            echo "Checking $file..."
            
            # Update major actions to latest versions
            sed -i 's|uses: actions/checkout@v[0-9]*|uses: actions/checkout@v4|g' "$file"
            sed -i 's|uses: actions/setup-go@v[0-9]*|uses: actions/setup-go@v5|g' "$file"
            sed -i 's|uses: actions/cache@v[0-9]*|uses: actions/cache@v4|g' "$file"
            sed -i 's|uses: actions/upload-artifact@v[0-9]*|uses: actions/upload-artifact@v4|g' "$file"
            sed -i 's|uses: actions/download-artifact@v[0-9]*|uses: actions/download-artifact@v4|g' "$file"
            sed -i 's|uses: codecov/codecov-action@v[0-9]*|uses: codecov/codecov-action@v4|g' "$file"
            sed -i 's|uses: softprops/action-gh-release@v[0-9]*|uses: softprops/action-gh-release@v2|g' "$file"
          done

      - name: Create PR for workflow updates
        if: always()
        run: |
          # Check if changes were made
          if [[ -n $(git status --porcelain .github/workflows) ]]; then
            echo "‚úÖ Workflows updated, creating PR..."
            
            # Create branch
            BRANCH_NAME="ci/workflow-update-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git add .github/workflows/
            git commit -m "ci: update GitHub Actions versions

            - Updated actions to latest stable versions
            - Improved security with newer action releases
            - Auto-generated by CI/CD pipeline

            üíò Generated with Crush"

            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            PR_URL=$(gh pr create \
              --title "üîÑ GitHub Actions Update ($(date +%Y-%m-%d))" \
              --body "## Automated Workflow Update

            **Changes:**
            - Updated GitHub Actions to latest stable versions
            - Improved security and compatibility
            
            Please review and merge if everything looks correct." \
              --label "ci,dependencies" \
              --assignee ${{ github.actor }} || echo "PR creation failed")
            
            echo "üîó PR created: $PR_URL"
          else
            echo "‚ÑπÔ∏è No workflow updates needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - name: Run govulncheck
        run: |
          echo "üîí Running security vulnerability check..."
          
          # Install govulncheck
          go install golang.org/x/vuln/cmd/govulncheck@latest
          
          # Run vulnerability check
          govulncheck ./... || echo "Vulnerabilities found (see details above)"
          
          # Check for known critical vulnerabilities
          CRITICAL_VULNS=$(govulncheck ./... 2>/1 | grep -c "CRITICAL" || echo "0")
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "‚ùå $CRITICAL_VULNS critical vulnerabilities found!"
            exit 1
          fi

      - name: Create issue for security vulnerabilities
        if: failure()
        run: |
          # Create GitHub issue for vulnerabilities
          gh issue create \
            --title "üîí Security Vulnerabilities Found" \
            --body "## Security Issues Detected

          The automated security scan found vulnerabilities in the project dependencies.

          **Next Steps:**
          1. Review the vulnerability report
          2. Update affected dependencies
          3. Test the updates
          4. Deploy the fixed version

          **Priority:** High - Security vulnerabilities should be addressed promptly.

          ---
          *This issue was auto-generated by the security audit workflow.*" \
            --label "security,critical" \
            --assignee ${{ github.actor }} || echo "Issue creation failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}