name: Dependency Update

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: false

      - name: Update dependencies
        run: |
          # Get latest dependencies
          go get -u ./...
          go mod tidy
          
          # Check if there are any changes
          if [[ -n $(git status --porcelain go.mod go.sum) ]]; then
            echo "Changes detected, creating PR..."
            
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # Create branch
            BRANCH_NAME="deps/update-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git add go.mod go.sum
            git commit -m "deps: update Go dependencies
            
            Auto-generated dependency update.
            
            - Updated all direct and indirect dependencies
            - Ran go mod tidy to clean up unused dependencies
            
            ðŸ’˜ Generated with Crush"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            if command -v gh &> /dev/null; then
              PR_URL=$(gh pr create \
                --title "ðŸ”„ deps: update Go dependencies" \
                --body "This PR automatically updates Go dependencies to their latest versions.
                
                **Changes:**
                - All direct dependencies updated to latest compatible versions
                - Indirect dependencies updated
                - go.mod and go.sum updated accordingly
                
                Please review the changes and ensure compatibility before merging.
                
                After merging, monitor CI for any issues.
                
                ---
                *Generated by dependency update workflow on $(date)*" \
                --label "dependencies,automated" \
                --assignee ${{ github.actor }} || echo "PR creation failed")
              
              echo "ðŸ”— Dependency update PR created: $PR_URL"
            fi
          else
            echo "No dependency updates needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}