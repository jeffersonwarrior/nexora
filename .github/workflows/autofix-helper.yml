name: Auto-Fix Helper

on:
  workflow_call:
    inputs:
      fix-type:
        description: 'Type of fix to apply'
        required: false
        default: 'all'
        type: string
      create-pr:
        description: 'Create PR for auto-fixes'
        required: false
        default: 'true'
        type: string
  workflow_dispatch:
    inputs:
      fix-type:
        description: 'Type of fix to apply'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - dependencies
        - formatting
        - linting
        - build
        - tests
        - go-sum
      create-pr:
        description: 'Create PR for auto-fixes'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true
      
      - name: Install tools
        run: |
          # Install golangci-lint for lint fixes
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.60.3
          # Install goimports for import fixes
          go install golang.org/x/tools/cmd/goimports@latest
      
      - name: Make autofix script executable
        run: chmod +x scripts/autofix.sh
      
      - name: Run auto-fix
        id: autofix
        run: |
          echo "üîß Running auto-fix for: ${{ github.event.inputs.fix-type || inputs.fix-type }}"
          ./scripts/autofix.sh ${{ github.event.inputs.fix-type || inputs.fix-type }} /tmp/autofix-result.log
          
          # Check if changes were made
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù Auto-fix changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes needed"
          fi
      
      - name: Upload auto-fix log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autofix-log
          path: /tmp/autofix-result.log
      
      - name: Create PR for auto-fixes
        if: steps.autofix.outputs.changes == 'true' && (github.event.inputs.create-pr == 'true' || inputs.create-pr == 'true')
        run: |
          echo "üîó Creating auto-fix PR..."
          
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Create branch
          BRANCH_NAME="autofix/${{ github.event.inputs.fix-type || inputs.fix-type }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Add all changes
          git add .
          
          # Commit with detailed message
          git commit -m "autofix: ${{ github.event.inputs.fix-type || inputs.fix-type }} fixes
          
          Auto-generated by GitHub Actions workflow.
          Fix type: ${{ github.event.inputs.fix-type || inputs.fix-type }}
          Timestamp: $(date)
          
          - Go dependencies updated
          - Code formatting fixed
          - Linting issues resolved
          - Import organization improved"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Create PR
          if command -v gh &> /dev/null; then
            PR_URL=$(gh pr create \
              --title "ü§ñ Auto-fix: ${{ github.event.inputs.fix-type || inputs.fix-type }}" \
              --body "This PR was auto-generated by the workflow to fix ${{ github.event.inputs.fix-type || inputs.fix-type }} issues.
              
              **Auto-fixes applied:**
              - Dependency updates and cleanup
              - Code formatting improvements  
              - Linting issue resolution
              - Import organization
              
              Please review the changes and merge if they look correct.
              
              ---
              *Generated by auto-fix workflow on $(date)*" \
              --label "autofix" \
              --assignee ${{ github.actor }} || echo "PR creation failed")
            
            echo "üîó Auto-fix PR created: $PR_URL"
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            
            # Comment on triggering issue/PR if exists
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "üìù Created auto-fix PR from manual trigger"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on original issue (if applicable)
        if: steps.autofix.outputs.changes == 'true' && (github.event.inputs.create-pr == 'true' || inputs.create-pr == 'true')
        run: |
          echo "üí¨ Commenting on original issue..."
          # This would need to be customized based on how this workflow is called
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}