name: Greptile Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  greptile-review:
    name: Greptile Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin main
            CHANGED=$(git diff --name-only origin/main...HEAD | tr '\n' ' ')
          else
            CHANGED="."
          fi
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED"

      - name: Run Greptile Review
        run: |
          # Note: You'll need to set up Greptile API token as a secret
          curl -X POST "https://api.greptile.com/v2/reviews" \
            -H "Authorization: Bearer ${{ secrets.GREPTILE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "repository": "${{ github.repository }}",
              "branch": "${{ github.head_ref || github.ref_name }}",
              "filechanges": "${{ steps.changed-files.outputs.changed }}",
              "instructions": "Please review this code for best practices, potential bugs, security issues, and suggest improvements. Focus on Go-specific patterns and idiomatic code."
            }' | tee greptile-response.json

      - name: Post review comment
        if: always()
        run: |
          # Extract review from response and post as PR comment
          REVIEW_TEXT=$(jq -r '.review // "Review processing completed. Check Greptile dashboard for details."' greptile-response.json)
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸ¤– Greptile Code Review

          $REVIEW_TEXT

          ---
          *Review generated by Greptile*"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}