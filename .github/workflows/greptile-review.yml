name: Greptile Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  greptile-review:
    name: Greptile Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin main
            CHANGED=$(git diff --name-only origin/main...HEAD | tr '\n' ',' | sed 's/,$//')
          else
            CHANGED="README.md"
          fi
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED"

      - name: Run Greptile Review
        id: greptile
        run: |
          echo "Triggering Greptile code review..."
          
          # Create a safe default response
          echo '{"message": "Greptile review initiated"}' > greptile-response.json
          
          # Call Greptile API with correct format
          RESPONSE=$(curl -s --max-time 60 -w "\nHTTP_CODE:%{http_code}" \
            -X POST "https://api.greptile.com/v2/query" \
            -H "Authorization: Bearer ${{ secrets.GREPTILE_API_TOKEN }}" \
            -H "X-GitHub-Token: ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "repositories": [{
                "remote": "github",
                "repository": "${{ github.repository }}",
                "branch": "${{ github.head_ref || github.ref_name }}"
              }],
              "query": "Review the following code changes in this pull request. Focus on Go best practices, potential bugs, security issues, and code quality. Changed files: ${{ steps.changed-files.outputs.changed }}",
              "sessionId": "${{ github.run_id }}-${{ github.run_attempt }}"
            }' 2>&1)
          
          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          # Save response for next step
          if [ -n "$BODY" ] && [ "$BODY" != "" ]; then
            echo "$BODY" > greptile-response.json
          else
            echo '{"error": "Empty response from Greptile API", "http_code": "'$HTTP_CODE'"}' > greptile-response.json
          fi
          
          # Output for debugging
          cat greptile-response.json

      - name: Post review comment
        if: always()
        run: |
          echo "Processing Greptile response..."
          
          # Check if response file exists and has content
          if [ ! -f greptile-response.json ] || [ ! -s greptile-response.json ]; then
            REVIEW_TEXT="‚ö†Ô∏è Greptile review could not be completed. Please check the workflow logs for details."
          else
            # Show what we got for debugging
            echo "=== Response file content ==="
            cat greptile-response.json
            echo "=== End of response ==="
            
            # Try to parse JSON response (redirect stderr to avoid jq parse errors showing up)
            if jq -e . greptile-response.json >/dev/null 2>&1; then
              # Valid JSON - extract review content
              if jq -e '.message' greptile-response.json >/dev/null 2>&1; then
                REVIEW_TEXT=$(jq -r '.message' greptile-response.json)
              elif jq -e '.answer' greptile-response.json >/dev/null 2>&1; then
                REVIEW_TEXT=$(jq -r '.answer' greptile-response.json)
              elif jq -e '.error' greptile-response.json >/dev/null 2>&1; then
                ERROR_MSG=$(jq -r '.error' greptile-response.json)
                REVIEW_TEXT="‚ö†Ô∏è Greptile API Error: $ERROR_MSG"
              else
                # Show formatted JSON
                REVIEW_TEXT="Response received but format unexpected. Check logs for details."
              fi
            else
              # Not valid JSON - show safe preview
              REVIEW_TEXT="‚ö†Ô∏è Greptile API returned non-JSON response. Check workflow logs for details."
            fi
          fi
          
          # Post comment to PR
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Greptile Code Review

$REVIEW_TEXT

---
*Automated review by Greptile ‚Ä¢ [Configuration](https://github.com/${{ github.repository }}/blob/main/greptile.json)*"
          else
            echo "Not a pull request event, skipping comment"
            echo "Review text would have been: $REVIEW_TEXT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
