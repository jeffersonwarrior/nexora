name: lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true
      
      - name: Run golangci-lint with auto-fix
        continue-on-error: true  # Don't fail CI on lint warnings
        run: |
          echo "üîç Running golangci-lint..."
          
          # First run to identify issues
          LINT_OUTPUT=$(golangci-lint run --timeout=10m --disable typecheck,unused,staticcheck 2>&1 || true)
          
          if echo "$LINT_OUTPUT" | grep -q "issues found"; then
            echo "üí• Lint issues found, attempting auto-fixes..."
            
            # Try to auto-fix with golangci-lint
            echo "üîß Attempting automatic fixes..."
            golangci-lint run --fix --timeout=10m --disable typecheck,unused,staticcheck || true
            
            # Run additional auto-fixes for common issues
            echo "üî§ Fixing imports..."
            if command -v goimports &> /dev/null; then
              find . -name "*.go" -exec goimports -w {} \;
            else
              go fmt ./...
            fi
            
            # Fix common formatting issues
            echo "üé® Fixing formatting..."
            go fmt ./...
            
            # Run final lint check
            echo "üîç Running final lint check..."
            golangci-lint run --timeout=10m --disable typecheck,unused,staticcheck
          else
            echo "‚úÖ No lint issues found"
            golangci-lint run --timeout=10m --disable typecheck,unused,staticcheck
          fi
      
      - name: Check go.mod and go.sum with auto-fix
        run: |
          set +e
          echo "üîç Checking go.mod and go.sum..."
          
          # Check for issues
          go mod tidy
          GO_DIFF=$(git status --porcelain go.mod go.sum || true)
          
          if [[ -n "$GO_DIFF" ]]; then
            echo "üîß go.mod/go.sum issues detected and auto-fixed"
            git add go.mod go.sum
            echo "git status: $GO_DIFF"
          else
            echo "‚úÖ go.mod and go.sum are in sync"
          fi
      
      - name: Check formatting with auto-fix
        run: |
          set +e
          echo "üé® Checking code formatting..."
          
          # Find files that need formatting
          UNFORMATTED=$(gofmt -s -l . || true)
          
          if [[ -n "$UNFORMATTED" ]]; then
            echo "üí• Code formatting issues found, auto-fixing..."
            echo "Files to format:"
            echo "$UNFORMATTED"
            
            # Auto-fix formatting
            gofmt -s -w .
            
            echo "‚úÖ Formatting fixed for $(echo "$UNFORMATTED" | wc -l | tr -d ' ') files"
            git add .
          else
            echo "‚úÖ Code is properly formatted"
          fi
      
      - name: Check for go vet issues
        run: go vet ./...
      
      - name: Run staticcheck
        if: false  # Disabled: too strict for unused code warnings
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...
      
      - name: Run ineffassign
        if: false  # Disabled: covered by golangci-lint
        run: |
          go install github.com/gordonklaus/ineffassign@latest
          ineffassign ./...
      
      - name: Create auto-fix PR if changes made
        if: always()
        run: |
          # Check if any changes were made during auto-fixes
          if [[ -n $(git status --porcelain) ]]; then
            echo "‚úÖ Auto-fixes applied during linting, creating PR..."
            
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # Create branch
            BRANCH_NAME="autofix/lint-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit fixes
            git add .
            git commit -m "autofix: resolve linting and formatting issues
            
            - Fixed golangci-lint issues
            - Fixed code formatting
            - Updated import organization"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR if GitHub CLI is available
            if command -v gh &> /dev/null; then
              PR_URL=$(gh pr create --title "ü§ñ Auto-fix: Resolve linting issues" --body "This PR was auto-generated to fix linting and formatting issues detected in the CI pipeline.

**Auto-fixes applied:**
- Linting fixes
- Code formatting
- Import organization
- go.mod/go.sum cleanup

Please review and merge if the fixes look correct." --label "autofix,linting" --assignee ${{ github.actor }} || echo "PR creation failed")
              echo "üîó Auto-fix PR created: $PR_URL"
            fi
          else
            echo "‚ÑπÔ∏è No auto-fixes were needed during linting"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}