name: build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: ['1.25.5']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check disk space
        run: df -h

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      
      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-

      - name: Clean before building
        run: |
          # Clean Go cache and mod cache to prevent disk space issues
          go clean -cache -testcache -modcache
          # Limit Go build cache size to prevent filling /tmp
          go env -w GOCACHE=/tmp/go-cache
          mkdir -p /tmp/go-cache
          du -sh ~/.cache/go-build 2>/dev/null || echo "No go-build cache found"
      
      - name: Download dependencies
        run: go mod download && go mod verify
      
      - name: Run tests
        run: |
          # Capture test output for analysis
          set +e
          TEST_OUTPUT=$(go test -v -race -timeout=10m -coverprofile=coverage.out $(go list ./... | grep -v '/qa$') 2>&1)
          TEST_EXIT_CODE=$?
          echo "$TEST_OUTPUT"
          
          # If tests failed, try auto-fixes
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "üí• Tests failed, attempting auto-fixes..."
            
            # Auto-fix common issues
            if echo "$TEST_OUTPUT" | grep -q "no matching versions"; then
              echo "üîß Updating dependencies..."
              go get -u ./...
              go mod tidy
            fi
            
            if echo "$TEST_OUTPUT" | grep -q "build constraints exclude all Go files"; then
              echo "üîß Tidying modules..."
              go mod tidy
            fi
            
            if echo "$TEST_OUTPUT" | grep -q "cannot find"; then
              echo "üîß Downloading missing modules..."
              go mod download
            fi
            
            # Retry tests after auto-fixes
            echo "üîÑ Retrying tests after auto-fixes..."
            go test -v -race -timeout=10m -coverprofile=coverage.out $(go list ./... | grep -v '/qa$')
          fi
      
      - name: Set Go version
        run: echo "VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')" >> $GITHUB_ENV
      
      - name: Build binary
        run: |
          # Capture build output for analysis
          set +e
          BUILD_OUTPUT=$(go build -ldflags="-X github.com/nexora/nexora/internal/version.Version=$VERSION" -o nexora . 2>&1)
          BUILD_EXIT_CODE=$?
          
          # If build failed, try auto-fixes
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "üí• Build failed, attempting auto-fixes..."
            echo "$BUILD_OUTPUT"
            
            # Auto-fix common build issues
            if echo "$BUILD_OUTPUT" | grep -q "no matching versions"; then
              echo "üîß Updating dependencies..."
              go get -u ./...
              go mod tidy
            fi
            
            if echo "$BUILD_OUTPUT" | grep -q "package .* is not in GOROOT"; then
              echo "üîß Fixing module issues..."
              go mod download
              go mod tidy
            fi
            
            if echo "$BUILD_OUTPUT" | grep -q "undefined: .*"; then
              echo "üîß Checking for missing dependencies..."
              go mod tidy
              go get ./...
            fi
            
            # Retry build after auto-fixes
            echo "üîÑ Retrying build after auto-fixes..."
            go build -ldflags="-X github.com/nexora/nexora/internal/version.Version=$VERSION" -o nexora .
          fi
          
          ./nexora version || echo "Version command not available"
      
      - name: Upload coverage to Codecov
        if: matrix.go-version == '1.25.5'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Auto-fix and create PR if needed
        if: failure()
        run: |
          echo "üîç Checking if auto-fixes can be committed as PR..."
          
          # Check if any changes were made during auto-fixes
          if [[ -n $(git status --porcelain) ]]; then
            echo "‚úÖ Auto-fixes applied, creating PR..."
            
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # Create branch
            BRANCH_NAME="autofix/build-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit fixes
            git add .
            git commit -m "autofix: resolve build/test failures
            
            - Updated dependencies
            - Fixed module issues
            - Cleaned go.mod/go.sum"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR if GitHub CLI is available
            if command -v gh &> /dev/null; then
              PR_URL=$(gh pr create --title "ü§ñ Auto-fix: Resolve build failures" --body "This PR was auto-generated to fix build/test failures detected in the CI pipeline.

**Auto-fixes applied:**
- Dependency updates
- Module cleanup
- Import resolution

Please review and merge if the fixes look correct." --label "autofix,build" --assignee ${{ github.actor }} || echo "PR creation failed")
              echo "üîó Auto-fix PR created: $PR_URL"
            fi
          else
            echo "‚ÑπÔ∏è No auto-fixes were needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}